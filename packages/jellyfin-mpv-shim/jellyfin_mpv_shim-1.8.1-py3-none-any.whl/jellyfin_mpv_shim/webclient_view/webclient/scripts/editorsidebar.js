"use strict";define(["datetime","jQuery","globalize","material-icons"],(function(datetime,$,globalize){function getNode(item,folderState,selected){var htmlName=getNodeInnerHtml(item),node={id:item.Id,text:htmlName,state:{opened:item.IsFolder&&"open"==folderState,selected:selected},li_attr:{serveritemtype:item.Type,collectiontype:item.CollectionType}};return item.IsFolder?(node.children=[{text:"Loading...",icon:!1}],node.icon=!1):node.icon=!1,node.state.opened&&(node.li_attr.loadedFromServer=!0),selected&&(selectedNodeId=item.Id),node}function getNodeInnerHtml(item){var name=item.Name;item.Number&&(name=item.Number+" - "+name),null!=item.IndexNumber&&"Season"!=item.Type&&(name=item.IndexNumber+" - "+name);var htmlName="<div class='editorNode'>";return item.IsFolder?htmlName+='<span class="material-icons metadataSidebarIcon folder"></span>':"Video"===item.MediaType?htmlName+='<span class="material-icons metadataSidebarIcon movie"></span>':"Audio"===item.MediaType?htmlName+='<span class="material-icons metadataSidebarIcon audiotrack"></span>':"TvChannel"===item.Type?htmlName+='<span class="material-icons metadataSidebarIcon live_tv"></span>':"Photo"===item.MediaType?htmlName+='<span class="material-icons metadataSidebarIcon photo"></span>':"Book"===item.MediaType&&(htmlName+='<span class="material-icons metadataSidebarIcon book"></span>'),item.LockData&&(htmlName+='<span class="material-icons metadataSidebarIcon lock"></span>'),htmlName+=name,htmlName+="</div>"}function loadNode(page,scope,node,openItems,selectedId,currentUser,callback){var id=node.id;if("#"!=id)if("livetv"!=id)if("MediaFolders"!=id){var query={ParentId:id,Fields:"Settings",IsVirtualUnaired:!1,IsMissing:!1,EnableTotalRecordCount:!1,EnableImages:!1,EnableUserData:!1},itemtype=node.li_attr.itemtype;"Season"!=itemtype&&"Series"!=itemtype&&(query.SortBy="SortName"),ApiClient.getItems(Dashboard.getCurrentUserId(),query).then((function(result){var nodes=result.Items.map((function(n){return getNode(n,-1==openItems.indexOf(n.Id)?"closed":"open",n.Id==selectedId)}));callback.call(scope,nodes);for(var i=0,length=nodes.length;i<length;i++)nodes[i].state.opened&&nodesToLoad.push(nodes[i].id)}))}else(function loadMediaFolders(page,scope,openItems,callback){ApiClient.getJSON(ApiClient.getUrl("Library/MediaFolders")).then((function(result){var nodes=result.Items.map((function(n){return getNode(n,-1==openItems.indexOf(n.Id)?"closed":"open",!1)}));callback.call(scope,nodes);for(var i=0,length=nodes.length;i<length;i++)nodes[i].state.opened&&nodesToLoad.push(nodes[i].id)}))})(0,scope,openItems,callback);else(function loadLiveTvChannels(service,openItems,callback){ApiClient.getLiveTvChannels({ServiceName:service,AddCurrentProgram:!1}).then((function(result){var nodes=result.Items.map((function(i){return getNode(i,-1==openItems.indexOf(i.Id)?"closed":"open",!1)}));callback(nodes)}))})(id,openItems,callback);else(function loadChildrenOfRootNode(page,scope,callback){ApiClient.getLiveTvChannels({limit:0}).then((function(result){var nodes=[];nodes.push({id:"MediaFolders",text:globalize.translate("HeaderMediaFolders"),state:{opened:!0},li_attr:{itemtype:"mediafolders",loadedFromServer:!0},icon:!1}),result.TotalRecordCount&&nodes.push({id:"livetv",text:globalize.translate("HeaderLiveTV"),state:{opened:!1},li_attr:{itemtype:"livetv"},children:[{text:"Loading...",icon:!1}],icon:!1}),callback.call(scope,nodes),nodesToLoad.push("MediaFolders")}))})(0,scope,callback)}function initializeTree(page,currentUser,openItems,selectedId){require(["jstree"],(function(){!function initializeTreeInternal(page,currentUser,openItems,selectedId){nodesToLoad=[],selectedNodeId=null,$.jstree.destroy(),$(".libraryTree",page).jstree({plugins:["wholerow"],core:{check_callback:!0,data:function data(node,callback){loadNode(0,this,node,openItems,selectedId,0,callback)},themes:{variant:"large"}}}).off("select_node.jstree",onNodeSelect).on("select_node.jstree",onNodeSelect).off("open_node.jstree",onNodeOpen).on("open_node.jstree",onNodeOpen).off("load_node.jstree",onNodeLoad).on("load_node.jstree",onNodeLoad)}(page,0,openItems,selectedId)}))}function onNodeSelect(event,data){var node=data.node,eventData={id:node.id,itemType:node.li_attr.itemtype,serverItemType:node.li_attr.serveritemtype,collectionType:node.li_attr.collectiontype};"livetv"!=eventData.itemType&&"mediafolders"!=eventData.itemType?(this.dispatchEvent(new CustomEvent("itemclicked",{detail:eventData,bubbles:!0,cancelable:!1})),document.querySelector(".editPageSidebar").classList.add("editPageSidebar-withcontent")):document.querySelector(".editPageSidebar").classList.remove("editPageSidebar-withcontent")}function onNodeOpen(event,data){var page=$(this).parents(".page")[0],node=data.node;node.children&&loadNodesToLoad(page,node),node.li_attr&&"#"!=node.id&&!node.li_attr.loadedFromServer&&(node.li_attr.loadedFromServer=!0,$.jstree.reference(".libraryTree",page).load_node(node.id,loadNodeCallback))}function onNodeLoad(event,data){var page=$(this).parents(".page")[0],node=data.node;node.children&&loadNodesToLoad(page,node),node.li_attr&&"#"!=node.id&&!node.li_attr.loadedFromServer&&(node.li_attr.loadedFromServer=!0,$.jstree.reference(".libraryTree",page).load_node(node.id,loadNodeCallback))}function loadNodesToLoad(page,node){for(var children=node.children,i=0,length=children.length;i<length;i++){var child=children[i];-1!=nodesToLoad.indexOf(child)&&(nodesToLoad=nodesToLoad.filter((function(n){return n!=child})),$.jstree.reference(".libraryTree",page).load_node(child,loadNodeCallback))}}function loadNodeCallback(node){selectedNodeId&&node.children&&-1!=node.children.indexOf(selectedNodeId)&&setTimeout((function(){!function scrollToNode(id){var elem=$("#"+id)[0];elem&&elem.scrollIntoView()}(selectedNodeId)}),500)}function getCurrentItemId(){if(itemId)return itemId;var url=window.location.hash||window.location.href;return getParameterByName("id",url)}var selectedNodeId,itemId,nodesToLoad=[];$(document).on("itemsaved",".metadataEditorPage",(function(e,item){!function updateEditorNode(page,item){var elem=$("#"+item.Id+">a",page)[0];if(null!=elem&&($(".editorNode",elem).remove(),$(elem).append(getNodeInnerHtml(item)),item.IsFolder)){var tree=jQuery.jstree._reference(".libraryTree"),currentNode=tree._get_node(null,!1);tree.refresh(currentNode)}}(this,item)})).on("pagebeforeshow",".metadataEditorPage",(function(){require(["css!assets/css/metadataeditor.css"])})).on("pagebeforeshow",".metadataEditorPage",(function(){var page=this;Dashboard.getCurrentUser().then((function(user){var id=getCurrentItemId();id?ApiClient.getAncestorItems(id,user.Id).then((function(ancestors){var ids=ancestors.map((function(i){return i.Id}));initializeTree(page,0,ids,id)})):initializeTree(page,0,[])}))})).on("pagebeforehide",".metadataEditorPage",(function(){$(".libraryTree",this).off("select_node.jstree",onNodeSelect).off("open_node.jstree",onNodeOpen).off("load_node.jstree",onNodeLoad)})),window.MetadataEditor={getItemPromise:function getItemPromise(){var currentItemId=getCurrentItemId();return currentItemId?ApiClient.getItem(Dashboard.getCurrentUserId(),currentItemId):ApiClient.getRootFolder(Dashboard.getCurrentUserId())},getCurrentItemId:getCurrentItemId,setCurrentItemId:function setCurrentItemId(id){itemId=id}}}));
//# sourceMappingURL=editorsidebar.js.map
