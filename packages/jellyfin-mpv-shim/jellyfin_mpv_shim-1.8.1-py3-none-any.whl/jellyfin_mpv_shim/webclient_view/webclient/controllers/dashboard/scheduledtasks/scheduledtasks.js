"use strict";define(["jQuery","loading","events","globalize","serverNotifications","date-fns","dfnshelper","listViewStyle","emby-button"],(function($,loading,events,globalize,serverNotifications,datefns,dfnshelper){function reloadList(page){ApiClient.getScheduledTasks({isHidden:!1}).then((function(tasks){!function populateList(page,tasks){var currentCategory;tasks=tasks.sort((function(a,b){return(a=a.Category+" "+a.Name)==(b=b.Category+" "+b.Name)?0:a<b?-1:1}));for(var html="",i=0;i<tasks.length;i++){var task=tasks[i];task.Category!=currentCategory&&((currentCategory=task.Category)&&(html+="</div>",html+="</div>"),html+='<div class="verticalSection verticalSection-extrabottompadding">',html+='<div class="sectionTitleContainer" style="margin-bottom:1em;">',html+='<h2 class="sectionTitle">',html+=currentCategory,html+="</h2>",0===i&&(html+='<a is="emby-linkbutton" class="raised button-alt headerHelpButton" target="_blank" href="https://docs.jellyfin.org/general/server/tasks.html">'+globalize.translate("Help")+"</a>"),html+="</div>",html+='<div class="paperList">'),html+='<div class="listItem listItem-border scheduledTaskPaperIconItem" data-status="'+task.State+'">',html+="<a is='emby-linkbutton' style='margin:0;padding:0;' class='clearLink listItemIconContainer' href='scheduledtask.html?id="+task.Id+"'>",html+='<span class="material-icons listItemIcon schedule"></span>',html+="</a>",html+='<div class="listItemBody two-line">',html+="<a class='clearLink' style='margin:0;padding:0;display:block;text-align:left;' is='emby-linkbutton' href='scheduledtask.html?id="+task.Id+"'>",html+="<h3 class='listItemBodyText'>"+task.Name+"</h3>",html+="<div class='secondary listItemBodyText' id='taskProgress"+task.Id+"'>"+getTaskProgressHtml(task)+"</div>",html+="</a>",html+="</div>","Running"===task.State?html+='<button type="button" is="paper-icon-button-light" id="btnTask'+task.Id+'" class="btnStopTask" data-taskid="'+task.Id+'" title="'+globalize.translate("ButtonStop")+'"><span class="material-icons stop"></span></button>':"Idle"===task.State&&(html+='<button type="button" is="paper-icon-button-light" id="btnTask'+task.Id+'" class="btnStartTask" data-taskid="'+task.Id+'" title="'+globalize.translate("ButtonStart")+'"><span class="material-icons play_arrow"></span></button>'),html+="</div>"}tasks.length&&(html+="</div>",html+="</div>");page.querySelector(".divScheduledTasks").innerHTML=html}(page,tasks),loading.hide()}))}function getTaskProgressHtml(task){var html="";if("Idle"===task.State){if(task.LastExecutionResult){var endtime=Date.parse(task.LastExecutionResult.EndTimeUtc),starttime=Date.parse(task.LastExecutionResult.StartTimeUtc);html+=globalize.translate("LabelScheduledTaskLastRan",datefns.formatDistanceToNow(endtime,dfnshelper.localeWithSuffix),datefns.formatDistance(starttime,endtime,{locale:dfnshelper.getLocale()})),"Failed"===task.LastExecutionResult.Status?html+=" <span style='color:#FF0000;'>("+globalize.translate("LabelFailed")+")</span>":"Cancelled"===task.LastExecutionResult.Status?html+=" <span style='color:#0026FF;'>("+globalize.translate("LabelCancelled")+")</span>":"Aborted"===task.LastExecutionResult.Status&&(html+=" <span style='color:#FF0000;'>"+globalize.translate("LabelAbortedByServerShutdown")+"</span>")}}else if("Running"===task.State){var progress=(task.CurrentProgressPercentage||0).toFixed(1);html+='<div style="display:flex;align-items:center;">',html+='<div class="taskProgressOuter" title="'+progress+'%" style="flex-grow:1;">',html+='<div class="taskProgressInner" style="width:'+progress+'%;">',html+="</div>",html+="</div>",html+="<span style='color:#00a4dc;margin-left:5px;'>"+progress+"%</span>",html+="</div>"}else html+="<span style='color:#FF0000;'>"+globalize.translate("LabelStopping")+"</span>";return html}function setTaskButtonIcon(button,icon){var inner=button.querySelector(".material-icons");inner.classList.remove("stop","play_arrow"),inner.classList.add(icon)}function updateTaskButton(elem,state){"Running"===state?(elem.classList.remove("btnStartTask"),elem.classList.add("btnStopTask"),setTaskButtonIcon(elem,"stop"),elem.title=globalize.translate("ButtonStop")):"Idle"===state&&(elem.classList.add("btnStartTask"),elem.classList.remove("btnStopTask"),setTaskButtonIcon(elem,"play_arrow"),elem.title=globalize.translate("ButtonStart")),$(elem).parents(".listItem")[0].setAttribute("data-status",state)}return function(view,params){function onPollIntervalFired(){ApiClient.isMessageChannelOpen()||reloadList(view)}function onScheduledTasksUpdate(e,apiClient,info){apiClient.serverId()===serverId&&function updateTasks(tasks){for(var i=0;i<tasks.length;i++){var task=tasks[i];view.querySelector("#taskProgress"+task.Id).innerHTML=getTaskProgressHtml(task),updateTaskButton(view.querySelector("#btnTask"+task.Id),task.State)}}(info)}var pollInterval,serverId=ApiClient.serverId();$(".divScheduledTasks",view).on("click",".btnStartTask",(function(){var button=this,id=button.getAttribute("data-taskid");ApiClient.startScheduledTask(id).then((function(){updateTaskButton(button,"Running"),reloadList(view)}))})),$(".divScheduledTasks",view).on("click",".btnStopTask",(function(){var button=this,id=button.getAttribute("data-taskid");ApiClient.stopScheduledTask(id).then((function(){updateTaskButton(button,""),reloadList(view)}))})),view.addEventListener("viewbeforehide",(function(){events.off(serverNotifications,"ScheduledTasksInfo",onScheduledTasksUpdate),function stopInterval(){ApiClient.sendMessage("ScheduledTasksInfoStop"),pollInterval&&clearInterval(pollInterval)}()})),view.addEventListener("viewshow",(function(){loading.show(),function startInterval(){ApiClient.sendMessage("ScheduledTasksInfoStart","1000,1000"),pollInterval&&clearInterval(pollInterval),pollInterval=setInterval(onPollIntervalFired,1e4)}(),reloadList(view),events.on(serverNotifications,"ScheduledTasksInfo",onScheduledTasksUpdate)}))}}));
//# sourceMappingURL=scheduledtasks.js.map
