{"version":3,"sources":["controllers/dashboard/users/userprofilespage.js"],"names":["define","loading","dom","globalize","datefns","dfnshelper","showUserMenu","elem","card","parentWithClass","page","userId","getAttribute","menuItems","push","name","translate","id","icon","require","actionsheet","show","items","positionTo","callback","Dashboard","navigate","deleteUser","msg","confirm","title","text","confirmText","primary","then","ApiClient","loadData","getUserHtml","user","addConnectIndicator","imgUrl","html","cssClass","Policy","IsDisabled","Id","PrimaryImageTag","getUserImageUrl","width","tag","type","imageClass","Name","lastSeen","getLastSeenText","lastActivityDate","formatDistanceToNow","Date","parse","localeWithSuffix","LastActivityDate","renderUsers","users","querySelector","innerHTML","getUserSectionHtml","map","u__q","join","showPendingUserMenu","menuItemId","cancelAuthorization","ajax","url","getUrl","getPendingUserHtml","ImageUrl","UserName","getUsers","hide","renderPendingGuests","length","classList","remove","add","pageIdOn","this","addEventListener","e__e","btnUserMenu","target","e__r"],"mappings":"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","file":"userprofilespage.js","sourcesContent":["define(['loading', 'dom', 'globalize', 'date-fns', 'dfnshelper', 'paper-icon-button-light', 'cardStyle', 'emby-button', 'indicators', 'flexStyles'], function (loading, dom, globalize, datefns, dfnshelper) {\n    'use strict';\n\n    function deleteUser(page, id) {\n        var msg = globalize.translate('DeleteUserConfirmation');\n\n        require(['confirm'], function (confirm) {\n            confirm({\n                title: globalize.translate('DeleteUser'),\n                text: msg,\n                confirmText: globalize.translate('ButtonDelete'),\n                primary: 'delete'\n            }).then(function () {\n                loading.show();\n                ApiClient.deleteUser(id).then(function () {\n                    loadData(page);\n                });\n            });\n        });\n    }\n\n    function showUserMenu(elem) {\n        var card = dom.parentWithClass(elem, 'card');\n        var page = dom.parentWithClass(card, 'page');\n        var userId = card.getAttribute('data-userid');\n        var menuItems = [];\n        menuItems.push({\n            name: globalize.translate('ButtonOpen'),\n            id: 'open',\n            icon: 'mode_edit'\n        });\n        menuItems.push({\n            name: globalize.translate('ButtonLibraryAccess'),\n            id: 'access',\n            icon: 'lock'\n        });\n        menuItems.push({\n            name: globalize.translate('ButtonParentalControl'),\n            id: 'parentalcontrol',\n            icon: 'person'\n        });\n        menuItems.push({\n            name: globalize.translate('ButtonDelete'),\n            id: 'delete',\n            icon: 'delete'\n        });\n\n        require(['actionsheet'], function (actionsheet) {\n            actionsheet.show({\n                items: menuItems,\n                positionTo: card,\n                callback: function (id) {\n                    switch (id) {\n                        case 'open':\n                            Dashboard.navigate('useredit.html?userId=' + userId);\n                            break;\n\n                        case 'access':\n                            Dashboard.navigate('userlibraryaccess.html?userId=' + userId);\n                            break;\n\n                        case 'parentalcontrol':\n                            Dashboard.navigate('userparentalcontrol.html?userId=' + userId);\n                            break;\n\n                        case 'delete':\n                            deleteUser(page, userId);\n                    }\n                }\n            });\n        });\n    }\n\n    function getUserHtml(user, addConnectIndicator) {\n        var html = '';\n        var cssClass = 'card squareCard scalableCard squareCard-scalable';\n\n        if (user.Policy.IsDisabled) {\n            cssClass += ' grayscale';\n        }\n\n        html += \"<div data-userid='\" + user.Id + \"' class='\" + cssClass + \"'>\";\n        html += '<div class=\"cardBox visualCardBox\">';\n        html += '<div class=\"cardScalable visualCardBox-cardScalable\">';\n        html += '<div class=\"cardPadder cardPadder-square\"></div>';\n        html += '<a is=\"emby-linkbutton\" class=\"cardContent\" href=\"useredit.html?userId=' + user.Id + '\">';\n        var imgUrl;\n\n        if (user.PrimaryImageTag) {\n            imgUrl = ApiClient.getUserImageUrl(user.Id, {\n                width: 300,\n                tag: user.PrimaryImageTag,\n                type: 'Primary'\n            });\n        }\n\n        var imageClass = 'cardImage';\n\n        if (user.Policy.IsDisabled) {\n            imageClass += ' disabledUser';\n        }\n\n        if (imgUrl) {\n            html += '<div class=\"' + imageClass + '\" style=\"background-image:url(\\'' + imgUrl + \"');\\\">\";\n        } else {\n            html += '<div class=\"' + imageClass + ' flex align-items-center justify-content-center\">';\n            html += '<span class=\"material-icons cardImageIcon person\"></span>';\n        }\n\n        html += '</div>';\n        html += '</a>';\n        html += '</div>';\n        html += '<div class=\"cardFooter visualCardBox-cardFooter\">';\n        html += '<div class=\"cardText flex align-items-center\">';\n        html += '<div class=\"flex-grow\" style=\"overflow:hidden;text-overflow:ellipsis;\">';\n        html += user.Name;\n        html += '</div>';\n        html += '<button type=\"button\" is=\"paper-icon-button-light\" class=\"btnUserMenu flex-shrink-zero\"><span class=\"material-icons more_vert\"></span></button>';\n        html += '</div>';\n        html += '<div class=\"cardText cardText-secondary\">';\n        var lastSeen = getLastSeenText(user.LastActivityDate);\n        html += '' != lastSeen ? lastSeen : '&nbsp;';\n        html += '</div>';\n        html += '</div>';\n        html += '</div>';\n        return html + '</div>';\n    }\n    // FIXME: It seems that, sometimes, server sends date in the future, so date-fns displays messages like 'in less than a minute'. We should fix\n    // how dates are returned by the server when the session is active and show something like 'Active now', instead of past/future sentences\n    function getLastSeenText(lastActivityDate) {\n        if (lastActivityDate) {\n            return globalize.translate('LastSeen', datefns.formatDistanceToNow(Date.parse(lastActivityDate), dfnshelper.localeWithSuffix));\n        }\n\n        return '';\n    }\n\n    function getUserSectionHtml(users, addConnectIndicator) {\n        return users.map(function (u__q) {\n            return getUserHtml(u__q, addConnectIndicator);\n        }).join('');\n    }\n\n    function renderUsers(page, users) {\n        page.querySelector('.localUsers').innerHTML = getUserSectionHtml(users, true);\n    }\n\n    function showPendingUserMenu(elem) {\n        var menuItems = [];\n        menuItems.push({\n            name: globalize.translate('ButtonCancel'),\n            id: 'delete',\n            icon: 'delete'\n        });\n\n        require(['actionsheet'], function (actionsheet) {\n            var card = dom.parentWithClass(elem, 'card');\n            var page = dom.parentWithClass(card, 'page');\n            var id = card.getAttribute('data-id');\n            actionsheet.show({\n                items: menuItems,\n                positionTo: card,\n                callback: function (menuItemId) {\n                    switch (menuItemId) {\n                        case 'delete':\n                            cancelAuthorization(page, id);\n                    }\n                }\n            });\n        });\n    }\n\n    function getPendingUserHtml(user) {\n        var html = '';\n        html += \"<div data-id='\" + user.Id + \"' class='card squareCard scalableCard squareCard-scalable'>\";\n        html += '<div class=\"cardBox cardBox-bottompadded visualCardBox\">';\n        html += '<div class=\"cardScalable visualCardBox-cardScalable\">';\n        html += '<div class=\"cardPadder cardPadder-square\"></div>';\n        html += '<a class=\"cardContent cardImageContainer\" is=\"emby-linkbutton\" href=\"#\">';\n\n        if (user.ImageUrl) {\n            html += '<div class=\"cardImage\" style=\"background-image:url(\\'' + user.ImageUrl + \"');\\\">\";\n            html += '</div>';\n        } else {\n            html += '<span class=\"cardImageIcon material-icons person\"></span>';\n        }\n\n        html += '</a>';\n        html += '</div>';\n        html += '<div class=\"cardFooter visualCardBox-cardFooter\">';\n        html += '<div class=\"cardText\" style=\"text-align:right; float:right;padding:0;\">';\n        html += '<button type=\"button\" is=\"paper-icon-button-light\" class=\"btnUserMenu\"><span class=\"material-icons more_vert\"></span></button>';\n        html += '</div>';\n        html += '<div class=\"cardText\" style=\"padding-top:10px;padding-bottom:10px;\">';\n        html += user.UserName;\n        html += '</div>';\n        html += '</div>';\n        html += '</div>';\n        return html + '</div>';\n    }\n\n    function renderPendingGuests(page, users) {\n        if (users.length) {\n            page.querySelector('.sectionPendingGuests').classList.remove('hide');\n        } else {\n            page.querySelector('.sectionPendingGuests').classList.add('hide');\n        }\n\n        page.querySelector('.pending').innerHTML = users.map(getPendingUserHtml).join('');\n    }\n\n    // TODO cvium: maybe reuse for invitation system\n    function cancelAuthorization(page, id) {\n        loading.show();\n        ApiClient.ajax({\n            type: 'DELETE',\n            url: ApiClient.getUrl('Connect/Pending', {\n                Id: id\n            })\n        }).then(function () {\n            loadData(page);\n        });\n    }\n\n    function loadData(page) {\n        loading.show();\n        ApiClient.getUsers().then(function (users) {\n            renderUsers(page, users);\n            loading.hide();\n        });\n        // TODO cvium\n        renderPendingGuests(page, []);\n        // ApiClient.getJSON(ApiClient.getUrl(\"Connect/Pending\")).then(function (pending) {\n        //\n        // });\n    }\n\n    function showInvitePopup(page) {\n        require(['components/guestinviter/guestinviter'], function (guestinviter) {\n            guestinviter.show().then(function () {\n                loadData(page);\n            });\n        });\n    }\n\n    pageIdOn('pageinit', 'userProfilesPage', function () {\n        var page = this;\n        page.querySelector('.btnAddUser').addEventListener('click', function() {\n            Dashboard.navigate('usernew.html');\n        });\n        page.querySelector('.localUsers').addEventListener('click', function (e__e) {\n            var btnUserMenu = dom.parentWithClass(e__e.target, 'btnUserMenu');\n\n            if (btnUserMenu) {\n                showUserMenu(btnUserMenu);\n            }\n        });\n        page.querySelector('.pending').addEventListener('click', function (e__r) {\n            var btnUserMenu = dom.parentWithClass(e__r.target, 'btnUserMenu');\n\n            if (btnUserMenu) {\n                showPendingUserMenu(btnUserMenu);\n            }\n        });\n    });\n    pageIdOn('pagebeforeshow', 'userProfilesPage', function () {\n        loadData(this);\n    });\n});\n"]}