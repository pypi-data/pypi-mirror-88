{"version":3,"sources":["components/packageManager.js"],"names":["define","appSettings","pluginManager","settingsKey","removeUrl","url","manifestUrls","JSON","parse","get","filter","i","set","stringify","loadPackage","packageManager","throwError","Promise","resolve","reject","xhr","XMLHttpRequest","originalUrl","indexOf","Date","getTime","open","onError","onload","e","this","status","pkg","response","addPackage","packagesList","p","name","push","plugins","plugin","promises","map","pluginUrl","loadPlugin","mapPath","all","then","onerror","send","PackageManager","prototype","init","instance","u","packages","slice","install","uninstall","urlLower","toLowerCase","packageUrl","substring","lastIndexOf"],"mappings":"AAAA,aAAAA,OAAO,CAAC,cAAe,kBAAkB,SAAUC,YAAaC,eAG5D,IAAIC,YAAc,qBAYlB,SAASC,UAAUC,KAEf,IAAIC,aAAeC,KAAKC,MAAMP,YAAYQ,IAAIN,cAAgB,MAE9DG,aAAeA,aAAaI,QAAO,SAAUC,GACzC,OAAOA,IAAMN,OAGjBJ,YAAYW,IAAIT,YAAaI,KAAKM,UAAUP,eAGhD,SAASQ,YAAYC,eAAgBV,IAAKW,YAEtC,OAAO,IAAIC,SAAQ,SAAUC,QAASC,QAElC,IAAIC,IAAM,IAAIC,eACVC,YAAcjB,IAClBA,MAA6B,IAAtBA,IAAIkB,QAAQ,KAAc,IAAM,IACvClB,KAAO,MAAO,IAAImB,MAAOC,UAEzBL,IAAIM,KAAK,MAAOrB,KAAK,GAErB,IAAIsB,QAAU,SAAVA,WAEmB,IAAfX,WACAG,UAEAf,UAAUkB,aACVJ,YAIRE,IAAIQ,OAAS,SAAUC,GACnB,GAAIC,KAAKC,OAAS,IAAK,CAEnB,IAAIC,IAAMzB,KAAKC,MAAMsB,KAAKG,UAC1BD,IAAI3B,IAAMiB,YA9C1B,SAASY,WAAWnB,eAAgBiB,KAEhCjB,eAAeoB,aAAepB,eAAeoB,aAAazB,QAAO,SAAU0B,GAEvE,OAAOA,EAAEC,OAASL,IAAIK,QAG1BtB,eAAeoB,aAAaG,KAAKN,KAyCrBE,CAAWnB,eAAgBiB,KAE3B,IAAIO,QAAUP,IAAIO,SAAW,GACzBP,IAAIQ,QACJD,QAAQD,KAAKN,IAAIQ,QAErB,IAAIC,SAAWF,QAAQG,KAAI,SAAUC,WACjC,OAAOzC,cAAc0C,WAAW7B,eAAe8B,QAAQb,IAAKW,eAEhE1B,QAAQ6B,IAAIL,UAAUM,KAAK7B,QAASA,cAGpCS,WAIRP,IAAI4B,QAAUrB,QAEdP,IAAI6B,UAIZ,SAASC,iBAELpB,KAAKK,aAAe,GAyExB,OAtEAe,eAAeC,UAAUC,KAAO,WAC5B,IAAI9C,aAAeC,KAAKC,MAAMP,YAAYQ,IAAIN,cAAgB,MAE1DkD,SAAWvB,KACf,OAAOb,QAAQ6B,IAAIxC,aAAaoC,KAAI,SAAUY,GAE1C,OAAOxC,YAAYuC,SAAUC,OAE7BP,MAAK,WACL,OAAO9B,QAAQC,aAChB,WACC,OAAOD,QAAQC,cAIvBgC,eAAeC,UAAUI,SAAW,WAChC,OAAOzB,KAAKK,aAAaqB,MAAM,IAGnCN,eAAeC,UAAUM,QAAU,SAAUpD,KAEzC,OAAOS,YAAYgB,KAAMzB,KAAK,GAAM0C,MAAK,SAAUf,KAE/C,IAAI1B,aAAeC,KAAKC,MAAMP,YAAYQ,IAAIN,cAAgB,MAO9D,OALmC,IAA/BG,aAAaiB,QAAQlB,OACrBC,aAAagC,KAAKjC,KAClBJ,YAAYW,IAAIT,YAAaI,KAAKM,UAAUP,gBAGzC0B,QAIfkB,eAAeC,UAAUO,UAAY,SAAUrB,MAE3C,IAAIL,IAAMF,KAAKK,aAAazB,QAAO,SAAU0B,GAEzC,OAAOA,EAAEC,OAASA,QACnB,GAYH,OAVIL,MAEAF,KAAKK,aAAeL,KAAKK,aAAazB,QAAO,SAAU0B,GAEnD,OAAOA,EAAEC,OAASA,QAGtBjC,UAAU4B,IAAI3B,MAGXY,QAAQC,WAGnBgC,eAAeC,UAAUN,QAAU,SAAUb,IAAKW,WAE9C,IAAIgB,SAAWhB,UAAUiB,cACzB,GAAkC,IAA9BD,SAASpC,QAAQ,UAAiD,IAA/BoC,SAASpC,QAAQ,WAAiD,IAA9BoC,SAASpC,QAAQ,SACxF,OAAOoB,UAGX,IAAIkB,WAAa7B,IAAI3B,IAMrB,OALAwD,WAAaA,WAAWC,UAAU,EAAGD,WAAWE,YAAY,MAE5DF,YAAc,IACdA,YAAclB,WAKX,IAAIO","file":"packageManager.js","sourcesContent":["define(['appSettings', 'pluginManager'], function (appSettings, pluginManager) {\n    'use strict';\n\n    var settingsKey = 'installedpackages1';\n\n    function addPackage(packageManager, pkg) {\n\n        packageManager.packagesList = packageManager.packagesList.filter(function (p) {\n\n            return p.name !== pkg.name;\n        });\n\n        packageManager.packagesList.push(pkg);\n    }\n\n    function removeUrl(url) {\n\n        var manifestUrls = JSON.parse(appSettings.get(settingsKey) || '[]');\n\n        manifestUrls = manifestUrls.filter(function (i) {\n            return i !== url;\n        });\n\n        appSettings.set(settingsKey, JSON.stringify(manifestUrls));\n    }\n\n    function loadPackage(packageManager, url, throwError) {\n\n        return new Promise(function (resolve, reject) {\n\n            var xhr = new XMLHttpRequest();\n            var originalUrl = url;\n            url += url.indexOf('?') === -1 ? '?' : '&';\n            url += 't=' + new Date().getTime();\n\n            xhr.open('GET', url, true);\n\n            var onError = function () {\n\n                if (throwError === true) {\n                    reject();\n                } else {\n                    removeUrl(originalUrl);\n                    resolve();\n                }\n            };\n\n            xhr.onload = function (e) {\n                if (this.status < 400) {\n\n                    var pkg = JSON.parse(this.response);\n                    pkg.url = originalUrl;\n\n                    addPackage(packageManager, pkg);\n\n                    var plugins = pkg.plugins || [];\n                    if (pkg.plugin) {\n                        plugins.push(pkg.plugin);\n                    }\n                    var promises = plugins.map(function (pluginUrl) {\n                        return pluginManager.loadPlugin(packageManager.mapPath(pkg, pluginUrl));\n                    });\n                    Promise.all(promises).then(resolve, resolve);\n\n                } else {\n                    onError();\n                }\n            };\n\n            xhr.onerror = onError;\n\n            xhr.send();\n        });\n    }\n\n    function PackageManager() {\n\n        this.packagesList = [];\n    }\n\n    PackageManager.prototype.init = function () {\n        var manifestUrls = JSON.parse(appSettings.get(settingsKey) || '[]');\n\n        var instance = this;\n        return Promise.all(manifestUrls.map(function (u) {\n\n            return loadPackage(instance, u);\n\n        })).then(function () {\n            return Promise.resolve();\n        }, function () {\n            return Promise.resolve();\n        });\n    };\n\n    PackageManager.prototype.packages = function () {\n        return this.packagesList.slice(0);\n    };\n\n    PackageManager.prototype.install = function (url) {\n\n        return loadPackage(this, url, true).then(function (pkg) {\n\n            var manifestUrls = JSON.parse(appSettings.get(settingsKey) || '[]');\n\n            if (manifestUrls.indexOf(url) === -1) {\n                manifestUrls.push(url);\n                appSettings.set(settingsKey, JSON.stringify(manifestUrls));\n            }\n\n            return pkg;\n        });\n    };\n\n    PackageManager.prototype.uninstall = function (name) {\n\n        var pkg = this.packagesList.filter(function (p) {\n\n            return p.name === name;\n        })[0];\n\n        if (pkg) {\n\n            this.packagesList = this.packagesList.filter(function (p) {\n\n                return p.name !== name;\n            });\n\n            removeUrl(pkg.url);\n        }\n\n        return Promise.resolve();\n    };\n\n    PackageManager.prototype.mapPath = function (pkg, pluginUrl) {\n\n        var urlLower = pluginUrl.toLowerCase();\n        if (urlLower.indexOf('http:') === 0 || urlLower.indexOf('https:') === 0 || urlLower.indexOf('file:') === 0) {\n            return pluginUrl;\n        }\n\n        var packageUrl = pkg.url;\n        packageUrl = packageUrl.substring(0, packageUrl.lastIndexOf('/'));\n\n        packageUrl += '/';\n        packageUrl += pluginUrl;\n\n        return packageUrl;\n    };\n\n    return new PackageManager();\n});\n"]}