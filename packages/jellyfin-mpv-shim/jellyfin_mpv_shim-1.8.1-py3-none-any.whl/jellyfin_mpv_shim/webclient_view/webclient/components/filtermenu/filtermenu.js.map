{"version":3,"sources":["components/filtermenu/filtermenu.js"],"names":["define","require","dom","focusManager","dialogHelper","loading","appHost","inputManager","layoutManager","connectionManager","appRouter","globalize","userSettings","onSubmit","e","preventDefault","setBasicFilter","context","key","elem","value","checked","setFilter","centerFocus","horiz","on","scrollHelper","fn","moveCheckboxFocus","offset","parent","parentWithClass","elems","getFocusableElements","index","i","length","Math","min","newElem","max","focus","onInputCommand","detail","command","target","FilterMenu","bindCheckboxInput","querySelectorAll","off","prototype","show","options","Promise","resolve","reject","template","dialogOptions","removeOnClose","scrollY","tv","size","dlg","createDialog","classList","add","html","innerHTML","translateDocument","submitted","settingElements","visibleSettings","indexOf","getAttribute","remove","initEditor","settings","querySelector","addEventListener","tagName","videoTypes","VideoTypes","split","seriesStatuses","SeriesStatus","loadDynamicFilters","apiClient","getApiClient","serverId","filterMenuOptions","Object","assign","UserId","getCurrentUserId","ParentId","parentId","IncludeItemTypes","itemTypes","join","getFilters","then","result","renderDynamicFilters","renderOptions","selector","cssClass","items","isCheckedFn","map","filter","itemHtml","Id","Name","Genres","delimeter","GenreIds","close","open","saveValues","settingsKey","push","genres"],"mappings":"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","file":"filtermenu.js","sourcesContent":["define(['require', 'dom', 'focusManager', 'dialogHelper', 'loading', 'apphost', 'inputManager', 'layoutManager', 'connectionManager', 'appRouter', 'globalize', 'userSettings', 'emby-checkbox', 'emby-input', 'paper-icon-button-light', 'emby-select', 'material-icons', 'css!./../formdialog', 'emby-button', 'flexStyles'], function (require, dom, focusManager, dialogHelper, loading, appHost, inputManager, layoutManager, connectionManager, appRouter, globalize, userSettings) {\n    'use strict';\n\n    function onSubmit(e) {\n\n        e.preventDefault();\n        return false;\n    }\n\n    function renderOptions(context, selector, cssClass, items, isCheckedFn) {\n\n        var elem = context.querySelector(selector);\n\n        if (items.length) {\n\n            elem.classList.remove('hide');\n\n        } else {\n            elem.classList.add('hide');\n        }\n\n        var html = '';\n\n        html += items.map(function (filter) {\n\n            var itemHtml = '';\n\n            var checkedHtml = isCheckedFn(filter) ? ' checked' : '';\n            itemHtml += '<label>';\n            itemHtml += '<input is=\"emby-checkbox\" type=\"checkbox\"' + checkedHtml + ' data-filter=\"' + filter.Id + '\" class=\"' + cssClass + '\"/>';\n            itemHtml += '<span>' + filter.Name + '</span>';\n            itemHtml += '</label>';\n\n            return itemHtml;\n\n        }).join('');\n\n        elem.querySelector('.filterOptions').innerHTML = html;\n    }\n\n    function renderDynamicFilters(context, result, options) {\n\n        // If there's a huge number of these they will be really show to render\n        //if (result.Tags) {\n        //    result.Tags.length = Math.min(result.Tags.length, 50);\n        //}\n\n        renderOptions(context, '.genreFilters', 'chkGenreFilter', result.Genres, function (i) {\n\n            // Switching from | to ,\n            var delimeter = (options.settings.GenreIds || '').indexOf('|') === -1 ? ',' : '|';\n            return (delimeter + (options.settings.GenreIds || '') + delimeter).indexOf(delimeter + i.Id + delimeter) !== -1;\n        });\n\n        //renderOptions(context, '.officialRatingFilters', 'chkOfficialRatingFilter', result.OfficialRatings, function (i) {\n        //    var delimeter = '|';\n        //    return (delimeter + (query.OfficialRatings || '') + delimeter).indexOf(delimeter + i + delimeter) != -1;\n        //});\n\n        //renderOptions(context, '.tagFilters', 'chkTagFilter', result.Tags, function (i) {\n        //    var delimeter = '|';\n        //    return (delimeter + (query.Tags || '') + delimeter).indexOf(delimeter + i + delimeter) != -1;\n        //});\n\n        //renderOptions(context, '.yearFilters', 'chkYearFilter', result.Years, function (i) {\n\n        //    var delimeter = ',';\n        //    return (delimeter + (query.Years || '') + delimeter).indexOf(delimeter + i + delimeter) != -1;\n        //});\n    }\n\n    function loadDynamicFilters(context, options) {\n\n        var apiClient = connectionManager.getApiClient(options.serverId);\n\n        var filterMenuOptions = Object.assign(options.filterMenuOptions, {\n\n            UserId: apiClient.getCurrentUserId(),\n            ParentId: options.parentId,\n            IncludeItemTypes: options.itemTypes.join(',')\n        });\n\n        apiClient.getFilters(filterMenuOptions).then(function (result) {\n\n            renderDynamicFilters(context, result, options);\n        }, function () {\n\n            // older server\n        });\n    }\n\n    function initEditor(context, settings) {\n\n        context.querySelector('form').addEventListener('submit', onSubmit);\n\n        var elems = context.querySelectorAll('.simpleFilter');\n        var i;\n        var length;\n\n        for (i = 0, length = elems.length; i < length; i++) {\n\n            if (elems[i].tagName === 'INPUT') {\n                elems[i].checked = settings[elems[i].getAttribute('data-settingname')] || false;\n            } else {\n                elems[i].querySelector('input').checked = settings[elems[i].getAttribute('data-settingname')] || false;\n            }\n        }\n\n        var videoTypes = settings.VideoTypes ? settings.VideoTypes.split(',') : [];\n        elems = context.querySelectorAll('.chkVideoTypeFilter');\n\n        for (i = 0, length = elems.length; i < length; i++) {\n\n            elems[i].checked = videoTypes.indexOf(elems[i].getAttribute('data-filter')) !== -1;\n        }\n\n        var seriesStatuses = settings.SeriesStatus ? settings.SeriesStatus.split(',') : [];\n        elems = context.querySelectorAll('.chkSeriesStatus');\n\n        for (i = 0, length = elems.length; i < length; i++) {\n\n            elems[i].checked = seriesStatuses.indexOf(elems[i].getAttribute('data-filter')) !== -1;\n        }\n\n        if (context.querySelector('.basicFilterSection .viewSetting:not(.hide)')) {\n            context.querySelector('.basicFilterSection').classList.remove('hide');\n        } else {\n            context.querySelector('.basicFilterSection').classList.add('hide');\n        }\n\n        if (context.querySelector('.featureSection .viewSetting:not(.hide)')) {\n            context.querySelector('.featureSection').classList.remove('hide');\n        } else {\n            context.querySelector('.featureSection').classList.add('hide');\n        }\n    }\n\n    function saveValues(context, settings, settingsKey) {\n\n        var elems = context.querySelectorAll('.simpleFilter');\n        var i;\n        var length;\n        for (i = 0, length = elems.length; i < length; i++) {\n\n            if (elems[i].tagName === 'INPUT') {\n                setBasicFilter(context, settingsKey + '-filter-' + elems[i].getAttribute('data-settingname'), elems[i]);\n            } else {\n                setBasicFilter(context, settingsKey + '-filter-' + elems[i].getAttribute('data-settingname'), elems[i].querySelector('input'));\n            }\n        }\n\n        // Video type\n        var videoTypes = [];\n        elems = context.querySelectorAll('.chkVideoTypeFilter');\n\n        for (i = 0, length = elems.length; i < length; i++) {\n\n            if (elems[i].checked) {\n                videoTypes.push(elems[i].getAttribute('data-filter'));\n            }\n        }\n        userSettings.setFilter(settingsKey + '-filter-VideoTypes', videoTypes.join(','));\n\n        // Series status\n        var seriesStatuses = [];\n        elems = context.querySelectorAll('.chkSeriesStatus');\n\n        for (i = 0, length = elems.length; i < length; i++) {\n\n            if (elems[i].checked) {\n                seriesStatuses.push(elems[i].getAttribute('data-filter'));\n            }\n        }\n\n        // Genres\n        var genres = [];\n        elems = context.querySelectorAll('.chkGenreFilter');\n\n        for (i = 0, length = elems.length; i < length; i++) {\n\n            if (elems[i].checked) {\n                genres.push(elems[i].getAttribute('data-filter'));\n            }\n        }\n        userSettings.setFilter(settingsKey + '-filter-GenreIds', genres.join(','));\n    }\n\n    function setBasicFilter(context, key, elem) {\n\n        var value = elem.checked;\n        value = value ? value : null;\n        userSettings.setFilter(key, value);\n    }\n\n    function centerFocus(elem, horiz, on) {\n        require(['scrollHelper'], function (scrollHelper) {\n            var fn = on ? 'on' : 'off';\n            scrollHelper.centerFocus[fn](elem, horiz);\n        });\n    }\n\n    function moveCheckboxFocus(elem, offset) {\n\n        var parent = dom.parentWithClass(elem, 'checkboxList-verticalwrap');\n        var elems = focusManager.getFocusableElements(parent);\n\n        var index = -1;\n        for (var i = 0, length = elems.length; i < length; i++) {\n            if (elems[i] === elem) {\n                index = i;\n                break;\n            }\n        }\n\n        index += offset;\n\n        index = Math.min(elems.length - 1, index);\n        index = Math.max(0, index);\n\n        var newElem = elems[index];\n        if (newElem) {\n            focusManager.focus(newElem);\n        }\n    }\n\n    function onInputCommand(e) {\n        switch (e.detail.command) {\n\n            case 'left':\n                moveCheckboxFocus(e.target, -1);\n                e.preventDefault();\n                break;\n            case 'right':\n                moveCheckboxFocus(e.target, 1);\n                e.preventDefault();\n                break;\n            default:\n                break;\n        }\n    }\n\n    function FilterMenu() {\n\n    }\n\n    function bindCheckboxInput(context, on) {\n\n        var elems = context.querySelectorAll('.checkboxList-verticalwrap');\n        for (var i = 0, length = elems.length; i < length; i++) {\n            if (on) {\n                inputManager.on(elems[i], onInputCommand);\n            } else {\n                inputManager.off(elems[i], onInputCommand);\n            }\n        }\n    }\n\n    FilterMenu.prototype.show = function (options) {\n\n        return new Promise(function (resolve, reject) {\n\n            require(['text!./filtermenu.template.html'], function (template) {\n\n                var dialogOptions = {\n                    removeOnClose: true,\n                    scrollY: false\n                };\n\n                if (layoutManager.tv) {\n                    dialogOptions.size = 'fullscreen';\n                } else {\n                    dialogOptions.size = 'small';\n                }\n\n                var dlg = dialogHelper.createDialog(dialogOptions);\n\n                dlg.classList.add('formDialog');\n\n                var html = '';\n\n                html += '<div class=\"formDialogHeader\">';\n                html += '<button is=\"paper-icon-button-light\" class=\"btnCancel hide-mouse-idle-tv\" tabindex=\"-1\"><span class=\"material-icons arrow_back\"></span></button>';\n                html += '<h3 class=\"formDialogHeaderTitle\">${Filters}</h3>';\n\n                html += '</div>';\n\n                html += template;\n\n                dlg.innerHTML = globalize.translateDocument(html, 'core');\n\n                var settingElements = dlg.querySelectorAll('.viewSetting');\n                for (var i = 0, length = settingElements.length; i < length; i++) {\n                    if (options.visibleSettings.indexOf(settingElements[i].getAttribute('data-settingname')) === -1) {\n                        settingElements[i].classList.add('hide');\n                    } else {\n                        settingElements[i].classList.remove('hide');\n                    }\n                }\n\n                initEditor(dlg, options.settings);\n                loadDynamicFilters(dlg, options);\n\n                bindCheckboxInput(dlg, true);\n\n                dlg.querySelector('.btnCancel').addEventListener('click', function () {\n\n                    dialogHelper.close(dlg);\n                });\n\n                if (layoutManager.tv) {\n                    centerFocus(dlg.querySelector('.formDialogContent'), false, true);\n                }\n\n                var submitted;\n\n                dlg.querySelector('form').addEventListener('change', function () {\n\n                    submitted = true;\n                    //if (options.onChange) {\n                    //    saveValues(dlg, options.settings, options.settingsKey);\n                    //    options.onChange();\n                    //}\n\n                }, true);\n\n                dialogHelper.open(dlg).then(function () {\n\n                    bindCheckboxInput(dlg, false);\n\n                    if (layoutManager.tv) {\n                        centerFocus(dlg.querySelector('.formDialogContent'), false, false);\n                    }\n\n                    if (submitted) {\n\n                        //if (!options.onChange) {\n                        saveValues(dlg, options.settings, options.settingsKey);\n                        resolve();\n                        //}\n                        return;\n                    }\n\n                    reject();\n                });\n            });\n        });\n    };\n\n    return FilterMenu;\n});\n"]}