{"version":3,"sources":["components/upnextdialog/upnextdialog.js"],"names":["define","dom","playbackManager","connectionManager","events","mediaInfo","layoutManager","focusManager","globalize","itemHelper","transitionEndEventName","whichTransitionEvent","seriesImageUrl","item","options","Type","type","SeriesPrimaryImageTag","tag","getApiClient","ServerId","getScaledImageUrl","SeriesId","SeriesThumbImageTag","ParentThumbImageTag","ParentThumbItemId","imageUrl","ImageTags","PrimaryImageItemId","Id","AlbumId","AlbumPrimaryImageTag","setNextVideoText","elem","this","parent","secondsRemaining","Math","max","round","getTimeRemainingMs","console","debug","timeText","translate","nextVideoText","itemType","querySelector","innerHTML","fillItem","setPoster","osdPoster","secondaryItem","imgUrl","Overview","getPrimaryMediaInfoHtml","title","getDisplayName","SeriesName","show","clearCountdownTextTimeout","instance","_countdownTextTimeout","clearInterval","onStartNowClick","player","hide","nextTrack","init","getHtml","html","classList","add","call","nextItem","addEventListener","bind","clearHideAnimationEventListeners","fn","_onHideAnimationComplete","removeEventListener","once","onHideAnimationComplete","e","target","trigger","hideComingUpNext","contains","offsetWidth","runtimeTicks","duration","timeRemainingTicks","currentTime","UpNextDialog","prototype","remove","tv","setTimeout","focus","startComingUpNextHideTimer","setInterval","destroy"],"mappings":"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","file":"upnextdialog.js","sourcesContent":["define(['dom', 'playbackManager', 'connectionManager', 'events', 'mediaInfo', 'layoutManager', 'focusManager', 'globalize', 'itemHelper', 'css!./upnextdialog', 'emby-button', 'flexStyles'], function (dom, playbackManager, connectionManager, events, mediaInfo, layoutManager, focusManager, globalize, itemHelper) {\n    'use strict';\n\n    var transitionEndEventName = dom.whichTransitionEvent();\n\n    function seriesImageUrl(item, options) {\n\n        if (item.Type !== 'Episode') {\n            return null;\n        }\n\n        options = options || {};\n        options.type = options.type || 'Primary';\n\n        if (options.type === 'Primary') {\n\n            if (item.SeriesPrimaryImageTag) {\n\n                options.tag = item.SeriesPrimaryImageTag;\n\n                return connectionManager.getApiClient(item.ServerId).getScaledImageUrl(item.SeriesId, options);\n            }\n        }\n\n        if (options.type === 'Thumb') {\n\n            if (item.SeriesThumbImageTag) {\n\n                options.tag = item.SeriesThumbImageTag;\n\n                return connectionManager.getApiClient(item.ServerId).getScaledImageUrl(item.SeriesId, options);\n            }\n            if (item.ParentThumbImageTag) {\n\n                options.tag = item.ParentThumbImageTag;\n\n                return connectionManager.getApiClient(item.ServerId).getScaledImageUrl(item.ParentThumbItemId, options);\n            }\n        }\n\n        return null;\n    }\n\n    function imageUrl(item, options) {\n\n        options = options || {};\n        options.type = options.type || 'Primary';\n\n        if (item.ImageTags && item.ImageTags[options.type]) {\n\n            options.tag = item.ImageTags[options.type];\n            return connectionManager.getApiClient(item.ServerId).getScaledImageUrl(item.PrimaryImageItemId || item.Id, options);\n        }\n\n        if (options.type === 'Primary') {\n            if (item.AlbumId && item.AlbumPrimaryImageTag) {\n\n                options.tag = item.AlbumPrimaryImageTag;\n                return connectionManager.getApiClient(item.ServerId).getScaledImageUrl(item.AlbumId, options);\n            }\n        }\n\n        return null;\n    }\n\n    function setPoster(osdPoster, item, secondaryItem) {\n\n        if (item) {\n\n            var imgUrl = seriesImageUrl(item, { type: 'Primary' }) ||\n                seriesImageUrl(item, { type: 'Thumb' }) ||\n                imageUrl(item, { type: 'Primary' });\n\n            if (!imgUrl && secondaryItem) {\n                imgUrl = seriesImageUrl(secondaryItem, { type: 'Primary' }) ||\n                    seriesImageUrl(secondaryItem, { type: 'Thumb' }) ||\n                    imageUrl(secondaryItem, { type: 'Primary' });\n            }\n\n            if (imgUrl) {\n                osdPoster.innerHTML = '<img class=\"upNextDialog-poster-img\" src=\"' + imgUrl + '\" />';\n                return;\n            }\n        }\n\n        osdPoster.innerHTML = '';\n    }\n\n    function getHtml() {\n\n        var html = '';\n\n        html += '<div class=\"upNextDialog-poster\">';\n        html += '</div>';\n\n        html += '<div class=\"flex flex-direction-column flex-grow\">';\n\n        html += '<h2 class=\"upNextDialog-nextVideoText\" style=\"margin:.25em 0;\">&nbsp;</h2>';\n\n        html += '<h3 class=\"upNextDialog-title\" style=\"margin:.25em 0 .5em;\"></h3>';\n\n        html += '<div class=\"flex flex-direction-row upNextDialog-mediainfo\">';\n        html += '</div>';\n\n        html += '<div class=\"upNextDialog-overview\" style=\"margin-top:1em;\"></div>';\n\n        html += '<div class=\"flex flex-direction-row upNextDialog-buttons\" style=\"margin-top:1em;\">';\n\n        html += '<button type=\"button\" is=\"emby-button\" class=\"raised raised-mini btnStartNow upNextDialog-button\">';\n        html += globalize.translate('HeaderStartNow');\n        html += '</button>';\n\n        html += '<button type=\"button\" is=\"emby-button\" class=\"raised raised-mini btnHide upNextDialog-button\">';\n        html += globalize.translate('Hide');\n        html += '</button>';\n\n        // buttons\n        html += '</div>';\n\n        // main\n        html += '</div>';\n\n        return html;\n    }\n\n    function setNextVideoText() {\n\n        var instance = this;\n\n        var elem = instance.options.parent;\n\n        var secondsRemaining = Math.max(Math.round(getTimeRemainingMs(instance) / 1000), 0);\n\n        console.debug('up next seconds remaining: ' + secondsRemaining);\n\n        var timeText = '<span class=\"upNextDialog-countdownText\">' + globalize.translate('HeaderSecondsValue', secondsRemaining) + '</span>';\n\n        var nextVideoText = instance.itemType === 'Episode' ?\n            globalize.translate('HeaderNextEpisodePlayingInValue', timeText) :\n            globalize.translate('HeaderNextVideoPlayingInValue', timeText);\n\n        elem.querySelector('.upNextDialog-nextVideoText').innerHTML = nextVideoText;\n    }\n\n    function fillItem(item) {\n\n        var instance = this;\n\n        var elem = instance.options.parent;\n\n        setPoster(elem.querySelector('.upNextDialog-poster'), item);\n\n        elem.querySelector('.upNextDialog-overview').innerHTML = item.Overview || '';\n\n        elem.querySelector('.upNextDialog-mediainfo').innerHTML = mediaInfo.getPrimaryMediaInfoHtml(item, {\n        });\n\n        var title = itemHelper.getDisplayName(item);\n        if (item.SeriesName) {\n            title = item.SeriesName + ' - ' + title;\n        }\n\n        elem.querySelector('.upNextDialog-title').innerHTML = title || '';\n\n        instance.itemType = item.Type;\n\n        instance.show();\n    }\n\n    function clearCountdownTextTimeout(instance) {\n        if (instance._countdownTextTimeout) {\n            clearInterval(instance._countdownTextTimeout);\n            instance._countdownTextTimeout = null;\n        }\n    }\n\n    function onStartNowClick() {\n\n        var options = this.options;\n\n        if (options) {\n\n            var player = options.player;\n\n            this.hide();\n\n            playbackManager.nextTrack(player);\n        }\n    }\n\n    function init(instance, options) {\n\n        options.parent.innerHTML = getHtml();\n\n        options.parent.classList.add('hide');\n        options.parent.classList.add('upNextDialog');\n        options.parent.classList.add('upNextDialog-hidden');\n\n        fillItem.call(instance, options.nextItem);\n\n        options.parent.querySelector('.btnHide').addEventListener('click', instance.hide.bind(instance));\n        options.parent.querySelector('.btnStartNow').addEventListener('click', onStartNowClick.bind(instance));\n    }\n\n    function clearHideAnimationEventListeners(instance, elem) {\n\n        var fn = instance._onHideAnimationComplete;\n\n        if (fn) {\n            dom.removeEventListener(elem, transitionEndEventName, fn, {\n                once: true\n            });\n        }\n    }\n\n    function onHideAnimationComplete(e) {\n\n        var instance = this;\n        var elem = e.target;\n\n        elem.classList.add('hide');\n\n        clearHideAnimationEventListeners(instance, elem);\n        events.trigger(instance, 'hide');\n    }\n\n    function hideComingUpNext() {\n\n        var instance = this;\n        clearCountdownTextTimeout(this);\n\n        if (!instance.options) {\n            return;\n        }\n\n        var elem = instance.options.parent;\n\n        if (!elem) {\n            return;\n        }\n\n        clearHideAnimationEventListeners(this, elem);\n\n        if (elem.classList.contains('upNextDialog-hidden')) {\n            return;\n        }\n\n        // trigger a reflow to force it to animate again\n        void elem.offsetWidth;\n\n        elem.classList.add('upNextDialog-hidden');\n\n        var fn = onHideAnimationComplete.bind(instance);\n        instance._onHideAnimationComplete = fn;\n\n        dom.addEventListener(elem, transitionEndEventName, fn, {\n            once: true\n        });\n    }\n\n    function getTimeRemainingMs(instance) {\n\n        var options = instance.options;\n        if (options) {\n\n            var runtimeTicks = playbackManager.duration(options.player);\n\n            if (runtimeTicks) {\n                var timeRemainingTicks = runtimeTicks - playbackManager.currentTime(options.player);\n\n                return Math.round(timeRemainingTicks / 10000);\n            }\n        }\n\n        return 0;\n    }\n\n    function startComingUpNextHideTimer(instance) {\n\n        var timeRemainingMs = getTimeRemainingMs(instance);\n\n        if (timeRemainingMs <= 0) {\n            return;\n        }\n\n        setNextVideoText.call(instance);\n        clearCountdownTextTimeout(instance);\n\n        instance._countdownTextTimeout = setInterval(setNextVideoText.bind(instance), 400);\n    }\n\n    function UpNextDialog(options) {\n\n        this.options = options;\n\n        init(this, options);\n    }\n\n    UpNextDialog.prototype.show = function () {\n\n        var elem = this.options.parent;\n\n        clearHideAnimationEventListeners(this, elem);\n\n        elem.classList.remove('hide');\n\n        // trigger a reflow to force it to animate again\n        void elem.offsetWidth;\n\n        elem.classList.remove('upNextDialog-hidden');\n\n        if (layoutManager.tv) {\n            setTimeout(function () {\n                focusManager.focus(elem.querySelector('.btnStartNow'));\n            }, 50);\n        }\n\n        startComingUpNextHideTimer(this);\n    };\n\n    UpNextDialog.prototype.hide = function () {\n\n        hideComingUpNext.call(this);\n    };\n\n    UpNextDialog.prototype.destroy = function () {\n\n        hideComingUpNext.call(this);\n\n        this.options = null;\n        this.itemType = null;\n    };\n\n    return UpNextDialog;\n});\n"]}