"use strict";define(["dialogHelper","loading","connectionManager","require","globalize","scrollHelper","layoutManager","focusManager","browser","emby-input","emby-checkbox","paper-icon-button-light","css!./../formdialog","material-icons","cardStyle"],(function(dialogHelper,loading,connectionManager,require,globalize,scrollHelper,layoutManager,focusManager,browser){var currentItem,currentItemType,currentServerId,currentResolve,currentReject,currentSearchResult,enableFocusTransform=!browser.slow&&!browser.edge,hasChanges=!1;function getApiClient(){return connectionManager.getApiClient(currentServerId)}function searchForIdentificationResults(page){var i,length,value,lookupInfo={ProviderIds:{}},identifyField=page.querySelectorAll(".identifyField");for(i=0,length=identifyField.length;i<length;i++)(value=identifyField[i].value)&&("number"===identifyField[i].type&&(value=parseInt(value)),lookupInfo[identifyField[i].getAttribute("data-lookup")]=value);var hasId=!1,txtLookupId=page.querySelectorAll(".txtLookupId");for(i=0,length=txtLookupId.length;i<length;i++)(value=txtLookupId[i].value)&&(hasId=!0),lookupInfo.ProviderIds[txtLookupId[i].getAttribute("data-providerkey")]=value;if(hasId||lookupInfo.Name){lookupInfo={SearchInfo:lookupInfo},currentItem&&currentItem.Id?lookupInfo.ItemId=currentItem.Id:lookupInfo.IncludeDisabledProviders=!0,loading.show();var apiClient=getApiClient();apiClient.ajax({type:"POST",url:apiClient.getUrl("Items/RemoteSearch/"+currentItemType),data:JSON.stringify(lookupInfo),contentType:"application/json",dataType:"json"}).then((function(results){loading.hide(),function showIdentificationSearchResults(page,results){var identificationSearchResults=page.querySelector(".identificationSearchResults");page.querySelector(".popupIdentifyForm").classList.add("hide"),identificationSearchResults.classList.remove("hide"),page.querySelector(".identifyOptionsForm").classList.add("hide"),page.querySelector(".dialogContentInner").classList.remove("dialog-content-centered");var i,length,html="";for(i=0,length=results.length;i<length;i++){var result=results[i];html+=getSearchResultHtml(result,i)}var elem=page.querySelector(".identificationSearchResultList");function onSearchImageClick(){var index=parseInt(this.getAttribute("data-index")),currentResult=results[index];null!=currentItem?function showIdentifyOptions(page,identifyResult){var identifyOptionsForm=page.querySelector(".identifyOptionsForm");page.querySelector(".popupIdentifyForm").classList.add("hide"),page.querySelector(".identificationSearchResults").classList.add("hide"),identifyOptionsForm.classList.remove("hide"),page.querySelector("#chkIdentifyReplaceImages").checked=!0,page.querySelector(".dialogContentInner").classList.add("dialog-content-centered"),currentSearchResult=identifyResult;var lines=[];lines.push(identifyResult.Name),identifyResult.ProductionYear&&lines.push(identifyResult.ProductionYear);var resultHtml=lines.join("<br/>");if(identifyResult.ImageUrl){var displayUrl=getSearchImageDisplayUrl(identifyResult.ImageUrl,identifyResult.SearchProviderName);resultHtml='<div style="display:flex;align-items:center;"><img src="'+displayUrl+'" style="max-height:240px;" /><div style="margin-left:1em;">'+resultHtml+"</div>"}page.querySelector(".selectedSearchResult").innerHTML=resultHtml,focusManager.focus(identifyOptionsForm.querySelector(".btnSubmit"))}(page,currentResult):function finishFindNewDialog(dlg,identifyResult){currentSearchResult=identifyResult,hasChanges=!0,loading.hide(),dialogHelper.close(dlg)}(page,currentResult)}elem.innerHTML=html;var searchImages=elem.querySelectorAll(".card");for(i=0,length=searchImages.length;i<length;i++)searchImages[i].addEventListener("click",onSearchImageClick);layoutManager.tv&&focusManager.autoFocus(identificationSearchResults)}(page,results)}))}else require(["toast"],(function(toast){toast(globalize.translate("PleaseEnterNameOrId"))}))}function getSearchResultHtml(result,index){var padderClass,html="",cssClass="card scalableCard";("Episode"===currentItemType?(cssClass+=" backdropCard backdropCard-scalable",padderClass="cardPadder-backdrop"):"MusicAlbum"===currentItemType||"MusicArtist"===currentItemType?(cssClass+=" squareCard squareCard-scalable",padderClass="cardPadder-square"):(cssClass+=" portraitCard portraitCard-scalable",padderClass="cardPadder-portrait"),layoutManager.tv&&(cssClass+=" show-focus",enableFocusTransform&&(cssClass+=" show-animation"))," cardBox-bottompadded",html+='<button type="button" class="'+cssClass+'" data-index="'+index+'">',html+='<div class="cardBox cardBox-bottompadded">',html+='<div class="cardScalable">',html+='<div class="'+padderClass+'"></div>',html+='<div class="cardContent searchImage">',result.ImageUrl)?html+='<div class="cardImageContainer coveredImage" style="background-image:url(\''+getSearchImageDisplayUrl(result.ImageUrl,result.SearchProviderName)+"');\"></div>":html+='<div class="cardImageContainer coveredImage defaultCardBackground defaultCardBackground1"><div class="cardText cardCenteredText">'+result.Name+"</div></div>";html+="</div>",html+="</div>";var numLines=3;"MusicAlbum"===currentItemType&&numLines++;var lines=[result.Name];lines.push(result.SearchProviderName),result.AlbumArtist&&lines.push(result.AlbumArtist.Name),result.ProductionYear&&lines.push(result.ProductionYear);for(var i=0;i<numLines;i++)html+=0===i?'<div class="cardText cardText-first cardTextCentered">':'<div class="cardText cardText-secondary cardTextCentered">',html+=lines[i]||"&nbsp;",html+="</div>";return html+="</div>",html+="</button>"}function getSearchImageDisplayUrl(url,provider){return getApiClient().getUrl("Items/RemoteSearch/Image",{imageUrl:url,ProviderName:provider})}function showEditor(itemId){loading.show(),require(["text!./itemidentifier.template.html"],(function(template){var apiClient=getApiClient();apiClient.getItem(apiClient.getCurrentUserId(),itemId).then((function(item){currentItemType=(currentItem=item).Type;var dialogOptions={size:"small",removeOnClose:!0,scrollY:!1};layoutManager.tv&&(dialogOptions.size="fullscreen");var dlg=dialogHelper.createDialog(dialogOptions);dlg.classList.add("formDialog"),dlg.classList.add("recordingDialog");var html="";html+=globalize.translateDocument(template,"core"),dlg.innerHTML=html,dlg.addEventListener("close",onDialogClosed),layoutManager.tv&&scrollHelper.centerFocus.on(dlg.querySelector(".formDialogContent"),!1),item.Path?dlg.querySelector(".fldPath").classList.remove("hide"):dlg.querySelector(".fldPath").classList.add("hide"),dlg.querySelector(".txtPath").innerHTML=item.Path||"",dialogHelper.open(dlg),dlg.querySelector(".popupIdentifyForm").addEventListener("submit",(function(e){return e.preventDefault(),searchForIdentificationResults(dlg),!1})),dlg.querySelector(".identifyOptionsForm").addEventListener("submit",(function(e){return e.preventDefault(),function submitIdentficationResult(page){loading.show();var options={ReplaceAllImages:page.querySelector("#chkIdentifyReplaceImages").checked},apiClient=getApiClient();apiClient.ajax({type:"POST",url:apiClient.getUrl("Items/RemoteSearch/Apply/"+currentItem.Id,options),data:JSON.stringify(currentSearchResult),contentType:"application/json"}).then((function(){hasChanges=!0,loading.hide(),dialogHelper.close(page)}),(function(){loading.hide(),dialogHelper.close(page)}))}(dlg),!1})),dlg.querySelector(".btnCancel").addEventListener("click",(function(e){dialogHelper.close(dlg)})),dlg.classList.add("identifyDialog"),function showIdentificationForm(page,item){var apiClient=getApiClient();apiClient.getJSON(apiClient.getUrl("Items/"+item.Id+"/ExternalIdInfos")).then((function(idList){for(var html="",i=0,length=idList.length;i<length;i++){var idInfo=idList[i],id="txtLookup"+idInfo.Key;html+='<div class="inputContainer">';var fullName=idInfo.Name;idInfo.Type&&(fullName=idInfo.Name+" "+globalize.translate(idInfo.Type));var idLabel=globalize.translate("LabelDynamicExternalId",fullName);html+='<input is="emby-input" class="txtLookupId" data-providerkey="'+idInfo.Key+'" id="'+id+'" label="'+idLabel+'"/>',html+="</div>"}page.querySelector("#txtLookupName").value="","Person"===item.Type||"BoxSet"===item.Type?(page.querySelector(".fldLookupYear").classList.add("hide"),page.querySelector("#txtLookupYear").value=""):(page.querySelector(".fldLookupYear").classList.remove("hide"),page.querySelector("#txtLookupYear").value=""),page.querySelector(".identifyProviderIds").innerHTML=html,page.querySelector(".formDialogHeaderTitle").innerHTML=globalize.translate("Identify")}))}(dlg,item),loading.hide()}))}))}function onDialogClosed(){loading.hide(),hasChanges?currentResolve():currentReject()}function showEditorFindNew(itemName,itemYear,itemType,resolveFunc){currentItem=null,currentItemType=itemType,require(["text!./itemidentifier.template.html"],(function(template){var dialogOptions={size:"small",removeOnClose:!0,scrollY:!1};layoutManager.tv&&(dialogOptions.size="fullscreen");var dlg=dialogHelper.createDialog(dialogOptions);dlg.classList.add("formDialog"),dlg.classList.add("recordingDialog");var html="";html+=globalize.translateDocument(template,"core"),dlg.innerHTML=html,layoutManager.tv&&scrollHelper.centerFocus.on(dlg.querySelector(".formDialogContent"),!1),dialogHelper.open(dlg),dlg.querySelector(".btnCancel").addEventListener("click",(function(e){dialogHelper.close(dlg)})),dlg.querySelector(".popupIdentifyForm").addEventListener("submit",(function(e){return e.preventDefault(),searchForIdentificationResults(dlg),!1})),dlg.addEventListener("close",(function(){loading.hide(),resolveFunc(hasChanges?currentSearchResult:null)})),dlg.classList.add("identifyDialog"),function showIdentificationFormFindNew(dlg,itemName,itemYear,itemType){dlg.querySelector("#txtLookupName").value=itemName,"Person"===itemType||"BoxSet"===itemType?(dlg.querySelector(".fldLookupYear").classList.add("hide"),dlg.querySelector("#txtLookupYear").value=""):(dlg.querySelector(".fldLookupYear").classList.remove("hide"),dlg.querySelector("#txtLookupYear").value=itemYear);dlg.querySelector(".formDialogHeaderTitle").innerHTML=globalize.translate("Search")}(dlg,itemName,itemYear,itemType)}))}return{show:function show(itemId,serverId){return new Promise((function(resolve,reject){currentResolve=resolve,currentReject=reject,currentServerId=serverId,hasChanges=!1,showEditor(itemId)}))},showFindNew:function showFindNew(itemName,itemYear,itemType,serverId){return new Promise((function(resolve,reject){currentServerId=serverId,hasChanges=!1,showEditorFindNew(itemName,itemYear,itemType,resolve)}))}}}));
//# sourceMappingURL=itemidentifier.js.map
