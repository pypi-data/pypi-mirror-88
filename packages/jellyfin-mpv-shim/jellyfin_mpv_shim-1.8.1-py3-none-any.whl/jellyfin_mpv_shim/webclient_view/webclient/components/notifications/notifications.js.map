{"version":3,"sources":["components/notifications/notifications.js"],"names":["define","serverNotifications","playbackManager","events","globalize","require","onOneDocumentClick","document","removeEventListener","window","Notification","permission","requestPermission","serviceWorkerRegistration","resetRegistration","serviceWorker","navigator","ready","then","registration","showNonPersistentNotification","title","options","timeoutMs","notif","show","closeAfter","notification","setTimeout","close","cancel","err","actions","showNotification","apiClient","data","serverId","serverInfo","Id","icon","getIconUrl","badge","showPersistentNotification","showNewItemNotification","item","isPlayingLocally","body","Name","SeriesName","Type","vibrate","tag","imageTags","ImageTags","Primary","getScaledImageUrl","width","type","name","toUrl","split","showPackageInstallNotification","installation","status","getCurrentUser","user","Policy","IsAdministrator","translate","Version","action","id","percentComplete","Math","round","PercentComplete","addEventListener","on","e","onLibraryChanged","newItems","ItemsAdded","length","getItems","getCurrentUserId","Recursive","Limit","Filters","SortBy","SortOrder","Ids","join","MediaTypes","EnableTotalRecordCount","result","items","Items","i"],"mappings":"AAAA,aAAAA,OAAO,CAAC,sBAAuB,kBAAmB,SAAU,YAAa,YAAY,SAAUC,oBAAqBC,gBAAiBC,OAAQC,UAAWC,SAGpJ,SAASC,qBACLC,SAASC,oBAAoB,QAASF,oBACtCC,SAASC,oBAAoB,UAAWF,oBAGpCG,OAAOC,cAAmD,YAAnCD,OAAOC,aAAaC,YAE3CD,aAAaE,oBAOrB,IAAIC,0BAYJ,SAASC,oBAEL,IAAIC,cAAgBC,UAAUD,cAC1BA,eACAA,cAAcE,MAAMC,MAAK,SAAUC,cAC/BN,0BAA4BM,gBAWxC,SAASC,8BAA8BC,MAAOC,QAASC,WAEnD,IACI,IAAIC,MAAQ,IAAId,aAAaW,MAAOC,SAEhCE,MAAMC,MACND,MAAMC,OAGNF,WAnCZ,SAASG,WAAWC,aAAcJ,WAC9BK,YAAW,WACHD,aAAaE,MACbF,aAAaE,QACNF,aAAaG,QACpBH,aAAaG,WAElBP,WA6BKG,CAAWF,MAAOD,WAExB,MAAOQ,KACL,IAAIT,QAAQU,QAIR,MAAMD,IAHNT,QAAQU,QAAU,GAClBZ,8BAA8BC,MAAOC,QAASC,YAO1D,SAASU,iBAAiBX,QAASC,UAAWW,WAE1C,IAAIb,MAAQC,QAAQD,MAEpBC,QAAQa,KAAOb,QAAQa,MAAQ,GAC/Bb,QAAQa,KAAKC,SAAWF,UAAUG,aAAaC,GAC/ChB,QAAQiB,KAAOjB,QAAQiB,MAAQC,aAC/BlB,QAAQmB,MAAQnB,QAAQmB,OAASD,WAAW,aAE5C1B,oBAEID,0BArCR,SAAS6B,2BAA2BrB,MAAOC,QAASC,WAChDV,0BAA0BoB,iBAAiBZ,MAAOC,SAqC9CoB,CAA2BrB,MAAOC,SAItCF,8BAA8BC,MAAOC,QAASC,WAGlD,SAASoB,wBAAwBC,KAAMV,WAEnC,IAAIhC,gBAAgB2C,iBAAiB,CAAC,UAAtC,CAIA,IAAIC,KAAOF,KAAKG,KAEZH,KAAKI,aACLF,KAAOF,KAAKI,WAAa,MAAQF,MAGrC,IAAInB,aAAe,CACfN,MAAO,OAASuB,KAAKK,KACrBH,KAAMA,KACNI,SAAS,EACTC,IAAK,UAAYP,KAAKN,GACtBH,KAAM,IAONiB,UAAYR,KAAKS,WAAa,GAE9BD,UAAUE,UAEV3B,aAAaY,KAAOL,UAAUqB,kBAAkBX,KAAKN,GAAI,CACrDkB,MAAO,GACPL,IAAKC,UAAUE,QACfG,KAAM,aAIdxB,iBAAiBN,aAAc,KAAOO,YAsC1C,SAASM,WAAWkB,MAEhB,OADAA,KAAOA,MAAQ,uBACRrD,QAAQsD,MAAM,KAAKC,MAAM,KAAK,GAAK,IAAMF,KAGpD,SAASG,+BAA+B3B,UAAW4B,aAAcC,QAE7D7B,UAAU8B,iBAAiB9C,MAAK,SAAU+C,MAEtC,GAAKA,KAAKC,OAAOC,gBAAjB,CAIA,IAAIxC,aAAe,CACfwB,IAAK,UAAYW,aAAaxB,GAC9BH,KAAM,IA0BV,GAvBe,cAAX4B,QACApC,aAAaN,MAAQjB,UAAUgE,UAAU,0BAA2BN,aAAaf,KAAMe,aAAaO,SACpG1C,aAAauB,SAAU,GACL,cAAXa,OACPpC,aAAaN,MAAQjB,UAAUgE,UAAU,0BAA2BN,aAAaf,KAAMe,aAAaO,SAClF,WAAXN,QACPpC,aAAaN,MAAQjB,UAAUgE,UAAU,uBAAwBN,aAAaf,KAAMe,aAAaO,SACjG1C,aAAauB,SAAU,GACL,aAAXa,SACPpC,aAAaN,MAAQjB,UAAUgE,UAAU,oBAAqBN,aAAaf,KAAMe,aAAaO,SAE9F1C,aAAaK,QACb,CACI,CACIsC,OAAQ,iBACRjD,MAAOjB,UAAUgE,UAAU,gBAC3B7B,KAAMC,eAIdb,aAAaQ,KAAKoC,GAAKT,aAAaS,IAGzB,aAAXR,OAAuB,CAEvB,IAAIS,gBAAkBC,KAAKC,MAAMZ,aAAaa,iBAAmB,GAEjEhD,aAAamB,KAAO0B,gBAAkB,cAK1CvC,iBAAiBN,aAFQ,cAAXoC,OAAyB,IAAO,EAEN7B,eAnMhD3B,SAASqE,iBAAiB,QAAStE,oBACnCC,SAASqE,iBAAiB,UAAWtE,oBAwBrCQ,oBA8KAX,OAAO0E,GAAG5E,oBAAqB,kBAAkB,SAAU6E,EAAG5C,UAAWC,OAzFzE,SAAS4C,iBAAiB5C,KAAMD,WAE5B,IAAI8C,SAAW7C,KAAK8C,WAEfD,SAASE,SAKVF,SAASE,OAAS,KAClBF,SAASE,OAAS,IAGtBhD,UAAUiD,SAASjD,UAAUkD,mBAAoB,CAE7CC,WAAW,EACXC,MAAO,EACPC,QAAS,cACTC,OAAQ,cACRC,UAAW,aACXC,IAAKV,SAASW,KAAK,KACnBC,WAAY,cACZC,wBAAwB,IAEzB3E,MAAK,SAAU4E,QAId,IAFA,IAAIC,MAAQD,OAAOE,MAEVC,EAAI,EAAGf,OAASa,MAAMb,OAASe,EAAIf,OAAQe,IAEhDtD,wBAAwBoD,MAAME,GAAI/D,eA4D1C6C,CAAiB5C,KAAMD,cAG3B/B,OAAO0E,GAAG5E,oBAAqB,gCAAgC,SAAU6E,EAAG5C,UAAWC,MACnF0B,+BAA+B3B,UAAWC,KAAM,gBAGpDhC,OAAO0E,GAAG5E,oBAAqB,6BAA6B,SAAU6E,EAAG5C,UAAWC,MAChF0B,+BAA+B3B,UAAWC,KAAM,aAGpDhC,OAAO0E,GAAG5E,oBAAqB,gCAAgC,SAAU6E,EAAG5C,UAAWC,MACnF0B,+BAA+B3B,UAAWC,KAAM,gBAGpDhC,OAAO0E,GAAG5E,oBAAqB,qBAAqB,SAAU6E,EAAG5C,UAAWC,MACxE0B,+BAA+B3B,UAAWC,KAAM,eAGpDhC,OAAO0E,GAAG5E,oBAAqB,sBAAsB,SAAU6E,EAAG5C,UAAWC,MAMzEF,iBAJmB,CACfkB,IAAK,UAFMjB,UAAUG,aAAaC,GAGlCjB,MAAOjB,UAAUgE,UAAU,2BAA4BlC,UAAUG,aAAaU,OAEnD,EAAGb,cAGtC/B,OAAO0E,GAAG5E,oBAAqB,oBAAoB,SAAU6E,EAAG5C,UAAWC,MAMvEF,iBAJmB,CACfkB,IAAK,UAFMjB,UAAUG,aAAaC,GAGlCjB,MAAOjB,UAAUgE,UAAU,yBAA0BlC,UAAUG,aAAaU,OAEjD,EAAGb,cAGtC/B,OAAO0E,GAAG5E,oBAAqB,mBAAmB,SAAU6E,EAAG5C,WAE3D,IACIP,aAAe,CACfwB,IAAK,UAFMjB,UAAUG,aAAaC,GAGlCjB,MAAOjB,UAAUgE,UAAU,0BAA2BlC,UAAUG,aAAaU,OAGjFpB,aAAaK,QACb,CACI,CACIsC,OAAQ,UACRjD,MAAOjB,UAAUgE,UAAU,iBAC3B7B,KAAMC,eAIdP,iBAAiBN,aAAc,EAAGO","file":"notifications.js","sourcesContent":["define(['serverNotifications', 'playbackManager', 'events', 'globalize', 'require'], function (serverNotifications, playbackManager, events, globalize, require) {\n    'use strict';\n\n    function onOneDocumentClick() {\n        document.removeEventListener('click', onOneDocumentClick);\n        document.removeEventListener('keydown', onOneDocumentClick);\n\n        // don't request notification permissions if they're already granted or denied\n        if (window.Notification && window.Notification.permission === 'default') {\n            /* eslint-disable-next-line compat/compat */\n            Notification.requestPermission();\n        }\n    }\n\n    document.addEventListener('click', onOneDocumentClick);\n    document.addEventListener('keydown', onOneDocumentClick);\n\n    var serviceWorkerRegistration;\n\n    function closeAfter(notification, timeoutMs) {\n        setTimeout(function () {\n            if (notification.close) {\n                notification.close();\n            } else if (notification.cancel) {\n                notification.cancel();\n            }\n        }, timeoutMs);\n    }\n\n    function resetRegistration() {\n        /* eslint-disable-next-line compat/compat */\n        var serviceWorker = navigator.serviceWorker;\n        if (serviceWorker) {\n            serviceWorker.ready.then(function (registration) {\n                serviceWorkerRegistration = registration;\n            });\n        }\n    }\n\n    resetRegistration();\n\n    function showPersistentNotification(title, options, timeoutMs) {\n        serviceWorkerRegistration.showNotification(title, options);\n    }\n\n    function showNonPersistentNotification(title, options, timeoutMs) {\n\n        try {\n            var notif = new Notification(title, options); /* eslint-disable-line compat/compat */\n\n            if (notif.show) {\n                notif.show();\n            }\n\n            if (timeoutMs) {\n                closeAfter(notif, timeoutMs);\n            }\n        } catch (err) {\n            if (options.actions) {\n                options.actions = [];\n                showNonPersistentNotification(title, options, timeoutMs);\n            } else {\n                throw err;\n            }\n        }\n    }\n\n    function showNotification(options, timeoutMs, apiClient) {\n\n        var title = options.title;\n\n        options.data = options.data || {};\n        options.data.serverId = apiClient.serverInfo().Id;\n        options.icon = options.icon || getIconUrl();\n        options.badge = options.badge || getIconUrl('badge.png');\n\n        resetRegistration();\n\n        if (serviceWorkerRegistration) {\n            showPersistentNotification(title, options, timeoutMs);\n            return;\n        }\n\n        showNonPersistentNotification(title, options, timeoutMs);\n    }\n\n    function showNewItemNotification(item, apiClient) {\n\n        if (playbackManager.isPlayingLocally(['Video'])) {\n            return;\n        }\n\n        var body = item.Name;\n\n        if (item.SeriesName) {\n            body = item.SeriesName + ' - ' + body;\n        }\n\n        var notification = {\n            title: 'New ' + item.Type,\n            body: body,\n            vibrate: true,\n            tag: 'newItem' + item.Id,\n            data: {\n                //options: {\n                //    url: LibraryBrowser.getHref(item)\n                //}\n            }\n        };\n\n        var imageTags = item.ImageTags || {};\n\n        if (imageTags.Primary) {\n\n            notification.icon = apiClient.getScaledImageUrl(item.Id, {\n                width: 80,\n                tag: imageTags.Primary,\n                type: 'Primary'\n            });\n        }\n\n        showNotification(notification, 15000, apiClient);\n    }\n\n    function onLibraryChanged(data, apiClient) {\n\n        var newItems = data.ItemsAdded;\n\n        if (!newItems.length) {\n            return;\n        }\n\n        // Don't put a massive number of Id's onto the query string\n        if (newItems.length > 12) {\n            newItems.length = 12;\n        }\n\n        apiClient.getItems(apiClient.getCurrentUserId(), {\n\n            Recursive: true,\n            Limit: 3,\n            Filters: 'IsNotFolder',\n            SortBy: 'DateCreated',\n            SortOrder: 'Descending',\n            Ids: newItems.join(','),\n            MediaTypes: 'Audio,Video',\n            EnableTotalRecordCount: false\n\n        }).then(function (result) {\n\n            var items = result.Items;\n\n            for (var i = 0, length = items.length ; i < length; i++) {\n\n                showNewItemNotification(items[i], apiClient);\n            }\n        });\n    }\n\n    function getIconUrl(name) {\n        name = name || 'notificationicon.png';\n        return require.toUrl('.').split('?')[0] + '/' + name;\n    }\n\n    function showPackageInstallNotification(apiClient, installation, status) {\n\n        apiClient.getCurrentUser().then(function (user) {\n\n            if (!user.Policy.IsAdministrator) {\n                return;\n            }\n\n            var notification = {\n                tag: 'install' + installation.Id,\n                data: {}\n            };\n\n            if (status === 'completed') {\n                notification.title = globalize.translate('PackageInstallCompleted', installation.Name, installation.Version);\n                notification.vibrate = true;\n            } else if (status === 'cancelled') {\n                notification.title = globalize.translate('PackageInstallCancelled', installation.Name, installation.Version);\n            } else if (status === 'failed') {\n                notification.title = globalize.translate('PackageInstallFailed', installation.Name, installation.Version);\n                notification.vibrate = true;\n            } else if (status === 'progress') {\n                notification.title = globalize.translate('InstallingPackage', installation.Name, installation.Version);\n\n                notification.actions =\n                [\n                    {\n                        action: 'cancel-install',\n                        title: globalize.translate('ButtonCancel'),\n                        icon: getIconUrl()\n                    }\n                ];\n\n                notification.data.id = installation.id;\n            }\n\n            if (status === 'progress') {\n\n                var percentComplete = Math.round(installation.PercentComplete || 0);\n\n                notification.body = percentComplete + '% complete.';\n            }\n\n            var timeout = status === 'cancelled' ? 5000 : 0;\n\n            showNotification(notification, timeout, apiClient);\n        });\n    }\n\n    events.on(serverNotifications, 'LibraryChanged', function (e, apiClient, data) {\n        onLibraryChanged(data, apiClient);\n    });\n\n    events.on(serverNotifications, 'PackageInstallationCompleted', function (e, apiClient, data) {\n        showPackageInstallNotification(apiClient, data, 'completed');\n    });\n\n    events.on(serverNotifications, 'PackageInstallationFailed', function (e, apiClient, data) {\n        showPackageInstallNotification(apiClient, data, 'failed');\n    });\n\n    events.on(serverNotifications, 'PackageInstallationCancelled', function (e, apiClient, data) {\n        showPackageInstallNotification(apiClient, data, 'cancelled');\n    });\n\n    events.on(serverNotifications, 'PackageInstalling', function (e, apiClient, data) {\n        showPackageInstallNotification(apiClient, data, 'progress');\n    });\n\n    events.on(serverNotifications, 'ServerShuttingDown', function (e, apiClient, data) {\n        var serverId = apiClient.serverInfo().Id;\n        var notification = {\n            tag: 'restart' + serverId,\n            title: globalize.translate('ServerNameIsShuttingDown', apiClient.serverInfo().Name)\n        };\n        showNotification(notification, 0, apiClient);\n    });\n\n    events.on(serverNotifications, 'ServerRestarting', function (e, apiClient, data) {\n        var serverId = apiClient.serverInfo().Id;\n        var notification = {\n            tag: 'restart' + serverId,\n            title: globalize.translate('ServerNameIsRestarting', apiClient.serverInfo().Name)\n        };\n        showNotification(notification, 0, apiClient);\n    });\n\n    events.on(serverNotifications, 'RestartRequired', function (e, apiClient) {\n\n        var serverId = apiClient.serverInfo().Id;\n        var notification = {\n            tag: 'restart' + serverId,\n            title: globalize.translate('PleaseRestartServerName', apiClient.serverInfo().Name)\n        };\n\n        notification.actions =\n        [\n            {\n                action: 'restart',\n                title: globalize.translate('ButtonRestart'),\n                icon: getIconUrl()\n            }\n        ];\n\n        showNotification(notification, 0, apiClient);\n    });\n});\n"]}