{"version":3,"sources":["components/images/imageLoader.js"],"names":["_typeof","obj","Symbol","iterator","constructor","prototype","define","_exports","lazyLoader","userSettings","blurhash","_style","_getRequireWildcardCache","WeakMap","cache","_interopRequireWildcard","__esModule","default","has","get","newObj","hasPropertyDescriptor","Object","defineProperty","getOwnPropertyDescriptor","key","hasOwnProperty","call","desc","set","_createForOfIteratorHelper","o","allowArrayLike","it","Array","isArray","_unsupportedIterableToArray","minLen","_arrayLikeToArray","n","toString","slice","name","from","test","length","i","F","s","done","value","e","_e","f","TypeError","err","normalCompletion","didErr","step","next","_e2","return","arr","len","arr2","lazyImage","elem","source","arguments","undefined","getAttribute","fillImageElement","itemBlurhashing","target","blurhashstr","isBlurhashValid","pixels","decode","console","error","classList","add","canvas","document","createElement","width","height","ctx","getContext","imgData","createImageData","data","putImageData","requestAnimationFrame","enableFastFadein","parentNode","insertBefore","removeAttribute","fillImage","entry","Error","intersectionRatio","emptyImageElement","url","tagName","style","backgroundImage","replace","setAttribute","remove","preloaderImg","Image","src","addEventListener","lazyChildren","enableBlurhash","_step","_iterator","querySelectorAll","lazyElem","contains","getPrimaryImageAspectRatio","items","values","ratio","PrimaryImageAspectRatio","sort","a","b","result","half","Math","floor","abs","fillImages","elems","setLazyImage","element","_default","serLazyImage"],"mappings":"AAAA,SAASA,QAAQC,KAAmV,OAAtOD,QAArD,mBAAXE,QAAoD,iBAApBA,OAAOC,SAAmC,SAASH,QAAQC,KAAO,cAAcA,KAA2B,SAASD,QAAQC,KAAO,OAAOA,KAAyB,mBAAXC,QAAyBD,IAAIG,cAAgBF,QAAUD,MAAQC,OAAOG,UAAY,gBAAkBJ,MAAyBA,KAEnXK,OAAO,CAAC,UAAW,aAAc,eAAgB,WAAY,gBAAgB,SAAUC,SAAUC,WAAYC,aAAcC,SAAUC,QACnI,aAgBA,SAASC,2BAA6B,GAAuB,mBAAZC,QAAwB,OAAO,KAAM,IAAIC,MAAQ,IAAID,QAA6F,OAAlFD,yBAA2B,SAASA,2BAA6B,OAAOE,OAAiBA,MAE1M,SAASC,wBAAwBd,KAAO,GAAIA,KAAOA,IAAIe,WAAc,OAAOf,IAAO,GAAY,OAARA,KAAiC,WAAjBD,QAAQC,MAAoC,mBAARA,IAAsB,MAAO,CAAEgB,QAAShB,KAAS,IAAIa,MAAQF,2BAA4B,GAAIE,OAASA,MAAMI,IAAIjB,KAAQ,OAAOa,MAAMK,IAAIlB,KAAQ,IAAImB,OAAS,GAAQC,sBAAwBC,OAAOC,gBAAkBD,OAAOE,yBAA0B,IAAK,IAAIC,OAAOxB,IAAO,GAAIqB,OAAOjB,UAAUqB,eAAeC,KAAK1B,IAAKwB,KAAM,CAAE,IAAIG,KAAOP,sBAAwBC,OAAOE,yBAAyBvB,IAAKwB,KAAO,KAAUG,OAASA,KAAKT,KAAOS,KAAKC,KAAQP,OAAOC,eAAeH,OAAQK,IAAKG,MAAgBR,OAAOK,KAAOxB,IAAIwB,KAAyE,OAA7DL,OAAOH,QAAUhB,IAASa,OAASA,MAAMe,IAAI5B,IAAKmB,QAAkBA,OAEhuB,SAASU,2BAA2BC,EAAGC,gBAAkB,IAAIC,GAAI,GAAsB,oBAAX/B,QAAgD,MAAtB6B,EAAE7B,OAAOC,UAAmB,CAAE,GAAI+B,MAAMC,QAAQJ,KAAOE,GAE7J,SAASG,4BAA4BL,EAAGM,QAAU,IAAKN,EAAG,OAAQ,GAAiB,iBAANA,EAAgB,OAAOO,kBAAkBP,EAAGM,QAAS,IAAIE,EAAIjB,OAAOjB,UAAUmC,SAASb,KAAKI,GAAGU,MAAM,GAAI,GAAc,WAANF,GAAkBR,EAAE3B,cAAamC,EAAIR,EAAE3B,YAAYsC,MAAM,GAAU,QAANH,GAAqB,QAANA,EAAa,OAAOL,MAAMS,KAAKZ,GAAI,GAAU,cAANQ,GAAqB,2CAA2CK,KAAKL,GAAI,OAAOD,kBAAkBP,EAAGM,QAFpPD,CAA4BL,KAAOC,gBAAkBD,GAAyB,iBAAbA,EAAEc,OAAqB,CAAMZ,KAAIF,EAAIE,IAAI,IAAIa,EAAI,EAAOC,EAAI,SAASA,MAAQ,MAAO,CAAEC,EAAGD,EAAGR,EAAG,SAASA,IAAM,OAAIO,GAAKf,EAAEc,OAAe,CAAEI,MAAM,GAAe,CAAEA,MAAM,EAAOC,MAAOnB,EAAEe,OAAWK,EAAG,SAASA,EAAEC,IAAM,MAAMA,IAAOC,EAAGN,GAAO,MAAM,IAAIO,UAAU,yIAA4I,IAA6CC,IAAzCC,kBAAmB,EAAMC,QAAS,EAAY,MAAO,CAAET,EAAG,SAASA,IAAMf,GAAKF,EAAE7B,OAAOC,aAAgBoC,EAAG,SAASA,IAAM,IAAImB,KAAOzB,GAAG0B,OAAsC,OAA9BH,iBAAmBE,KAAKT,KAAaS,MAASP,EAAG,SAASA,EAAES,KAAOH,QAAS,EAAMF,IAAMK,KAAQP,EAAG,SAASA,IAAM,IAAWG,kBAAiC,MAAbvB,GAAG4B,QAAgB5B,GAAG4B,SAAY,QAAU,GAAIJ,OAAQ,MAAMF,OAIl9B,SAASjB,kBAAkBwB,IAAKC,MAAkB,MAAPA,KAAeA,IAAMD,IAAIjB,UAAQkB,IAAMD,IAAIjB,QAAQ,IAAK,IAAIC,EAAI,EAAGkB,KAAO,IAAI9B,MAAM6B,KAAMjB,EAAIiB,IAAKjB,IAAOkB,KAAKlB,GAAKgB,IAAIhB,GAAM,OAAOkB,KArBvK,SAASC,UAAUC,MAA8C,IAAxCC,OAAwCC,UAAAvB,OAAA,QAAAwB,IAAAD,UAAA,GAAAA,UAAA,GAA/BF,KAAKI,aAAa,YAClDH,QAILI,iBAAiBL,KAAMC,QAG3B,SAASK,gBAAgBC,OAAQC,aAC7B,GAAIhE,SAASiE,gBAAgBD,aAAc,CAIvC,IAEIE,OACJ,IACIA,OAASlE,SAASmE,OAAOH,YAJjB,GACC,IAIX,MAAOnB,KAGL,OAFAuB,QAAQC,MAAM,0BAA2BxB,UACzCkB,OAAOO,UAAUC,IAAI,oBAGzB,IAAIC,OAASC,SAASC,cAAc,UACpCF,OAAOG,MAXK,GAYZH,OAAOI,OAXM,GAYb,IAAIC,IAAML,OAAOM,WAAW,MACxBC,QAAUF,IAAIG,gBAdN,GACC,IAebD,QAAQE,KAAK9D,IAAI+C,QACjBW,IAAIK,aAAaH,QAAS,EAAG,GAE7BI,uBAAsB,WAClBX,OAAOF,UAAUC,IAAI,mBACjBxE,aAAaqF,mBACbZ,OAAOF,UAAUC,IAAI,6BAErBC,OAAOF,UAAUC,IAAI,wBAGzBR,OAAOsB,WAAWC,aAAad,OAAQT,QACvCA,OAAOO,UAAUC,IAAI,cACrBR,OAAOwB,gBAAgB,qBAK5B,SAASC,UAAUC,OACtB,IAAKA,MACD,MAAM,IAAIC,MAAM,wBAEpB,IAAI3B,OAAS0B,MAAM1B,OACfN,YAASE,EAGTF,OADAM,OACSA,OAAOH,aAAa,YAEpB6B,MAGTA,MAAME,kBAAoB,EACtBlC,QAAQI,iBAAiBE,OAAQN,QAC7BA,QACR0B,uBAAsB,YAmC9B,SAASS,kBAAkBpC,MACvB,IAAIqC,IAEiB,QAAjBrC,KAAKsC,SACLD,IAAMrC,KAAKuC,MAAMC,gBAAgBjE,MAAM,GAAI,GAAGkE,QAAQ,KAAM,IAC5DzC,KAAKuC,MAAMC,gBAAkB,SAE7BH,IAAMrC,KAAKI,aAAa,OACxBJ,KAAK0C,aAAa,MAAO,KAE7B1C,KAAK0C,aAAa,WAAYL,KAE9BrC,KAAKc,UAAU6B,OAAO,yBAA0B,qBAChD3C,KAAKc,UAAUC,IAAI,eA/CXqB,CAAkB7B,WAK9B,SAASF,iBAAiBL,KAAMqC,KAC5B,QAAYlC,IAARkC,IACA,MAAM,IAAIjD,UAAU,2BAGxB,IAAIwD,aAAe,IAAIC,MACvBD,aAAaE,IAAMT,IAEnBrC,KAAKc,UAAUC,IAAI,eAEnB6B,aAAaG,iBAAiB,QAAQ,WAClCpB,uBAAsB,WACG,QAAjB3B,KAAKsC,QACLtC,KAAKuC,MAAMC,gBAAkB,QAAUH,IAAM,KAE7CrC,KAAK0C,aAAa,MAAOL,KAE7BrC,KAAK+B,gBAAgB,YAErB/B,KAAKc,UAAU6B,OAAO,eAClBpG,aAAaqF,mBACb5B,KAAKc,UAAUC,IAAI,0BAEnBf,KAAKc,UAAUC,IAAI,2BAsB5B,SAASiC,aAAahD,MACzB,GAAIzD,aAAa0G,iBAAkB,CAAA,IAAAC,MAAAC,UAAAvF,2BACRoC,KAAKoD,iBAAiB,UADd,IAC/B,IAAAD,UAAArE,MAAAoE,MAAAC,UAAA9E,KAAAU,MAAuD,CAAA,IAA5CsE,SAA4CH,MAAAlE,MAC7CwB,YAAc6C,SAASjD,aAAa,kBACrCiD,SAASvC,UAAUwC,SAAS,aAAc,qBAAuB9C,YAClEF,gBAAgB+C,SAAU7C,aAClBA,aAAgB6C,SAASvC,UAAUwC,SAAS,eACpDD,SAASvC,UAAUC,IAAI,qBANA,MAAA1B,KAAA8D,UAAAlE,EAAAI,KAAA,QAAA8D,UAAAhE,KAUnC7C,WAAW0G,aAAahD,KAAMgC,WAG3B,SAASuB,2BAA2BC,OAIvC,IAFA,IAAIC,OAAS,GAEJ7E,EAAI,EAAGD,OAAS6E,MAAM7E,OAAQC,EAAID,OAAQC,IAAK,CAEpD,IAAI8E,MAAQF,MAAM5E,GAAG+E,yBAA2B,EAE3CD,QAILD,OAAOA,OAAO9E,QAAU+E,OAG5B,IAAKD,OAAO9E,OACR,OAAO,KAIX8E,OAAOG,MAAK,SAAUC,EAAGC,GACrB,OAAOD,EAAIC,KAGf,IAEIC,OAFAC,KAAOC,KAAKC,MAAMT,OAAO9E,OAAS,GAKlCoF,OADAN,OAAO9E,OAAS,EACP8E,OAAOO,OAENP,OAAOO,KAAO,GAAKP,OAAOO,OAAS,EAKjD,GAAIC,KAAKE,IADO,EAAI,EACKJ,SAAW,IAChC,OAFY,EAAI,EAOpB,GAAIE,KAAKE,IADQ,GAAK,EACIJ,SAAW,GACjC,OAFa,GAAK,EAMtB,GAAIE,KAAKE,IAAI,EAAIJ,SAAW,IACxB,OAAO,EAKX,OAAIE,KAAKE,IADO,EAAI,EACKJ,SAAW,IADpB,EAAI,EAKbA,OAGJ,SAASK,WAAWC,OAEvB,IAAK,IAAIzF,EAAI,EAAGD,OAAS0F,MAAM1F,OAAQC,EAAID,OAAQC,IAAK,CAEpDoD,UADWqC,MAAM,KAKlB,SAASC,aAAaC,QAASlC,KAClCkC,QAAQzD,UAAUC,IAAI,QACtBwD,QAAQ7B,aAAa,WAAYL,KACjCtC,UAAUwE,SAxMhBnH,OAAOC,eAAehB,SAAU,aAAc,CAC5C2C,OAAO,IAET3C,SAAS0D,UAAYA,UACrB1D,SAAS2F,UAAYA,UACrB3F,SAAS2G,aAAeA,aACxB3G,SAASkH,2BAA6BA,2BACtClH,SAAS+H,WAAaA,WACtB/H,SAASiI,aAAeA,aACxBjI,SAASU,aAAU,EAdrBT,WAAAO,wBAAAP,YACAC,aAAAM,wBAAAN,cACAC,SAAAK,wBAAAL,UAqPE,IAAIgI,SAtCS,CACXC,aAAcH,aACdF,WAAYA,WACZpC,UAAWA,UACXjC,UAAWA,UACXiD,aAAcA,aACdO,2BAA4BA,4BAwC9BlH,SAASU,QAAUyH","file":"imageLoader.js","sourcesContent":["import * as lazyLoader from 'lazyLoader';\nimport * as userSettings from 'userSettings';\nimport * as blurhash from 'blurhash';\nimport 'css!./style';\n/* eslint-disable indent */\n\n    export function lazyImage(elem, source = elem.getAttribute('data-src')) {\n        if (!source) {\n            return;\n        }\n\n        fillImageElement(elem, source);\n    }\n\n    function itemBlurhashing(target, blurhashstr) {\n        if (blurhash.isBlurhashValid(blurhashstr)) {\n            // Although the default values recommended by Blurhash developers is 32x32, a size of 18x18 seems to be the sweet spot for us,\n            // improving the performance and reducing the memory usage, while retaining almost full blur quality.\n            // Lower values had more visible pixelation\n            let width = 18;\n            let height = 18;\n            let pixels;\n            try {\n                pixels = blurhash.decode(blurhashstr, width, height);\n            } catch (err) {\n                console.error('Blurhash decode error: ', err);\n                target.classList.add('non-blurhashable');\n                return;\n            }\n            let canvas = document.createElement('canvas');\n            canvas.width = width;\n            canvas.height = height;\n            let ctx = canvas.getContext('2d');\n            let imgData = ctx.createImageData(width, height);\n\n            imgData.data.set(pixels);\n            ctx.putImageData(imgData, 0, 0);\n\n            requestAnimationFrame(() => {\n                canvas.classList.add('blurhash-canvas');\n                if (userSettings.enableFastFadein()) {\n                    canvas.classList.add('lazy-blurhash-fadein-fast');\n                } else {\n                    canvas.classList.add('lazy-blurhash-fadein');\n                }\n\n                target.parentNode.insertBefore(canvas, target);\n                target.classList.add('blurhashed');\n                target.removeAttribute('data-blurhash');\n            });\n        }\n    }\n\n    export function fillImage(entry) {\n        if (!entry) {\n            throw new Error('entry cannot be null');\n        }\n        let target = entry.target;\n        var source = undefined;\n\n        if (target) {\n            source = target.getAttribute('data-src');\n        } else {\n            source = entry;\n        }\n\n        if (entry.intersectionRatio > 0) {\n            if (source) fillImageElement(target, source);\n        } else if (!source) {\n            requestAnimationFrame(() => {\n                emptyImageElement(target);\n            });\n        }\n    }\n\n    function fillImageElement(elem, url) {\n        if (url === undefined) {\n            throw new TypeError('url cannot be undefined');\n        }\n\n        let preloaderImg = new Image();\n        preloaderImg.src = url;\n\n        elem.classList.add('lazy-hidden');\n\n        preloaderImg.addEventListener('load', () => {\n            requestAnimationFrame(() => {\n                if (elem.tagName !== 'IMG') {\n                    elem.style.backgroundImage = \"url('\" + url + \"')\";\n                } else {\n                    elem.setAttribute('src', url);\n                }\n                elem.removeAttribute('data-src');\n\n                elem.classList.remove('lazy-hidden');\n                if (userSettings.enableFastFadein()) {\n                    elem.classList.add('lazy-image-fadein-fast');\n                } else {\n                    elem.classList.add('lazy-image-fadein');\n                }\n            });\n        });\n    }\n\n    function emptyImageElement(elem) {\n        var url;\n\n        if (elem.tagName !== 'IMG') {\n            url = elem.style.backgroundImage.slice(4, -1).replace(/\"/g, '');\n            elem.style.backgroundImage = 'none';\n        } else {\n            url = elem.getAttribute('src');\n            elem.setAttribute('src', '');\n        }\n        elem.setAttribute('data-src', url);\n\n        elem.classList.remove('lazy-image-fadein-fast', 'lazy-image-fadein');\n        elem.classList.add('lazy-hidden');\n    }\n\n    export function lazyChildren(elem) {\n        if (userSettings.enableBlurhash()) {\n            for (const lazyElem of elem.querySelectorAll('.lazy')) {\n                const blurhashstr = lazyElem.getAttribute('data-blurhash');\n                if (!lazyElem.classList.contains('blurhashed', 'non-blurhashable') && blurhashstr) {\n                    itemBlurhashing(lazyElem, blurhashstr);\n                } else if (!blurhashstr && !lazyElem.classList.contains('blurhashed')) {\n                    lazyElem.classList.add('non-blurhashable');\n                }\n            }\n        }\n        lazyLoader.lazyChildren(elem, fillImage);\n    }\n\n    export function getPrimaryImageAspectRatio(items) {\n\n        var values = [];\n\n        for (var i = 0, length = items.length; i < length; i++) {\n\n            var ratio = items[i].PrimaryImageAspectRatio || 0;\n\n            if (!ratio) {\n                continue;\n            }\n\n            values[values.length] = ratio;\n        }\n\n        if (!values.length) {\n            return null;\n        }\n\n        // Use the median\n        values.sort(function (a, b) {\n            return a - b;\n        });\n\n        var half = Math.floor(values.length / 2);\n\n        var result;\n\n        if (values.length % 2) {\n            result = values[half];\n        } else {\n            result = (values[half - 1] + values[half]) / 2.0;\n        }\n\n        // If really close to 2:3 (poster image), just return 2:3\n        var aspect2x3 = 2 / 3;\n        if (Math.abs(aspect2x3 - result) <= 0.15) {\n            return aspect2x3;\n        }\n\n        // If really close to 16:9 (episode image), just return 16:9\n        var aspect16x9 = 16 / 9;\n        if (Math.abs(aspect16x9 - result) <= 0.2) {\n            return aspect16x9;\n        }\n\n        // If really close to 1 (square image), just return 1\n        if (Math.abs(1 - result) <= 0.15) {\n            return 1;\n        }\n\n        // If really close to 4:3 (poster image), just return 2:3\n        var aspect4x3 = 4 / 3;\n        if (Math.abs(aspect4x3 - result) <= 0.15) {\n            return aspect4x3;\n        }\n\n        return result;\n    }\n\n    export function fillImages(elems) {\n\n        for (var i = 0, length = elems.length; i < length; i++) {\n            var elem = elems[0];\n            fillImage(elem);\n        }\n    }\n\n    export function setLazyImage(element, url) {\n        element.classList.add('lazy');\n        element.setAttribute('data-src', url);\n        lazyImage(element);\n    }\n\n/* eslint-enable indent */\nexport default {\n    serLazyImage: setLazyImage,\n    fillImages: fillImages,\n    fillImage: fillImage,\n    lazyImage: lazyImage,\n    lazyChildren: lazyChildren,\n    getPrimaryImageAspectRatio: getPrimaryImageAspectRatio\n};\n"]}