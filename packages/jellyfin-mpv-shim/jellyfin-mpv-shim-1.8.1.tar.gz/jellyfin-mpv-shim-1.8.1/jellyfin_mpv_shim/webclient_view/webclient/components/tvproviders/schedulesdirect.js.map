{"version":3,"sources":["components/tvproviders/schedulesdirect.js"],"names":["define","$","loading","globalize","page","providerId","options","reload","show","ApiClient","getNamedConfiguration","then","config","info","ListingProviders","filter","i","Id","listingsId","ListingsId","val","querySelector","value","Username","ZipCode","Password","classList","remove","add","checked","EnableAllTuners","setCountry","getJSON","getUrl","result","length","countryList","region","countries","push","name","fullName","shortName","sort","a","b","html","map","c","join","Country","trigger","Dashboard","alert","message","translate","hide","refreshTunerDevices","providerInfo","devices","device","enabledTuners","EnabledTuners","checkedAttribute","indexOf","FriendlyName","getTunerName","Type","Url","innerHTML","TunerHosts","sha256","str","self","TextEncoder","Promise","resolve","buffer","encode","crypto","subtle","digest","hash","hex","hexCodes","view","DataView","byteLength","paddedValue","getUint32","toString","slice","toLowerCase","this","submit","click","init","hideCancelButton","showCancelButton","toggle","hideSubmitButton","showSubmitButton","on","submitLoginForm","passwordHash","Pw","id","ajax","type","url","ValidateLogin","data","JSON","stringify","contentType","dataType","processServerConfigurationUpdateResult","submitListingsForm","selectedListingsId","get","getAttribute","ValidateListings","showConfirmation","Events","refreshListings","Location","o","Name","addEventListener","e","target"],"mappings":"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","file":"schedulesdirect.js","sourcesContent":["define(['jQuery', 'loading', 'globalize', 'emby-checkbox', 'listViewStyle', 'emby-input', 'emby-select', 'emby-button', 'flexStyles'], function ($, loading, globalize) {\n    'use strict';\n\n    return function (page, providerId, options) {\n        function reload() {\n            loading.show();\n            ApiClient.getNamedConfiguration('livetv').then(function (config) {\n                var info = config.ListingProviders.filter(function (i) {\n                    return i.Id === providerId;\n                })[0] || {};\n                listingsId = info.ListingsId;\n                $('#selectListing', page).val(info.ListingsId || '');\n                page.querySelector('.txtUser').value = info.Username || '';\n                page.querySelector('.txtPass').value = '';\n                page.querySelector('.txtZipCode').value = info.ZipCode || '';\n\n                if (info.Username && info.Password) {\n                    page.querySelector('.listingsSection').classList.remove('hide');\n                } else {\n                    page.querySelector('.listingsSection').classList.add('hide');\n                }\n\n                page.querySelector('.chkAllTuners').checked = info.EnableAllTuners;\n\n                if (info.EnableAllTuners) {\n                    page.querySelector('.selectTunersSection').classList.add('hide');\n                } else {\n                    page.querySelector('.selectTunersSection').classList.remove('hide');\n                }\n\n                setCountry(info);\n                refreshTunerDevices(page, info, config.TunerHosts);\n            });\n        }\n\n        function setCountry(info) {\n            ApiClient.getJSON(ApiClient.getUrl('LiveTv/ListingProviders/SchedulesDirect/Countries')).then(function (result) {\n                var i;\n                var length;\n                var countryList = [];\n\n                for (var region in result) {\n                    var countries = result[region];\n\n                    if (countries.length && 'ZZZ' !== region) {\n                        for (i = 0, length = countries.length; i < length; i++) {\n                            countryList.push({\n                                name: countries[i].fullName,\n                                value: countries[i].shortName\n                            });\n                        }\n                    }\n                }\n\n                countryList.sort(function (a, b) {\n                    if (a.name > b.name) {\n                        return 1;\n                    }\n\n                    if (a.name < b.name) {\n                        return -1;\n                    }\n\n                    return 0;\n                });\n                $('#selectCountry', page).html(countryList.map(function (c) {\n                    return '<option value=\"' + c.value + '\">' + c.name + '</option>';\n                }).join('')).val(info.Country || '');\n                $(page.querySelector('.txtZipCode')).trigger('change');\n            }, function () { // ApiClient.getJSON() error handler\n                Dashboard.alert({\n                    message: globalize.translate('ErrorGettingTvLineups')\n                });\n            });\n            loading.hide();\n        }\n\n        function sha256(str) {\n            if (!self.TextEncoder) {\n                return Promise.resolve('');\n            }\n\n            var buffer = new TextEncoder('utf-8').encode(str);\n            return crypto.subtle.digest('SHA-256', buffer).then(function (hash) {\n                return hex(hash);\n            });\n        }\n\n        function hex(buffer) {\n            var hexCodes = [];\n            var view = new DataView(buffer);\n\n            for (var i = 0; i < view.byteLength; i += 4) {\n                var value = view.getUint32(i);\n                var stringValue = value.toString(16);\n                var paddedValue = ('00000000' + stringValue).slice(-'00000000'.length);\n                hexCodes.push(paddedValue);\n            }\n\n            return hexCodes.join('');\n        }\n\n        function submitLoginForm() {\n            loading.show();\n            sha256(page.querySelector('.txtPass').value).then(function (passwordHash) {\n                var info = {\n                    Type: 'SchedulesDirect',\n                    Username: page.querySelector('.txtUser').value,\n                    EnableAllTuners: true,\n                    Password: passwordHash,\n                    Pw: page.querySelector('.txtPass').value\n                };\n                var id = providerId;\n\n                if (id) {\n                    info.Id = id;\n                }\n\n                ApiClient.ajax({\n                    type: 'POST',\n                    url: ApiClient.getUrl('LiveTv/ListingProviders', {\n                        ValidateLogin: true\n                    }),\n                    data: JSON.stringify(info),\n                    contentType: 'application/json',\n                    dataType: 'json'\n                }).then(function (result) {\n                    Dashboard.processServerConfigurationUpdateResult();\n                    providerId = result.Id;\n                    reload();\n                }, function () {\n                    Dashboard.alert({ // ApiClient.ajax() error handler\n                        message: globalize.translate('ErrorSavingTvProvider')\n                    });\n                });\n            });\n        }\n\n        function submitListingsForm() {\n            var selectedListingsId = $('#selectListing', page).val();\n\n            if (!selectedListingsId) {\n                return void Dashboard.alert({\n                    message: globalize.translate('ErrorPleaseSelectLineup')\n                });\n            }\n\n            loading.show();\n            var id = providerId;\n            ApiClient.getNamedConfiguration('livetv').then(function (config) {\n                var info = config.ListingProviders.filter(function (i) {\n                    return i.Id === id;\n                })[0];\n                info.ZipCode = page.querySelector('.txtZipCode').value;\n                info.Country = $('#selectCountry', page).val();\n                info.ListingsId = selectedListingsId;\n                info.EnableAllTuners = page.querySelector('.chkAllTuners').checked;\n                info.EnabledTuners = info.EnableAllTuners ? [] : $('.chkTuner', page).get().filter(function (i) {\n                    return i.checked;\n                }).map(function (i) {\n                    return i.getAttribute('data-id');\n                });\n                ApiClient.ajax({\n                    type: 'POST',\n                    url: ApiClient.getUrl('LiveTv/ListingProviders', {\n                        ValidateListings: true\n                    }),\n                    data: JSON.stringify(info),\n                    contentType: 'application/json'\n                }).then(function (result) {\n                    loading.hide();\n\n                    if (options.showConfirmation) {\n                        Dashboard.processServerConfigurationUpdateResult();\n                    }\n\n                    Events.trigger(self, 'submitted');\n                }, function () {\n                    loading.hide();\n                    Dashboard.alert({\n                        message: globalize.translate('ErrorAddingListingsToSchedulesDirect')\n                    });\n                });\n            });\n        }\n\n        function refreshListings(value) {\n            if (!value) {\n                return void $('#selectListing', page).html('');\n            }\n\n            loading.show();\n            ApiClient.ajax({\n                type: 'GET',\n                url: ApiClient.getUrl('LiveTv/ListingProviders/Lineups', {\n                    Id: providerId,\n                    Location: value,\n                    Country: $('#selectCountry', page).val()\n                }),\n                dataType: 'json'\n            }).then(function (result) {\n                $('#selectListing', page).html(result.map(function (o) {\n                    return '<option value=\"' + o.Id + '\">' + o.Name + '</option>';\n                }));\n\n                if (listingsId) {\n                    $('#selectListing', page).val(listingsId);\n                }\n\n                loading.hide();\n            }, function (result) {\n                Dashboard.alert({\n                    message: globalize.translate('ErrorGettingTvLineups')\n                });\n                refreshListings('');\n                loading.hide();\n            });\n        }\n\n        function getTunerName(providerId) {\n            switch (providerId = providerId.toLowerCase()) {\n                case 'm3u':\n                    return 'M3U Playlist';\n                case 'hdhomerun':\n                    return 'HDHomerun';\n                case 'satip':\n                    return 'DVB';\n                default:\n                    return 'Unknown';\n            }\n        }\n\n        function refreshTunerDevices(page, providerInfo, devices) {\n            var html = '';\n\n            for (var i = 0, length = devices.length; i < length; i++) {\n                var device = devices[i];\n                html += '<div class=\"listItem\">';\n                var enabledTuners = providerInfo.EnabledTuners || [];\n                var isChecked = providerInfo.EnableAllTuners || -1 !== enabledTuners.indexOf(device.Id);\n                var checkedAttribute = isChecked ? ' checked' : '';\n                html += '<label class=\"checkboxContainer listItemCheckboxContainer\"><input type=\"checkbox\" is=\"emby-checkbox\" data-id=\"' + device.Id + '\" class=\"chkTuner\" ' + checkedAttribute + '/><span></span></label>';\n                html += '<div class=\"listItemBody two-line\">';\n                html += '<div class=\"listItemBodyText\">';\n                html += device.FriendlyName || getTunerName(device.Type);\n                html += '</div>';\n                html += '<div class=\"listItemBodyText secondary\">';\n                html += device.Url;\n                html += '</div>';\n                html += '</div>';\n                html += '</div>';\n            }\n\n            page.querySelector('.tunerList').innerHTML = html;\n        }\n\n        var listingsId;\n        var self = this;\n\n        self.submit = function () {\n            page.querySelector('.btnSubmitListingsContainer').click();\n        };\n\n        self.init = function () {\n            options = options || {};\n\n            // Only hide the buttons if explicitly set to false; default to showing if undefined or null\n            // FIXME: rename this option to clarify logic\n            var hideCancelButton = options.showCancelButton === false;\n            page.querySelector('.btnCancel').classList.toggle('hide', hideCancelButton);\n\n            var hideSubmitButton = options.showSubmitButton === false;\n            page.querySelector('.btnSubmitListings').classList.toggle('hide', hideSubmitButton);\n\n            $('.formLogin', page).on('submit', function () {\n                submitLoginForm();\n                return false;\n            });\n            $('.formListings', page).on('submit', function () {\n                submitListingsForm();\n                return false;\n            });\n            $('.txtZipCode', page).on('change', function () {\n                refreshListings(this.value);\n            });\n            page.querySelector('.chkAllTuners').addEventListener('change', function (e) {\n                if (e.target.checked) {\n                    page.querySelector('.selectTunersSection').classList.add('hide');\n                } else {\n                    page.querySelector('.selectTunersSection').classList.remove('hide');\n                }\n            });\n            $('.createAccountHelp', page).html(globalize.translate('MessageCreateAccountAt', '<a is=\"emby-linkbutton\" class=\"button-link\" href=\"http://www.schedulesdirect.org\" target=\"_blank\">http://www.schedulesdirect.org</a>'));\n            reload();\n        };\n    };\n});\n"]}