{"version":3,"sources":["components/playlisteditor/playlisteditor.js"],"names":["define","dom","shell","dialogHelper","loading","layoutManager","playbackManager","connectionManager","userSettings","appRouter","globalize","currentServerId","onSubmit","e","panel","parentWithClass","this","playlistId","querySelector","value","apiClient","getApiClient","set","addToPlaylist","dlg","id","itemIds","queue","serverId","ids","split","submitted","close","show","url","getUrl","Ids","userId","getCurrentUserId","ajax","type","then","hide","createPlaylist","Name","dataType","result","Id","redirectToPlaylist","showItem","preventDefault","triggerChange","select","dispatchEvent","CustomEvent","initEditor","content","options","items","addEventListener","classList","add","removeAttribute","remove","setAttribute","join","length","populatePlaylists","editorOptions","getItems","Recursive","IncludeItemTypes","SortBy","EnableTotalRecordCount","html","enableAddToPlayQueue","isPlaying","translate","Items","map","i","innerHTML","defaultValue","get","selectPlaylistToAddTo","centerFocus","elem","horiz","on","require","scrollHelper","fn","PlaylistEditor","prototype","dialogOptions","removeOnClose","scrollY","tv","size","createDialog","getEditorHtml","autoFocus","open","Promise","resolve","reject"],"mappings":"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","file":"playlisteditor.js","sourcesContent":["define(['dom', 'shell', 'dialogHelper', 'loading', 'layoutManager', 'playbackManager', 'connectionManager', 'userSettings', 'appRouter', 'globalize', 'emby-input', 'paper-icon-button-light', 'emby-select', 'material-icons', 'css!./../formdialog', 'emby-button'], function (dom, shell, dialogHelper, loading, layoutManager, playbackManager, connectionManager, userSettings, appRouter, globalize) {\n    'use strict';\n\n    var currentServerId;\n\n    function onSubmit(e) {\n        var panel = dom.parentWithClass(this, 'dialog');\n\n        var playlistId = panel.querySelector('#selectPlaylistToAddTo').value;\n        var apiClient = connectionManager.getApiClient(currentServerId);\n\n        if (playlistId) {\n            userSettings.set('playlisteditor-lastplaylistid', playlistId);\n            addToPlaylist(apiClient, panel, playlistId);\n        } else {\n            createPlaylist(apiClient, panel);\n        }\n\n        e.preventDefault();\n        return false;\n    }\n\n    function createPlaylist(apiClient, dlg) {\n        loading.show();\n\n        var url = apiClient.getUrl('Playlists', {\n            Name: dlg.querySelector('#txtNewPlaylistName').value,\n            Ids: dlg.querySelector('.fldSelectedItemIds').value || '',\n            userId: apiClient.getCurrentUserId()\n\n        });\n\n        apiClient.ajax({\n            type: 'POST',\n            url: url,\n            dataType: 'json'\n        }).then(function (result) {\n            loading.hide();\n\n            var id = result.Id;\n            dlg.submitted = true;\n            dialogHelper.close(dlg);\n            redirectToPlaylist(apiClient, id);\n        });\n    }\n\n    function redirectToPlaylist(apiClient, id) {\n        appRouter.showItem(id, apiClient.serverId());\n    }\n\n    function addToPlaylist(apiClient, dlg, id) {\n        var itemIds = dlg.querySelector('.fldSelectedItemIds').value || '';\n\n        if (id === 'queue') {\n            playbackManager.queue({\n                serverId: apiClient.serverId(),\n                ids: itemIds.split(',')\n            });\n            dlg.submitted = true;\n            dialogHelper.close(dlg);\n            return;\n        }\n\n        loading.show();\n\n        var url = apiClient.getUrl('Playlists/' + id + '/Items', {\n            Ids: itemIds,\n            userId: apiClient.getCurrentUserId()\n        });\n\n        apiClient.ajax({\n            type: 'POST',\n            url: url\n\n        }).then(function () {\n            loading.hide();\n\n            dlg.submitted = true;\n            dialogHelper.close(dlg);\n        });\n    }\n\n    function triggerChange(select) {\n        select.dispatchEvent(new CustomEvent('change', {}));\n    }\n\n    function populatePlaylists(editorOptions, panel) {\n        var select = panel.querySelector('#selectPlaylistToAddTo');\n\n        loading.hide();\n\n        panel.querySelector('.newPlaylistInfo').classList.add('hide');\n\n        var options = {\n            Recursive: true,\n            IncludeItemTypes: 'Playlist',\n            SortBy: 'SortName',\n            EnableTotalRecordCount: false\n        };\n\n        var apiClient = connectionManager.getApiClient(currentServerId);\n        apiClient.getItems(apiClient.getCurrentUserId(), options).then(function (result) {\n            var html = '';\n\n            if (editorOptions.enableAddToPlayQueue !== false && playbackManager.isPlaying()) {\n                html += '<option value=\"queue\">' + globalize.translate('AddToPlayQueue') + '</option>';\n            }\n\n            html += '<option value=\"\">' + globalize.translate('OptionNew') + '</option>';\n\n            html += result.Items.map(function (i) {\n                return '<option value=\"' + i.Id + '\">' + i.Name + '</option>';\n            });\n\n            select.innerHTML = html;\n\n            var defaultValue = editorOptions.defaultValue;\n            if (!defaultValue) {\n                defaultValue = userSettings.get('playlisteditor-lastplaylistid') || '';\n            }\n            select.value = defaultValue === 'new' ? '' : defaultValue;\n\n            // If the value is empty set it again, in case we tried to set a lastplaylistid that is no longer valid\n            if (!select.value) {\n                select.value = '';\n            }\n\n            triggerChange(select);\n\n            loading.hide();\n        });\n    }\n\n    function getEditorHtml(items) {\n        var html = '';\n\n        html += '<div class=\"formDialogContent smoothScrollY\" style=\"padding-top:2em;\">';\n        html += '<div class=\"dialogContentInner dialog-content-centered\">';\n        html += '<form style=\"margin:auto;\">';\n\n        html += '<div class=\"fldSelectPlaylist selectContainer\">';\n        var autoFocus = items.length ? ' autofocus' : '';\n        html += '<select is=\"emby-select\" id=\"selectPlaylistToAddTo\" label=\"' + globalize.translate('LabelPlaylist') + '\"' + autoFocus + '></select>';\n        html += '</div>';\n\n        html += '<div class=\"newPlaylistInfo\">';\n\n        html += '<div class=\"inputContainer\">';\n        autoFocus = items.length ? '' : ' autofocus';\n        html += '<input is=\"emby-input\" type=\"text\" id=\"txtNewPlaylistName\" required=\"required\" label=\"' + globalize.translate('LabelName') + '\"' + autoFocus + ' />';\n        html += '</div>';\n\n        // newPlaylistInfo\n        html += '</div>';\n\n        html += '<div class=\"formDialogFooter\">';\n        html += '<button is=\"emby-button\" type=\"submit\" class=\"raised btnSubmit block formDialogFooterItem button-submit\">' + globalize.translate('Add') + '</button>';\n        html += '</div>';\n\n        html += '<input type=\"hidden\" class=\"fldSelectedItemIds\" />';\n\n        html += '</form>';\n        html += '</div>';\n        html += '</div>';\n\n        return html;\n    }\n\n    function initEditor(content, options, items) {\n        content.querySelector('#selectPlaylistToAddTo').addEventListener('change', function () {\n            if (this.value) {\n                content.querySelector('.newPlaylistInfo').classList.add('hide');\n                content.querySelector('#txtNewPlaylistName').removeAttribute('required');\n            } else {\n                content.querySelector('.newPlaylistInfo').classList.remove('hide');\n                content.querySelector('#txtNewPlaylistName').setAttribute('required', 'required');\n            }\n        });\n\n        content.querySelector('form').addEventListener('submit', onSubmit);\n\n        content.querySelector('.fldSelectedItemIds', content).value = items.join(',');\n\n        if (items.length) {\n            content.querySelector('.fldSelectPlaylist').classList.remove('hide');\n            populatePlaylists(options, content);\n        } else {\n            content.querySelector('.fldSelectPlaylist').classList.add('hide');\n\n            var selectPlaylistToAddTo = content.querySelector('#selectPlaylistToAddTo');\n            selectPlaylistToAddTo.innerHTML = '';\n            selectPlaylistToAddTo.value = '';\n            triggerChange(selectPlaylistToAddTo);\n        }\n    }\n\n    function centerFocus(elem, horiz, on) {\n        require(['scrollHelper'], function (scrollHelper) {\n            var fn = on ? 'on' : 'off';\n            scrollHelper.centerFocus[fn](elem, horiz);\n        });\n    }\n\n    function PlaylistEditor() {\n\n    }\n\n    PlaylistEditor.prototype.show = function (options) {\n        var items = options.items || {};\n        currentServerId = options.serverId;\n\n        var dialogOptions = {\n            removeOnClose: true,\n            scrollY: false\n        };\n\n        if (layoutManager.tv) {\n            dialogOptions.size = 'fullscreen';\n        } else {\n            dialogOptions.size = 'small';\n        }\n\n        var dlg = dialogHelper.createDialog(dialogOptions);\n\n        dlg.classList.add('formDialog');\n\n        var html = '';\n        var title = globalize.translate('HeaderAddToPlaylist');\n\n        html += '<div class=\"formDialogHeader\">';\n        html += '<button is=\"paper-icon-button-light\" class=\"btnCancel autoSize\" tabindex=\"-1\"><span class=\"material-icons arrow_back\"></span></button>';\n        html += '<h3 class=\"formDialogHeaderTitle\">';\n        html += title;\n        html += '</h3>';\n\n        html += '</div>';\n\n        html += getEditorHtml(items);\n\n        dlg.innerHTML = html;\n\n        initEditor(dlg, options, items);\n\n        dlg.querySelector('.btnCancel').addEventListener('click', function () {\n            dialogHelper.close(dlg);\n        });\n\n        if (layoutManager.tv) {\n            centerFocus(dlg.querySelector('.formDialogContent'), false, true);\n        }\n\n        return dialogHelper.open(dlg).then(function () {\n            if (layoutManager.tv) {\n                centerFocus(dlg.querySelector('.formDialogContent'), false, false);\n            }\n\n            if (dlg.submitted) {\n                return Promise.resolve();\n            }\n\n            return Promise.reject();\n        });\n    };\n\n    return PlaylistEditor;\n});\n"]}