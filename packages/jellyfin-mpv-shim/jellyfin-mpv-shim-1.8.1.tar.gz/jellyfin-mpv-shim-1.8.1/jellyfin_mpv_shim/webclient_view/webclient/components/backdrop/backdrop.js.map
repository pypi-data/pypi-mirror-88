{"version":3,"sources":["components/backdrop/backdrop.js"],"names":["define","browser","connectionManager","playbackManager","dom","userSettings","Backdrop","backdropContainer","backgroundContainer","hasInternalBackdrop","hasExternalBackdrop","currentLoadingBackdrop","rotationInterval","getBackdropContainer","document","querySelector","createElement","classList","add","body","insertBefore","firstChild","clearBackdrop","clearAll","clearRotation","destroy","innerHTML","internalBackdrop","getBackgroundContainer","setBackgroundContainerBackgroundEnabled","remove","enabled","setBackdropImage","url","elem","existingBackdropImage","getAttribute","instance","load","getItemImageUrls","item","imageOptions","apiClient","getApiClient","ServerId","BackdropImageTags","length","map","imgTag","index","getScaledImageUrl","BackdropItemId","Id","Object","assign","type","tag","maxWidth","getScreenWidth","ParentBackdropItemId","ParentBackdropImageTags","getImageUrls","items","list","onImg","img","push","i","forEach","prototype","parent","Image","self","this","onload","isDestroyed","backdropImage","style","backgroundImage","setAttribute","appendChild","enableAnimation","slow","parentNode","removeChild","addEventListener","whichAnimationEvent","onAnimationComplete","removeEventListener","once","currentAnimatingElement","src","cancelAnimation","currentRotatingImages","currentRotationIndex","onRotationInterval","isPlayingLocally","newIndex","clearInterval","setBackdrops","enableImageRotation","enableBackdrops","images","startRotation","arraysEqual","a","b","enableRotation","tv","firefox","setInterval","setBackdrop","clear","externalBackdrop"],"mappings":"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","file":"backdrop.js","sourcesContent":["define(['browser', 'connectionManager', 'playbackManager', 'dom', 'userSettings', 'css!./backdrop'], function (browser, connectionManager, playbackManager, dom, userSettings) {\n    'use strict';\n\n    function enableAnimation(elem) {\n        if (browser.slow) {\n            return false;\n        }\n\n        return true;\n    }\n\n    function enableRotation() {\n        if (browser.tv) {\n            return false;\n        }\n\n        // Causes high cpu usage\n        if (browser.firefox) {\n            return false;\n        }\n\n        return true;\n    }\n\n    function Backdrop() {\n    }\n\n    Backdrop.prototype.load = function (url, parent, existingBackdropImage) {\n        var img = new Image();\n        var self = this;\n\n        img.onload = function () {\n            if (self.isDestroyed) {\n                return;\n            }\n\n            var backdropImage = document.createElement('div');\n            backdropImage.classList.add('backdropImage');\n            backdropImage.classList.add('displayingBackdropImage');\n            backdropImage.style.backgroundImage = \"url('\" + url + \"')\";\n            backdropImage.setAttribute('data-url', url);\n\n            backdropImage.classList.add('backdropImageFadeIn');\n            parent.appendChild(backdropImage);\n\n            if (!enableAnimation(backdropImage)) {\n                if (existingBackdropImage && existingBackdropImage.parentNode) {\n                    existingBackdropImage.parentNode.removeChild(existingBackdropImage);\n                }\n                internalBackdrop(true);\n                return;\n            }\n\n            var onAnimationComplete = function () {\n                dom.removeEventListener(backdropImage, dom.whichAnimationEvent(), onAnimationComplete, {\n                    once: true\n                });\n                if (backdropImage === self.currentAnimatingElement) {\n                    self.currentAnimatingElement = null;\n                }\n                if (existingBackdropImage && existingBackdropImage.parentNode) {\n                    existingBackdropImage.parentNode.removeChild(existingBackdropImage);\n                }\n            };\n\n            dom.addEventListener(backdropImage, dom.whichAnimationEvent(), onAnimationComplete, {\n                once: true\n            });\n\n            internalBackdrop(true);\n        };\n\n        img.src = url;\n    };\n\n    Backdrop.prototype.cancelAnimation = function () {\n        var elem = this.currentAnimatingElement;\n        if (elem) {\n            elem.classList.remove('backdropImageFadeIn');\n            this.currentAnimatingElement = null;\n        }\n    };\n\n    Backdrop.prototype.destroy = function () {\n        this.isDestroyed = true;\n        this.cancelAnimation();\n    };\n\n    var backdropContainer;\n    function getBackdropContainer() {\n        if (!backdropContainer) {\n            backdropContainer = document.querySelector('.backdropContainer');\n        }\n\n        if (!backdropContainer) {\n            backdropContainer = document.createElement('div');\n            backdropContainer.classList.add('backdropContainer');\n            document.body.insertBefore(backdropContainer, document.body.firstChild);\n        }\n\n        return backdropContainer;\n    }\n\n    function clearBackdrop(clearAll) {\n        clearRotation();\n\n        if (currentLoadingBackdrop) {\n            currentLoadingBackdrop.destroy();\n            currentLoadingBackdrop = null;\n        }\n\n        var elem = getBackdropContainer();\n        elem.innerHTML = '';\n\n        if (clearAll) {\n            hasExternalBackdrop = false;\n        }\n\n        internalBackdrop(false);\n    }\n\n    var backgroundContainer;\n    function getBackgroundContainer() {\n        if (!backgroundContainer) {\n            backgroundContainer = document.querySelector('.backgroundContainer');\n        }\n        return backgroundContainer;\n    }\n\n    function setBackgroundContainerBackgroundEnabled() {\n        if (hasInternalBackdrop || hasExternalBackdrop) {\n            getBackgroundContainer().classList.add('withBackdrop');\n        } else {\n            getBackgroundContainer().classList.remove('withBackdrop');\n        }\n    }\n\n    var hasInternalBackdrop;\n    function internalBackdrop(enabled) {\n        hasInternalBackdrop = enabled;\n        setBackgroundContainerBackgroundEnabled();\n    }\n\n    var hasExternalBackdrop;\n    function externalBackdrop(enabled) {\n        hasExternalBackdrop = enabled;\n        setBackgroundContainerBackgroundEnabled();\n    }\n\n    function getRandom(min, max) {\n        return Math.floor(Math.random() * (max - min) + min);\n    }\n\n    var currentLoadingBackdrop;\n    function setBackdropImage(url) {\n        if (currentLoadingBackdrop) {\n            currentLoadingBackdrop.destroy();\n            currentLoadingBackdrop = null;\n        }\n\n        var elem = getBackdropContainer();\n        var existingBackdropImage = elem.querySelector('.displayingBackdropImage');\n\n        if (existingBackdropImage && existingBackdropImage.getAttribute('data-url') === url) {\n            if (existingBackdropImage.getAttribute('data-url') === url) {\n                return;\n            }\n            existingBackdropImage.classList.remove('displayingBackdropImage');\n        }\n\n        var instance = new Backdrop();\n        instance.load(url, elem, existingBackdropImage);\n        currentLoadingBackdrop = instance;\n    }\n\n    function getItemImageUrls(item, imageOptions) {\n        imageOptions = imageOptions || {};\n\n        var apiClient = connectionManager.getApiClient(item.ServerId);\n        if (item.BackdropImageTags && item.BackdropImageTags.length > 0) {\n            return item.BackdropImageTags.map(function (imgTag, index) {\n                return apiClient.getScaledImageUrl(item.BackdropItemId || item.Id, Object.assign(imageOptions, {\n                    type: 'Backdrop',\n                    tag: imgTag,\n                    maxWidth: dom.getScreenWidth(),\n                    index: index\n                }));\n            });\n        }\n\n        if (item.ParentBackdropItemId && item.ParentBackdropImageTags && item.ParentBackdropImageTags.length) {\n            return item.ParentBackdropImageTags.map(function (imgTag, index) {\n                return apiClient.getScaledImageUrl(item.ParentBackdropItemId, Object.assign(imageOptions, {\n                    type: 'Backdrop',\n                    tag: imgTag,\n                    maxWidth: dom.getScreenWidth(),\n                    index: index\n                }));\n            });\n        }\n\n        return [];\n    }\n\n    function getImageUrls(items, imageOptions) {\n        var list = [];\n        var onImg = function (img) {\n            list.push(img);\n        };\n\n        for (var i = 0, length = items.length; i < length; i++) {\n            var itemImages = getItemImageUrls(items[i], imageOptions);\n            itemImages.forEach(onImg);\n        }\n\n        return list;\n    }\n\n    function arraysEqual(a, b) {\n        if (a === b) {\n            return true;\n        }\n        if (a == null || b == null) {\n            return false;\n        }\n        if (a.length !== b.length) {\n            return false;\n        }\n\n        // If you don't care about the order of the elements inside\n        // the array, you should sort both arrays here.\n        for (var i = 0; i < a.length; ++i) {\n            if (a[i] !== b[i]) {\n                return false;\n            }\n        }\n\n        return true;\n    }\n\n    function enabled() {\n        return userSettings.enableBackdrops();\n    }\n\n    var rotationInterval;\n    var currentRotatingImages = [];\n    var currentRotationIndex = -1;\n    function setBackdrops(items, imageOptions, enableImageRotation) {\n        if (enabled()) {\n            var images = getImageUrls(items, imageOptions);\n\n            if (images.length) {\n                startRotation(images, enableImageRotation);\n            } else {\n                clearBackdrop();\n            }\n        }\n    }\n\n    function startRotation(images, enableImageRotation) {\n        if (arraysEqual(images, currentRotatingImages)) {\n            return;\n        }\n\n        clearRotation();\n\n        currentRotatingImages = images;\n        currentRotationIndex = -1;\n\n        if (images.length > 1 && enableImageRotation !== false && enableRotation()) {\n            rotationInterval = setInterval(onRotationInterval, 24000);\n        }\n\n        onRotationInterval();\n    }\n\n    function onRotationInterval() {\n        if (playbackManager.isPlayingLocally(['Video'])) {\n            return;\n        }\n\n        var newIndex = currentRotationIndex + 1;\n        if (newIndex >= currentRotatingImages.length) {\n            newIndex = 0;\n        }\n\n        currentRotationIndex = newIndex;\n        setBackdropImage(currentRotatingImages[newIndex]);\n    }\n\n    function clearRotation() {\n        var interval = rotationInterval;\n        if (interval) {\n            clearInterval(interval);\n        }\n\n        rotationInterval = null;\n        currentRotatingImages = [];\n        currentRotationIndex = -1;\n    }\n\n    function setBackdrop(url, imageOptions) {\n        if (url && typeof url !== 'string') {\n            url = getImageUrls([url], imageOptions)[0];\n        }\n\n        if (url) {\n            clearRotation();\n            setBackdropImage(url);\n        } else {\n            clearBackdrop();\n        }\n    }\n\n    return {\n        setBackdrops: setBackdrops,\n        setBackdrop: setBackdrop,\n        clear: clearBackdrop,\n        externalBackdrop: externalBackdrop\n    };\n});\n"]}