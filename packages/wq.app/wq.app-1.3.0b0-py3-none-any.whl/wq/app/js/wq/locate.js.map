{"version":3,"file":"locate.js","sources":["../../../packages/leaflet/src/locate.js"],"sourcesContent":["import L from 'leaflet';\n\n// Exported module object\nvar locate = {\n    name: 'locate',\n    config: {\n        fieldNames: {\n            latitude: 'latitude',\n            longitude: 'longitude',\n            geometry: 'geometry',\n            accuracy: 'accuracy',\n            toggle: 'toggle',\n            mode: 'mode',\n            source: 'source'\n        }\n    }\n};\n\nlocate.init = function (conf) {\n    L.extend(locate.config, conf || {});\n};\n\nlocate.locators = {};\n\n// wq/app.js plugin\nlocate.run = function ($page, routeInfo) {\n    if (!routeInfo.page_config.locate) {\n        return;\n    }\n    var map = locate.app.plugins.map.getMap(routeInfo),\n        mapId = locate.app.plugins.map.getMapId(routeInfo);\n    if (!map) {\n        return;\n    }\n    var fields = {};\n    for (var field in locate.config.fieldNames) {\n        var name = locate.config.fieldNames[field];\n        fields[field] = $page.find('[name=' + name + ']');\n    }\n    var locator = locate.locator(map, fields, locate.config);\n    $page.on('pagehide', function () {\n        locator.stop();\n    });\n    locate.locators[mapId] = locator;\n};\n\n// Interactive GPS & map-based locator tool\n// map should be an L.map; fields should be an map of keys to jQuery-wrapped\n// <input>s\nlocate.Locator = function (map, fields, opts) {\n    var self = this;\n\n    if (!fields) {\n        fields = {};\n    }\n    if (!opts) {\n        opts = {};\n    }\n    if (!opts.precision) {\n        opts.precision = 6;\n    }\n\n    var _mode, _marker, _circle, _lastSource, _hasSource;\n\n    // Mode switching functions (define fields.toggle for default usage)\n    self.setMode = function (mode) {\n        if (!mode || !self[mode + 'Start']) {\n            return;\n        }\n        self.stop();\n        _mode = mode;\n        self.start();\n        if (opts.onSetMode) {\n            opts.onSetMode(mode);\n        }\n    };\n\n    self.start = function () {\n        if (_mode) {\n            self[_mode + 'Start']();\n        }\n    };\n\n    self.stop = function () {\n        if (_mode) {\n            self[_mode + 'Stop']();\n        }\n    };\n\n    // GPS mode\n    self.gpsStart = function () {\n        var locateOpts = {\n            enableHighAccuracy: true,\n            watch: true,\n            setView: true,\n            timeout: 60 * 1000\n        };\n        map.off('locationfound');\n        map.off('locationerror');\n        map.on('locationfound', success);\n        map.on('locationerror', error);\n        map.locate(locateOpts);\n        function success(evt) {\n            self.update(evt.latlng, evt.accuracy, _lastSource);\n        }\n        function error(evt) {\n            self.onerror(evt);\n        }\n    };\n\n    self.gpsStop = function () {\n        map.stopLocate();\n    };\n\n    // Interactive mode\n    self.interactiveStart = function () {\n        L.DomUtil.addClass(map._container, 'interactive');\n    };\n\n    self.interactiveStop = function () {\n        L.DomUtil.removeClass(map._container, 'interactive');\n    };\n\n    // Manual mode\n    self.manualStart = function () {\n        if (!fields.latitude || !fields.longitude) {\n            return;\n        }\n        fields.latitude.attr('readonly', false);\n        fields.longitude.attr('readonly', false);\n    };\n\n    self.manualStop = function () {\n        fields.latitude.attr('readonly', true);\n        fields.longitude.attr('readonly', true);\n    };\n\n    // Default Circle & Marker generators, override to customize\n    self.makeCircle = function () {\n        return L.circle([0, 0], 1, { weight: 1 });\n    };\n\n    self.makeMarker = function () {\n        return L.marker([0, 0]);\n    };\n\n    // Display and save updates to location\n    self.update = function (loc, accuracy, source) {\n        if (!_marker) {\n            _marker = self.makeMarker().addTo(map);\n        }\n        if (!_circle) {\n            _circle = self.makeCircle().addTo(map);\n        }\n        // Update display\n        _marker.setLatLng(loc);\n        _circle.setLatLng(loc).setRadius(accuracy);\n\n        // Save to fields\n        if (fields) {\n            if (fields.latitude) {\n                fields.latitude.val(L.Util.formatNum(loc.lat, opts.precision));\n            }\n            if (fields.longitude) {\n                fields.longitude.val(L.Util.formatNum(loc.lng, opts.precision));\n            }\n            if (fields.geometry) {\n                fields.geometry.val(\n                    JSON.stringify({\n                        type: 'Point',\n                        coordinates: [loc.lng, loc.lat]\n                    })\n                );\n            }\n            if (fields.accuracy) {\n                fields.accuracy.val(accuracy);\n            }\n            if (fields.mode) {\n                fields.mode.val(_mode);\n            }\n            if (fields.source && _hasSource) {\n                var sourceInfo;\n                if (!source) {\n                    source = {};\n                }\n                if (source.type == 'external') {\n                    sourceInfo = source.identifier;\n                } else if (source.type == 'internal') {\n                    sourceInfo = 'Device Location Services';\n                } else {\n                    sourceInfo = source.type || 'Unknown';\n                }\n                if (source.typeIsGuess) {\n                    sourceInfo += ' (guess)';\n                }\n                fields.source.val(sourceInfo);\n            }\n        }\n\n        // User-defined callback (FIXME: make event?)\n        if (opts.onUpdate) {\n            opts.onUpdate(loc, accuracy);\n        }\n    };\n\n    self.onerror = function (evt) {\n        if (window.console) {\n            window.console.log('Error retrieving coordinates!');\n        }\n        if (opts.onError) {\n            opts.onError(evt);\n        }\n    };\n\n    // Respond to map clicks in interactive mode\n    function _clickMap(evt) {\n        if (_mode != 'interactive') {\n            return;\n        }\n        // Estimate accuracy based on viewport information\n        // (higher zoom = better accuracy)\n        var ll = map.getBounds();\n        var px = map.getPixelBounds();\n        var distance = ll.getNorthWest().distanceTo(ll.getSouthWest());\n        var height = px.getSize().y;\n\n        // Assume accuracy is equivalent to the real-world length represented\n        // by 2 pixels\n        var accuracy = L.Util.formatNum((distance / height) * 2, 3);\n\n        self.update(evt.latlng, accuracy);\n    }\n\n    function _updateManual() {\n        if (_mode != 'manual') {\n            return;\n        }\n        self.update(\n            L.latLng(fields.latitude.val(), fields.longitude.val()),\n            null\n        );\n    }\n\n    function _getVal($input) {\n        if ($input.is('select')) {\n            return $input.val();\n        } else if ($input.is('input[type=radio]')) {\n            return $input.filter(':checked').val();\n        }\n        return null;\n    }\n\n    // Leaflet events\n    map.on('click', _clickMap);\n\n    // Detect cordova-plugin-bluetooth-geolocation\n    _hasSource = navigator.geolocation && navigator.geolocation.hasSource;\n    if (_hasSource) {\n        map._handleGeolocationResponse = function (pos) {\n            _lastSource = pos.source;\n            L.Map.prototype._handleGeolocationResponse.call(map, pos);\n        };\n    }\n\n    // jQuery Events\n    if (fields.toggle) {\n        fields.toggle.on('click', function () {\n            self.setMode(_getVal(fields.toggle));\n        });\n        self.setMode(_getVal(fields.toggle));\n    }\n\n    if (fields.latitude && fields.longitude) {\n        fields.latitude.on('change', _updateManual);\n        fields.longitude.on('change', _updateManual);\n    }\n};\n\n// Leaflet-style generator function\nlocate.locator = function (map, fields, opts) {\n    return new locate.Locator(map, fields, opts);\n};\n\nexport default locate;\n"],"names":["locate","name","config","fieldNames","latitude","longitude","geometry","accuracy","toggle","mode","source","init","conf","L","extend","locators","run","$page","routeInfo","page_config","map","app","plugins","getMap","mapId","getMapId","fields","field","find","locator","on","stop","Locator","opts","self","precision","_mode","_marker","_circle","_lastSource","_hasSource","setMode","start","onSetMode","gpsStart","locateOpts","enableHighAccuracy","watch","setView","timeout","off","success","error","evt","update","latlng","onerror","gpsStop","stopLocate","interactiveStart","DomUtil","addClass","_container","interactiveStop","removeClass","manualStart","attr","manualStop","makeCircle","circle","weight","makeMarker","marker","loc","addTo","setLatLng","setRadius","val","Util","formatNum","lat","lng","JSON","stringify","type","coordinates","sourceInfo","identifier","typeIsGuess","onUpdate","window","console","log","onError","_clickMap","ll","getBounds","px","getPixelBounds","distance","getNorthWest","distanceTo","getSouthWest","height","getSize","y","_updateManual","latLng","_getVal","$input","is","filter","navigator","geolocation","hasSource","_handleGeolocationResponse","pos","Map","prototype","call"],"mappings":"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"}