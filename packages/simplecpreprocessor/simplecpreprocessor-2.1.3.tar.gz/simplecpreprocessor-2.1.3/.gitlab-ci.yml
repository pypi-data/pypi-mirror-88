image: debian:10

variables:
  FLIT_ROOT_INSTALL: 1

stages:
- test
- deploy

before_script:
  - PATH=$PATH:~/.local/bin
  - apt update
  - apt install -y git python3-pip
  - python3 -m pip install --upgrade flit pip wheel setuptools
  - |
    SOURCE_DATE_EPOCH=`git show -s --format=%ct`
    export SOURCE_DATE_EPOCH
    VERSION=$(git describe --tags|perl -lpe 's/^v(\d+(?:\.\d+)+)-(\d+)-[^-]+$/$1.dev$2/')
    echo "__version__ = \"$VERSION\"" > simplecpreprocessor/version.py

test:
  stage: test
  interruptible: true
  script:
  - flit build
  - flit install
  - flake8 simplecpreprocessor
  - py.test -v --cov=simplecpreprocessor --cov-config .coveragerc --cov-report=html
  except:
  - tags
  artifacts:
    when: always
    paths:
      - ${CI_PROJECT_DIR}/htmlcov

deploy:
  stage: deploy
  script:
  - flit build
  - flit publish
  only:
  - tags
