

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Fleur self-consistency field workflow &mdash; AiiDA-FLEUR 1.1.3 documentation</title>
  

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/theme_overrides.css" type="text/css" />

  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    
    <link rel="search" type="application/opensearchdescription+xml"
          title="Search within AiiDA-FLEUR 1.1.3 documentation"
          href="../../_static/opensearch.xml"/>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Fleur equation of states (eos) workflow" href="eos_wc.html" />
    <link rel="prev" title="Fleur base restart workchain" href="base_wc.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home" alt="Documentation Home"> AiiDA-FLEUR
          

          
          </a>

          
            
            
              <div class="version">
                1.1
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="../ug_index.html">User’s guide</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../getting_started/getting_started.html">Getting started</a></li>
<li class="toctree-l2"><a class="reference internal" href="../data/fleur_data_plugins.html">AiiDA-FLEUR Data Plugins</a></li>
<li class="toctree-l2"><a class="reference internal" href="../calculations/fleur_calculation_plugins.html">AiiDA-FLEUR Calculations</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="wc_index.html">AiiDA-FLEUR WorkChains</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="wc_index.html#general-design">General design</a></li>
<li class="toctree-l3 current"><a class="reference internal" href="wc_index.html#workchain-classification">Workchain classification</a><ul class="current">
<li class="toctree-l4 current"><a class="reference internal" href="wc_index.html#basic-technical-workchains">Basic (Technical) Workchains</a></li>
<li class="toctree-l4"><a class="reference internal" href="wc_index.html#more-advanced-scientific-workchains">More advanced (Scientific) Workchains</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../cmd/cmd_index.html">Verdi command line extentions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../tools/tools_index.html">Tools</a></li>
<li class="toctree-l2"><a class="reference internal" href="../tutorials/tutorials.html">Tutorials</a></li>
<li class="toctree-l2"><a class="reference internal" href="../hints/hints_faq.html">Hints</a></li>
<li class="toctree-l2"><a class="reference internal" href="../hints/exit_codes.html">Exit codes</a></li>
</ul>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../devel_guide/dg_index.html">Developer’s guide</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../module_guide/mg_index.html">Source code Documentation (API reference)</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">AiiDA-FLEUR</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../ug_index.html">User’s guide</a> &raquo;</li>
        
          <li><a href="wc_index.html">AiiDA-FLEUR WorkChains</a> &raquo;</li>
        
      <li>Fleur self-consistency field workflow</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="fleur-self-consistency-field-workflow">
<span id="scf-wc"></span><h1><a class="toc-backref" href="#id1">Fleur self-consistency field workflow</a><a class="headerlink" href="#fleur-self-consistency-field-workflow" title="Permalink to this headline">¶</a></h1>
<ul class="simple">
<li><p><strong>Current version</strong>: 0.4.0</p></li>
<li><p><strong>Class</strong>: <a class="reference internal" href="../../module_guide/code.html#aiida_fleur.workflows.scf.FleurScfWorkChain" title="aiida_fleur.workflows.scf.FleurScfWorkChain"><code class="xref py py-class docutils literal notranslate"><span class="pre">FleurScfWorkChain</span></code></a></p></li>
<li><p><strong>String to pass to the</strong> <a class="reference external" href="https://aiida-core.readthedocs.io/en/latest/reference/apidoc/aiida.plugins.html#aiida.plugins.WorkflowFactory" title="(in AiiDA v1.5)"><code class="xref py py-func docutils literal notranslate"><span class="pre">WorkflowFactory()</span></code></a>: <code class="docutils literal notranslate"><span class="pre">fleur.scf</span></code></p></li>
<li><p><strong>Workflow type</strong>: Technical</p></li>
<li><p><strong>Aim</strong>: Manage FLEUR SCF convergence</p></li>
<li><p><strong>Computational demand</strong>: Corresponding to several <code class="docutils literal notranslate"><span class="pre">FleurCalculation</span></code></p></li>
<li><p><strong>Database footprint</strong>: Output node with information, full provenance, <code class="docutils literal notranslate"><span class="pre">~</span> <span class="pre">10+10*FLEUR</span> <span class="pre">Jobs</span></code> nodes</p></li>
<li><p><strong>File repository footprint</strong>: no addition to the <code class="docutils literal notranslate"><span class="pre">CalcJob</span></code> run</p></li>
</ul>
<div class="contents topic" id="contents">
<p class="topic-title">Contents</p>
<ul class="simple">
<li><p><a class="reference internal" href="#fleur-self-consistency-field-workflow" id="id1">Fleur self-consistency field workflow</a></p>
<ul>
<li><p><a class="reference internal" href="#description-purpose" id="id2">Description/Purpose</a></p></li>
<li><p><a class="reference internal" href="#input-nodes" id="id3">Input nodes</a></p>
<ul>
<li><p><a class="reference internal" href="#workchain-parameters-and-its-defaults" id="id4">Workchain parameters and its defaults</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#returns-nodes" id="id5">Returns nodes</a></p></li>
<li><p><a class="reference internal" href="#layout" id="id6">Layout</a></p></li>
<li><p><a class="reference internal" href="#error-handling" id="id7">Error handling</a></p></li>
<li><p><a class="reference internal" href="#plot-fleur-visualization" id="id8">Plot_fleur visualization</a></p></li>
<li><p><a class="reference internal" href="#database-node-graph" id="id9">Database Node graph</a></p></li>
<li><p><a class="reference internal" href="#example-usage" id="id10">Example usage</a></p></li>
</ul>
</li>
</ul>
</div>
<p>Import Example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">aiida_fleur.workflows.scf</span> <span class="kn">import</span> <span class="n">FleurScfWorkChain</span>
<span class="c1">#or</span>
<span class="n">WorkflowFactory</span><span class="p">(</span><span class="s1">&#39;fleur.scf&#39;</span><span class="p">)</span>
</pre></div>
</div>
<div class="section" id="description-purpose">
<h2><a class="toc-backref" href="#id2">Description/Purpose</a><a class="headerlink" href="#description-purpose" title="Permalink to this headline">¶</a></h2>
<p>Converges the charge <em>density</em>, the <em>total energy</em> or the <em>largest force</em> of a given structure,
or stops because the maximum allowed retries are reached.</p>
<p>The workchain is designed to converge only one parameter independently on other parameters
(<em>largest force</em> is an exception because FLEUR code first checks if density was converged).
Simultaneous convergence of two or three parameters is not implemented to simplify the
code logic and because one almost always interested in a particular parameter. Moreover,
it was shown that the total energy tend to converge faster than the charge density.</p>
<p>This workflow manages an inpgen calculation (if needed) and several Fleur calculations.
It is one of the most core workchains and often deployed as a sub-workflow.</p>
</div>
<div class="section" id="input-nodes">
<h2><a class="toc-backref" href="#id3">Input nodes</a><a class="headerlink" href="#input-nodes" title="Permalink to this headline">¶</a></h2>
<p>The table below shows all the possible input nodes of the SCF workchain.</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 14%" />
<col style="width: 43%" />
<col style="width: 34%" />
<col style="width: 8%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>name</p></th>
<th class="head"><p>type</p></th>
<th class="head"><p>description</p></th>
<th class="head"><p>required</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>fleur</p></td>
<td><p><a class="reference external" href="https://aiida-core.readthedocs.io/en/latest/reference/apidoc/aiida.orm.html#aiida.orm.Code" title="(in AiiDA v1.5)"><code class="xref py py-class docutils literal notranslate"><span class="pre">Code</span></code></a></p></td>
<td><p>Fleur code</p></td>
<td><p>yes</p></td>
</tr>
<tr class="row-odd"><td><p>inpgen</p></td>
<td><p><a class="reference external" href="https://aiida-core.readthedocs.io/en/latest/reference/apidoc/aiida.orm.html#aiida.orm.Code" title="(in AiiDA v1.5)"><code class="xref py py-class docutils literal notranslate"><span class="pre">Code</span></code></a></p></td>
<td><p>Inpgen code</p></td>
<td><p>no</p></td>
</tr>
<tr class="row-even"><td><p>wf_parameters</p></td>
<td><p><a class="reference external" href="https://aiida-core.readthedocs.io/en/latest/reference/apidoc/aiida.orm.html#aiida.orm.Dict" title="(in AiiDA v1.5)"><code class="xref py py-class docutils literal notranslate"><span class="pre">Dict</span></code></a></p></td>
<td><p>Settings of the workchain</p></td>
<td><p>no</p></td>
</tr>
<tr class="row-odd"><td><p>structure</p></td>
<td><p><a class="reference external" href="https://aiida-core.readthedocs.io/en/latest/reference/apidoc/aiida.orm.html#aiida.orm.StructureData" title="(in AiiDA v1.5)"><code class="xref py py-class docutils literal notranslate"><span class="pre">StructureData</span></code></a></p></td>
<td><p>Structure data node</p></td>
<td><p>no</p></td>
</tr>
<tr class="row-even"><td><p>calc_parameters</p></td>
<td><p><a class="reference external" href="https://aiida-core.readthedocs.io/en/latest/reference/apidoc/aiida.orm.html#aiida.orm.Dict" title="(in AiiDA v1.5)"><code class="xref py py-class docutils literal notranslate"><span class="pre">Dict</span></code></a></p></td>
<td><p>inpgen <a class="reference internal" href="#scf-wc-layout"><span class="std std-ref">parameters</span></a></p></td>
<td><p>no</p></td>
</tr>
<tr class="row-odd"><td><p>fleurinp</p></td>
<td><p><a class="reference internal" href="../../module_guide/code.html#aiida_fleur.data.fleurinp.FleurinpData" title="aiida_fleur.data.fleurinp.FleurinpData"><code class="xref py py-class docutils literal notranslate"><span class="pre">FleurinpData</span></code></a></p></td>
<td><p><a class="reference internal" href="../data/fleurinp_data.html#fleurinp-data"><span class="std std-ref">FLEUR input</span></a></p></td>
<td><p>no</p></td>
</tr>
<tr class="row-even"><td><p>remote_data</p></td>
<td><p><a class="reference external" href="https://aiida-core.readthedocs.io/en/latest/reference/apidoc/aiida.orm.html#aiida.orm.RemoteData" title="(in AiiDA v1.5)"><code class="xref py py-class docutils literal notranslate"><span class="pre">RemoteData</span></code></a></p></td>
<td><p>Remote folder of another calculation</p></td>
<td><p>no</p></td>
</tr>
<tr class="row-odd"><td><p>options</p></td>
<td><p><a class="reference external" href="https://aiida-core.readthedocs.io/en/latest/reference/apidoc/aiida.orm.html#aiida.orm.Dict" title="(in AiiDA v1.5)"><code class="xref py py-class docutils literal notranslate"><span class="pre">Dict</span></code></a></p></td>
<td><p>AiiDA options (computational resources)</p></td>
<td><p>no</p></td>
</tr>
<tr class="row-even"><td><p>settings</p></td>
<td><p><a class="reference external" href="https://aiida-core.readthedocs.io/en/latest/reference/apidoc/aiida.orm.html#aiida.orm.Dict" title="(in AiiDA v1.5)"><code class="xref py py-class docutils literal notranslate"><span class="pre">Dict</span></code></a></p></td>
<td><p>Special <a class="reference internal" href="../data/fleurinp_data.html#fleurinp-data"><span class="std std-ref">settings</span></a>
for Fleur calculation</p></td>
<td><p>no</p></td>
</tr>
</tbody>
</table>
<p>Only <code class="docutils literal notranslate"><span class="pre">fleur</span></code> input is required. However, it does not mean that it is enough to specify <code class="docutils literal notranslate"><span class="pre">fleur</span></code>
only. One <em>must</em> keep one of the supported input configurations described in the
<a class="reference internal" href="#scf-wc-layout"><span class="std std-ref">Layout</span></a> section.</p>
<div class="section" id="workchain-parameters-and-its-defaults">
<h3><a class="toc-backref" href="#id4">Workchain parameters and its defaults</a><a class="headerlink" href="#workchain-parameters-and-its-defaults" title="Permalink to this headline">¶</a></h3>
<blockquote>
<div><ul>
<li><p><code class="docutils literal notranslate"><span class="pre">wf_parameters</span></code>: <a class="reference external" href="https://aiida-core.readthedocs.io/en/latest/reference/apidoc/aiida.orm.html#aiida.orm.Dict" title="(in AiiDA v1.5)"><code class="xref py py-class docutils literal notranslate"><span class="pre">Dict</span></code></a> - Settings of the workflow behavior. All possible
keys and their defaults are listed below:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="s1">&#39;fleur_runmax&#39;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span>                   <span class="c1"># Maximum number of fleur jobs/starts</span>
<span class="s1">&#39;density_converged&#39;</span><span class="p">:</span> <span class="mf">0.00002</span><span class="p">,</span>        <span class="c1"># Charge density convergence criterion</span>
<span class="s1">&#39;energy_converged&#39;</span><span class="p">:</span> <span class="mf">0.002</span><span class="p">,</span>           <span class="c1"># Total energy convergence criterion</span>
<span class="s1">&#39;force_converged&#39;</span><span class="p">:</span> <span class="mf">0.002</span><span class="p">,</span>            <span class="c1"># Largest force convergence criterion</span>
<span class="s1">&#39;mode&#39;</span><span class="p">:</span> <span class="s1">&#39;density&#39;</span><span class="p">,</span>                   <span class="c1"># Parameter to converge: &#39;density&#39;, &#39;force&#39; or &#39;energy&#39;</span>
<span class="s1">&#39;serial&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>                     <span class="c1"># Execute fleur with mpi or without</span>
<span class="s1">&#39;only_even_MPI&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>              <span class="c1"># True if suppress parallelisation having odd number of MPI</span>
<span class="s1">&#39;itmax_per_run&#39;</span><span class="p">:</span> <span class="mi">30</span><span class="p">,</span>                 <span class="c1"># Maximum iterations run for one FleurCalculation</span>
<span class="s1">&#39;force_dict&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;qfix&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>            <span class="c1"># parameters required for the &#39;force&#39; mode</span>
               <span class="s1">&#39;forcealpha&#39;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">,</span>
               <span class="s1">&#39;forcemix&#39;</span><span class="p">:</span> <span class="s1">&#39;BFGS&#39;</span><span class="p">},</span>
<span class="s1">&#39;inpxml_changes&#39;</span><span class="p">:</span> <span class="p">[],</span>                <span class="c1"># Modifications to inp.xml</span>
</pre></div>
</div>
<p><strong>‘force_dict’</strong> contains parameters that will be inserted into the <code class="docutils literal notranslate"><span class="pre">inp.xml</span></code> in case of
force convergence mode. Usually this sub-dictionary does not affect the convergence, it affects
only the generation of <code class="docutils literal notranslate"><span class="pre">relax.xml</span></code> file. Read more in <a class="reference external" href="https://www.flapw.de/site/xml-inp/#structure-relaxations-with-fleur">FLEUR relaxation</a> documentation.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Only one of <code class="docutils literal notranslate"><span class="pre">density_converged</span></code>, <code class="docutils literal notranslate"><span class="pre">energy_converged</span></code> or <code class="docutils literal notranslate"><span class="pre">force_converged</span></code>
is used by the workchain that corresponds to the <strong>‘mode’</strong>. The other two are ignored.
Exception: force mode uses both <code class="docutils literal notranslate"><span class="pre">density_converged</span></code> and <code class="docutils literal notranslate"><span class="pre">force_converged</span></code> because FLEUR
code always converges density before forces.</p>
</div>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">options</span></code>: <a class="reference external" href="https://aiida-core.readthedocs.io/en/latest/reference/apidoc/aiida.orm.html#aiida.orm.Dict" title="(in AiiDA v1.5)"><code class="xref py py-class docutils literal notranslate"><span class="pre">Dict</span></code></a> - AiiDA options (computational resources).
Example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="s1">&#39;resources&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;num_machines&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;num_mpiprocs_per_machine&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">},</span>
<span class="s1">&#39;max_wallclock_seconds&#39;</span><span class="p">:</span> <span class="mi">6</span><span class="o">*</span><span class="mi">60</span><span class="o">*</span><span class="mi">60</span><span class="p">,</span>
<span class="s1">&#39;queue_name&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
<span class="s1">&#39;custom_scheduler_commands&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
<span class="s1">&#39;import_sys_environment&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
<span class="s1">&#39;environment_variables&#39;</span><span class="p">:</span> <span class="p">{}</span>
</pre></div>
</div>
</li>
</ul>
</div></blockquote>
</div>
</div>
<div class="section" id="returns-nodes">
<h2><a class="toc-backref" href="#id5">Returns nodes</a><a class="headerlink" href="#returns-nodes" title="Permalink to this headline">¶</a></h2>
<p>The table below shows all the possible output nodes of the SCF workchain.</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 19%" />
<col style="width: 41%" />
<col style="width: 41%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>name</p></th>
<th class="head"><p>type</p></th>
<th class="head"><p>comment</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>output_scf_wc_para</p></td>
<td><p><a class="reference external" href="https://aiida-core.readthedocs.io/en/latest/reference/apidoc/aiida.orm.html#aiida.orm.Dict" title="(in AiiDA v1.5)"><code class="xref py py-class docutils literal notranslate"><span class="pre">Dict</span></code></a></p></td>
<td><p>results of the workchain</p></td>
</tr>
<tr class="row-odd"><td><p>fleurinp</p></td>
<td><p><a class="reference internal" href="../../module_guide/code.html#aiida_fleur.data.fleurinp.FleurinpData" title="aiida_fleur.data.fleurinp.FleurinpData"><code class="xref py py-class docutils literal notranslate"><span class="pre">FleurinpData</span></code></a></p></td>
<td><p>FleurinpData that was used (after all modifications)</p></td>
</tr>
<tr class="row-even"><td><p>last_fleur_calc_output</p></td>
<td><p><a class="reference external" href="https://aiida-core.readthedocs.io/en/latest/reference/apidoc/aiida.orm.html#aiida.orm.Dict" title="(in AiiDA v1.5)"><code class="xref py py-class docutils literal notranslate"><span class="pre">Dict</span></code></a></p></td>
<td><p>Link to last FleurCalculation output dict</p></td>
</tr>
</tbody>
</table>
<p>More details:</p>
<blockquote>
<div><ul>
<li><p><code class="docutils literal notranslate"><span class="pre">fleurinp</span></code>: <a class="reference internal" href="../../module_guide/code.html#aiida_fleur.data.fleurinp.FleurinpData" title="aiida_fleur.data.fleurinp.FleurinpData"><code class="xref py py-class docutils literal notranslate"><span class="pre">FleurinpData</span></code></a> - A
<a class="reference internal" href="../../module_guide/code.html#aiida_fleur.data.fleurinp.FleurinpData" title="aiida_fleur.data.fleurinp.FleurinpData"><code class="xref py py-class docutils literal notranslate"><span class="pre">FleurinpData</span></code></a> that was
actually used for last <a class="reference internal" href="../../module_guide/code.html#aiida_fleur.workflows.scf.FleurScfWorkChain" title="aiida_fleur.workflows.scf.FleurScfWorkChain"><code class="xref py py-class docutils literal notranslate"><span class="pre">FleurScfWorkChain</span></code></a>.
It usually differs from the input <a class="reference internal" href="../../module_guide/code.html#aiida_fleur.data.fleurinp.FleurinpData" title="aiida_fleur.data.fleurinp.FleurinpData"><code class="xref py py-class docutils literal notranslate"><span class="pre">FleurinpData</span></code></a>
because there are some hard-coded modifications in the SCF workchain.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">last_fleur_calc_output</span></code>: <a class="reference external" href="https://aiida-core.readthedocs.io/en/latest/reference/apidoc/aiida.orm.html#aiida.orm.Dict" title="(in AiiDA v1.5)"><code class="xref py py-class docutils literal notranslate"><span class="pre">Dict</span></code></a> - A link to the output node
of the last Fleur calculation.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">output_scf_wc_para</span></code>: <a class="reference external" href="https://aiida-core.readthedocs.io/en/latest/reference/apidoc/aiida.orm.html#aiida.orm.Dict" title="(in AiiDA v1.5)"><code class="xref py py-class docutils literal notranslate"><span class="pre">Dict</span></code></a> -  Main results of the workchain. Contains
errors, warnings, convergence history and other information. An example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="p">{</span>
    <span class="s1">&#39;conv_mode&#39;</span><span class="p">:</span> <span class="s1">&#39;density&#39;</span><span class="p">,</span>
    <span class="s1">&#39;distance_charge&#39;</span><span class="p">:</span> <span class="mf">0.1406279038</span><span class="p">,</span>
    <span class="s1">&#39;distance_charge_all&#39;</span><span class="p">:</span> <span class="p">[</span>
        <span class="mf">61.1110641131</span><span class="p">,</span>
        <span class="mf">43.7556515683</span><span class="p">,</span>
        <span class="o">...</span>
    <span class="p">],</span>
    <span class="s1">&#39;distance_charge_units&#39;</span><span class="p">:</span> <span class="s1">&#39;me/bohr^3&#39;</span><span class="p">,</span>
    <span class="s1">&#39;errors&#39;</span><span class="p">:</span> <span class="p">[],</span>
    <span class="s1">&#39;force_diff_last&#39;</span><span class="p">:</span> <span class="s1">&#39;can not be determined&#39;</span><span class="p">,</span>
    <span class="s1">&#39;force_largest&#39;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
    <span class="s1">&#39;info&#39;</span><span class="p">:</span> <span class="p">[],</span>
    <span class="s1">&#39;iterations_total&#39;</span><span class="p">:</span> <span class="mi">23</span><span class="p">,</span>
    <span class="s1">&#39;last_calc_uuid&#39;</span><span class="p">:</span> <span class="s1">&#39;b20b5b94-5d80-41a8-82bf-b4d8eee9bddc&#39;</span><span class="p">,</span>
    <span class="s1">&#39;loop_count&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="s1">&#39;material&#39;</span><span class="p">:</span> <span class="s1">&#39;FePt2&#39;</span><span class="p">,</span>
    <span class="s1">&#39;total_energy&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mf">38166.176928494</span><span class="p">,</span>
    <span class="s1">&#39;total_energy_all&#39;</span><span class="p">:</span> <span class="p">[</span>
        <span class="o">-</span><span class="mf">38166.542950054</span><span class="p">,</span>
        <span class="o">-</span><span class="mf">38166.345602746</span><span class="p">,</span>
        <span class="o">...</span>
    <span class="p">],</span>
    <span class="s1">&#39;total_energy_units&#39;</span><span class="p">:</span> <span class="s1">&#39;Htr&#39;</span><span class="p">,</span>
    <span class="s1">&#39;total_wall_time&#39;</span><span class="p">:</span> <span class="mi">245</span><span class="p">,</span>
    <span class="s1">&#39;total_wall_time_units&#39;</span><span class="p">:</span> <span class="s1">&#39;s&#39;</span><span class="p">,</span>
    <span class="s1">&#39;warnings&#39;</span><span class="p">:</span> <span class="p">[],</span>
    <span class="s1">&#39;workflow_name&#39;</span><span class="p">:</span> <span class="s1">&#39;FleurScfWorkChain&#39;</span><span class="p">,</span>
    <span class="s1">&#39;workflow_version&#39;</span><span class="p">:</span> <span class="s1">&#39;0.4.0&#39;</span>
<span class="p">}</span>
</pre></div>
</div>
</li>
</ul>
</div></blockquote>
</div>
<div class="section" id="layout">
<span id="scf-wc-layout"></span><h2><a class="toc-backref" href="#id6">Layout</a><a class="headerlink" href="#layout" title="Permalink to this headline">¶</a></h2>
<p>Similarly to <a class="reference internal" href="../../module_guide/code.html#aiida_fleur.calculation.fleur.FleurCalculation" title="aiida_fleur.calculation.fleur.FleurCalculation"><code class="xref py py-class docutils literal notranslate"><span class="pre">FleurCalculation</span></code></a>, SCF workchain has several
input combinations that implicitly define the behaviour of the workchain during
inputs processing. Depending
on the setup of the inputs, one of the four supported scenarios will happen:</p>
<ol class="arabic">
<li><p><strong>fleurinp</strong> + <strong>remote_data</strong> (FLEUR):</p>
<blockquote>
<div><p>Files, belonging to the <strong>fleurinp</strong>, will be used as input for the first
FLEUR calculation. Moreover, initial charge density will be
copied from the folder of the remote folder.</p>
</div></blockquote>
</li>
<li><p><strong>fleurinp</strong>:</p>
<blockquote>
<div><p>Files, belonging to the <strong>fleurinp</strong>, will be used as input for the first
FLEUR calculation.</p>
</div></blockquote>
</li>
<li><p><strong>structure</strong> + <strong>inpgen</strong> + <em>calc_parameters</em>:</p>
<blockquote>
<div><p>inpgen code and optional <em>calc_parameters</em> will be used to generate a
new <a class="reference internal" href="../../module_guide/code.html#aiida_fleur.data.fleurinp.FleurinpData" title="aiida_fleur.data.fleurinp.FleurinpData"><code class="xref py py-class docutils literal notranslate"><span class="pre">FleurinpData</span></code></a> using a given <strong>structure</strong>.
Generated <a class="reference internal" href="../../module_guide/code.html#aiida_fleur.data.fleurinp.FleurinpData" title="aiida_fleur.data.fleurinp.FleurinpData"><code class="xref py py-class docutils literal notranslate"><span class="pre">FleurinpData</span></code></a> will
be used as an input for the first FLEUR calculation.</p>
</div></blockquote>
</li>
</ol>
<ol class="arabic" start="3">
<li><p><strong>structure</strong> + <strong>inpgen</strong> + <em>calc_parameters</em> + <strong>remote_data</strong> (FLEUR):</p>
<blockquote>
<div><p>inpgen code and optional <em>calc_parameters</em> will be used to generate a
new <a class="reference internal" href="../../module_guide/code.html#aiida_fleur.data.fleurinp.FleurinpData" title="aiida_fleur.data.fleurinp.FleurinpData"><code class="xref py py-class docutils literal notranslate"><span class="pre">FleurinpData</span></code></a> using a given <strong>structure</strong>.
Generated <a class="reference internal" href="../../module_guide/code.html#aiida_fleur.data.fleurinp.FleurinpData" title="aiida_fleur.data.fleurinp.FleurinpData"><code class="xref py py-class docutils literal notranslate"><span class="pre">FleurinpData</span></code></a> will
be used as an input for the first FLEUR calculation. Initial charge density will be taken from given
<strong>remote_data</strong> (FLEUR). <strong>Note</strong>: make sure that <strong>remote_data</strong> (FLEUR) corresponds to the same structure.</p>
</div></blockquote>
</li>
</ol>
<ol class="arabic" start="5">
<li><p><strong>remote_data</strong> (FLEUR):</p>
<blockquote>
<div><p>inp.xml file and initial
charge density will be copied from the remote folder.</p>
</div></blockquote>
</li>
</ol>
<p>For example, if you want to continue converging charge density, use the option 3.
If you want to change
something in the inp.xml and use old charge density you should use option 2. To do this, you can
retrieve a FleurinpData produced by the parent calculation and change it via FleurinpModifier,
use it as an input together with the RemoteFolder.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>One <em>must</em> keep one of the supported input configurations. In other case the workchain will
stop throwing exit code 230.</p>
</div>
<p>The general layout does not depend on the scenario, SCF workchain sequentially submits several
FLEUR calculation to achieve a convergence criterion.</p>
<blockquote>
<div><div class="figure align-center">
<a class="reference internal image-reference" href="../../_images/Workchain_charts_scf_wc.png"><img alt="../../_images/Workchain_charts_scf_wc.png" src="../../_images/Workchain_charts_scf_wc.png" style="width: 50%;" /></a>
</div>
</div></blockquote>
</div>
<div class="section" id="error-handling">
<h2><a class="toc-backref" href="#id7">Error handling</a><a class="headerlink" href="#error-handling" title="Permalink to this headline">¶</a></h2>
<p>In case of failure the SCF WorkChain should throw one of the <a class="reference internal" href="../hints/exit_codes.html#exit-codes"><span class="std std-ref">exit codes</span></a>:</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 20%" />
<col style="width: 80%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Exit code</p></th>
<th class="head"><p>Reason</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>230</p></td>
<td><p>Invalid input, please
check input configuration</p></td>
</tr>
<tr class="row-odd"><td><p>231</p></td>
<td><p>Invalid code node specified, check inpgen
and fleur code nodes</p></td>
</tr>
<tr class="row-even"><td><p>232</p></td>
<td><p>Input file modification failed</p></td>
</tr>
<tr class="row-odd"><td><p>233</p></td>
<td><p>Input file was corrupted after  modifications</p></td>
</tr>
<tr class="row-even"><td><p>360</p></td>
<td><p>Inpgen calculation failed</p></td>
</tr>
<tr class="row-odd"><td><p>361</p></td>
<td><p>Fleur calculation failed</p></td>
</tr>
<tr class="row-even"><td><p>362</p></td>
<td><p>SCF cycle did not lead to convergence,
maximum number of iterations exceeded</p></td>
</tr>
</tbody>
</table>
<p>If your workchain crashes and stops in <em>Excepted</em> state, please open a new issue on the Github page
and describe the details of the failure.</p>
</div>
<div class="section" id="plot-fleur-visualization">
<h2><a class="toc-backref" href="#id8">Plot_fleur visualization</a><a class="headerlink" href="#plot-fleur-visualization" title="Permalink to this headline">¶</a></h2>
<blockquote>
<div><p>Single node</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">aiida_fleur.tools.plot</span> <span class="kn">import</span> <span class="n">plot_fleur</span>

<span class="n">plot_fleur</span><span class="p">(</span><span class="mi">50816</span><span class="p">)</span>
</pre></div>
</div>
<div class="figure align-center">
<a class="reference internal image-reference" href="../../_images/plot_fleur_scf1.png"><img alt="../../_images/plot_fleur_scf1.png" src="../../_images/plot_fleur_scf1.png" style="width: 60%;" /></a>
</div>
<div class="figure align-center">
<a class="reference internal image-reference" href="../../_images/plot_fleur_scf2.png"><img alt="../../_images/plot_fleur_scf2.png" src="../../_images/plot_fleur_scf2.png" style="width: 60%;" /></a>
</div>
<p>Multi node</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">aiida_fleur.tools.plot</span> <span class="kn">import</span> <span class="n">plot_fleur</span>

<span class="n">plot_fleur</span><span class="p">(</span><span class="n">scf_pk_list</span><span class="p">)</span>
</pre></div>
</div>
<div class="figure align-center">
<a class="reference internal image-reference" href="../../_images/plot_fleur_scf_m1.png"><img alt="../../_images/plot_fleur_scf_m1.png" src="../../_images/plot_fleur_scf_m1.png" style="width: 60%;" /></a>
</div>
<div class="figure align-center">
<a class="reference internal image-reference" href="../../_images/plot_fleur_scf_m2.png"><img alt="../../_images/plot_fleur_scf_m2.png" src="../../_images/plot_fleur_scf_m2.png" style="width: 60%;" /></a>
</div>
</div></blockquote>
</div>
<div class="section" id="database-node-graph">
<h2><a class="toc-backref" href="#id9">Database Node graph</a><a class="headerlink" href="#database-node-graph" title="Permalink to this headline">¶</a></h2>
<blockquote>
<div><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">aiida_fleur.tools.graph_fleur</span> <span class="kn">import</span> <span class="n">draw_graph</span>

<span class="n">draw_graph</span><span class="p">(</span><span class="mi">50816</span><span class="p">)</span>
</pre></div>
</div>
<div class="figure align-center">
<a class="reference internal image-reference" href="../../_images/scf_50816.pdf"><img alt="../../_images/scf_50816.pdf" src="../../_images/scf_50816.pdf" style="width: 100%;" /></a>
</div>
</div></blockquote>
</div>
<div class="section" id="example-usage">
<h2><a class="toc-backref" href="#id10">Example usage</a><a class="headerlink" href="#example-usage" title="Permalink to this headline">¶</a></h2>
<blockquote>
<div><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="kn">from</span> <span class="nn">aiida_fleur.workflows.scf</span> <span class="kn">import</span> <span class="n">FleurScfWorkChain</span>
<span class="kn">from</span> <span class="nn">aiida.orm</span> <span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">load_node</span>

<span class="n">fleur_code</span> <span class="o">=</span> <span class="n">load_node</span><span class="p">(</span><span class="n">FLEUR_PK</span><span class="p">)</span>
<span class="n">inpgen_code</span> <span class="o">=</span> <span class="n">load_node</span><span class="p">(</span><span class="n">INPGEN_PK</span><span class="p">)</span>
<span class="n">structure</span> <span class="o">=</span> <span class="n">load_node</span><span class="p">(</span><span class="n">STRUCTURE_PK</span><span class="p">)</span>

<span class="n">wf_para</span> <span class="o">=</span> <span class="n">Dict</span><span class="p">(</span><span class="nb">dict</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;fleur_runmax&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
                     <span class="s1">&#39;density_converged&#39;</span><span class="p">:</span> <span class="mf">0.001</span><span class="p">,</span>
                     <span class="s1">&#39;mode&#39;</span><span class="p">:</span> <span class="s1">&#39;density&#39;</span><span class="p">,</span>
                     <span class="s1">&#39;itmax_per_run&#39;</span><span class="p">:</span> <span class="mi">30</span><span class="p">,</span>
                     <span class="s1">&#39;serial&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                     <span class="s1">&#39;only_even_MPI&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">})</span>

<span class="n">options</span> <span class="o">=</span> <span class="n">Dict</span><span class="p">(</span><span class="nb">dict</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;resources&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;num_machines&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;num_mpiprocs_per_machine&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">},</span>
                     <span class="s1">&#39;withmpi&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                     <span class="s1">&#39;max_wallclock_seconds&#39;</span><span class="p">:</span> <span class="mi">600</span><span class="p">})</span>

<span class="n">calc_parameters</span> <span class="o">=</span> <span class="n">Dict</span><span class="p">(</span><span class="nb">dict</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;kpt&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;div1&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
                                     <span class="s1">&#39;div2&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
                                     <span class="s1">&#39;div3&#39;</span><span class="p">:</span> <span class="mi">2</span>
                                     <span class="p">}})</span>

<span class="n">SCF_workchain</span> <span class="o">=</span> <span class="n">submit</span><span class="p">(</span><span class="n">FleurScfWorkChain</span><span class="p">,</span>
                       <span class="n">fleur</span><span class="o">=</span><span class="n">fleur_code</span><span class="p">,</span>
                       <span class="n">inpgen</span><span class="o">=</span><span class="n">inpgen_code</span><span class="p">,</span>
                       <span class="n">calc_parameters</span><span class="o">=</span><span class="n">calc_parameters</span><span class="p">,</span>
                       <span class="n">structure</span><span class="o">=</span><span class="n">structure</span><span class="p">,</span>
                       <span class="n">wf_parameters</span><span class="o">=</span><span class="n">wf_para</span><span class="p">,</span>
                       <span class="n">options</span><span class="o">=</span><span class="n">options</span><span class="p">)</span>
</pre></div>
</div>
</div></blockquote>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="eos_wc.html" class="btn btn-neutral float-right" title="Fleur equation of states (eos) workflow" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="base_wc.html" class="btn btn-neutral float-left" title="Fleur base restart workchain" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2016-2020, FZ Jülich GmbH, Germany. All rights reserved

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>