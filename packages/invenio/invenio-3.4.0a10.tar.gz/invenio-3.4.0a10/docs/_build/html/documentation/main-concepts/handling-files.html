
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Integrating Files &#8212; Invenio 3.4.0a8 documentation</title>
    <link rel="stylesheet" href="../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../_static/graphviz.css" />
    <script id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Infrastructure architecture" href="architecture-infrastructure.html" />
    <link rel="prev" title="Managing access to records" href="managing-access.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <div class="section" id="integrating-files">
<span id="id1"></span><h1>Integrating Files<a class="headerlink" href="#integrating-files" title="Permalink to this headline">¶</a></h1>
<p>With Invenio, you can attach files to records and use powerful REST APIs to
upload and download files. You can also integrate previewers to nicely display
the content of a file in a webpage and use APIs to deliver different types of
images using the IIIF de facto standard.</p>
<div class="section" id="overview">
<span id="handling-files-overview"></span><h2>Overview<a class="headerlink" href="#overview" title="Permalink to this headline">¶</a></h2>
<p>The first step when setting up the files integration is to decide where
the files should be stored.
In Invenio, you can specify where files are stored by defining a
<code class="docutils literal notranslate"><span class="pre">Location</span></code>: a location is a representation of your storage system.
It can be, for example, a local folder in your machine or a remote storage.
It has a <code class="docutils literal notranslate"><span class="pre">name</span></code> and a <code class="docutils literal notranslate"><span class="pre">URI</span></code> to define the base path to the files.</p>
<p>To access and manage files in a location, Invenio uses a <code class="docutils literal notranslate"><span class="pre">Storage</span></code> implementation:
this defines how to access files in your location. In other words, it knows how files
are stored, e.g. in a hierarchy of folders, and how to read and write them.</p>
<p>You can define multiple locations and storage. This is useful, for example,
when you are dealing with online and offline file systems.</p>
<p>A single specific file is represented in Invenio by a <code class="docutils literal notranslate"><span class="pre">FileInstance</span></code> object:
it defines its relative path to the Location where it is stored and also
other useful properties such as its size or checksum.</p>
<p>To sum up, you can think of the Location, Storage and FileInstance as
the physical representation of your file system(s).</p>
<div class="section" id="object-storage">
<h3>Object storage<a class="headerlink" href="#object-storage" title="Permalink to this headline">¶</a></h3>
<p>Invenio provides an abstraction of your physical file system with an object
storage representation similar to Amazon S3. This allows great flexibility
and easy to use APIs.</p>
<p>You can compare this implementation to a traditional file system
where files are contained in folders. In Invenio object storage,
<code class="docutils literal notranslate"><span class="pre">ObjectVersions</span></code> are contained in <code class="docutils literal notranslate"><span class="pre">Buckets</span></code>.</p>
<p>Buckets are sets of objects, they are uniquely identified by an ID
and can define constraints on file sizes or quotas. A bucket also
defines the default Location to use when adding files, if none is
provided.</p>
<p>An ObjectVersion is a specific version (the <code class="docutils literal notranslate"><span class="pre">version_id</span></code>) of a file
at a given moment in time. It has a reference to a FileInstance
and metadata such as the file name (the <code class="docutils literal notranslate"><span class="pre">key</span></code>). The latest version
of a file is marked as the <code class="docutils literal notranslate"><span class="pre">head</span></code>.</p>
<p>ObjectVersions allow to perform operations to your files without
accessing the file system. Let’s see a common example: a user wants
to delete a previously uploaded file.
With Invenio, this means creating a new ObjectVersion for this
file, the new head, without reference to the FileInstance that
it had before. The file on disk is not accessed or removed.
This is also called delete marker or soft deletion.</p>
<p>You can read more in the
<a class="reference external" href="http://invenio-files-rest.readthedocs.io/en/latest/">Invenio-Files-REST</a>
module documentation.</p>
</div>
</div>
<div class="section" id="integration-with-records">
<span id="handling-files-integration-with-records"></span><h2>Integration with records<a class="headerlink" href="#integration-with-records" title="Permalink to this headline">¶</a></h2>
<p>Invenio integrates files and records by creating a reference
between a Record and a Bucket. By default in Invenio,
a record has a reference to one bucket and
a bucket to one record.</p>
<img alt="../../_images/invenio-files-integration.png" src="../../_images/invenio-files-integration.png" />
<p>Invenio allows you to set up different scenarios and have, for example,
multiple buckets per records and viceversa or buckets not attached
to any record. To achieve any of these, you will have to define
your own integration between records and files.</p>
<p>The records-files integration provides a set of REST APIs to easily
add, retrieve or delete files for a given record.</p>
</div>
<div class="section" id="using-rest-apis">
<span id="handling-files-using-rest-apis"></span><h2>Using REST APIs<a class="headerlink" href="#using-rest-apis" title="Permalink to this headline">¶</a></h2>
<p>If you haven’t already done so, make sure you’ve followed the <a class="reference internal" href="../../getting-started/quickstart/index.html#quickstart"><span class="std std-ref">Quickstart</span></a>
so you have an Invenio instance to work on.</p>
<p>Let’s create a simple record:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> curl -k --header <span class="s2">&quot;Content-Type: application/json&quot;</span> <span class="se">\</span>
    --request POST <span class="se">\</span>
    --data <span class="s1">&#39;{&quot;title&quot;:&quot;Some title&quot;, &quot;contributors&quot;: [{&quot;name&quot;: &quot;Doe, John&quot;}]}&#39;</span> <span class="se">\</span>
    https://127.0.0.1:5000/api/records/?prettyprint<span class="o">=</span><span class="m">1</span>
</pre></div>
</div>
<p>Response:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
  <span class="nt">&quot;created&quot;</span><span class="p">:</span> <span class="s2">&quot;2019-11-25T15:02:24.379791+00:00&quot;</span><span class="p">,</span>
  <span class="nt">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;1&quot;</span><span class="p">,</span>
  <span class="nt">&quot;links&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&quot;files&quot;</span><span class="p">:</span> <span class="s2">&quot;https://127.0.0.1:5000/api/records/1/files&quot;</span><span class="p">,</span>
    <span class="nt">&quot;self&quot;</span><span class="p">:</span> <span class="s2">&quot;https://127.0.0.1:5000/api/records/1&quot;</span>
  <span class="p">},</span>
  <span class="nt">&quot;metadata&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&quot;contributors&quot;</span><span class="p">:</span> <span class="p">[</span>
      <span class="p">{</span>
        <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Doe, John&quot;</span>
      <span class="p">}</span>
    <span class="p">],</span>
    <span class="nt">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;1&quot;</span><span class="p">,</span>
    <span class="nt">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;Some title&quot;</span>
  <span class="p">},</span>
  <span class="nt">&quot;revision&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
  <span class="nt">&quot;updated&quot;</span><span class="p">:</span> <span class="s2">&quot;2019-11-25T15:02:24.379798+00:00&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>You can now upload a file to this record (if you are not using the default
scripts to run the server, make sure your celery worker is running):</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> <span class="nb">echo</span> <span class="s2">&quot;my file content&quot;</span> &gt; my_file.txt

<span class="gp">$</span> curl -k -H <span class="s2">&quot;Content-Type: application/octet-stream&quot;</span> <span class="se">\</span>
    --request PUT <span class="se">\</span>
    --data-binary @my_file.txt <span class="se">\</span>
    https://127.0.0.1:5000/api/records/1/files/my_file.txt?prettyprint<span class="o">=</span><span class="m">1</span>
</pre></div>
</div>
<p>Response:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
  <span class="nt">&quot;is_head&quot;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
  <span class="nt">&quot;updated&quot;</span><span class="p">:</span> <span class="s2">&quot;2019-11-25T15:21:07.276520&quot;</span><span class="p">,</span>
  <span class="nt">&quot;size&quot;</span><span class="p">:</span> <span class="mi">16</span><span class="p">,</span>
  <span class="nt">&quot;version_id&quot;</span><span class="p">:</span> <span class="s2">&quot;577a96b9-94a1-4abf-8f6a-a5c168ee6faa&quot;</span><span class="p">,</span>
  <span class="nt">&quot;key&quot;</span><span class="p">:</span> <span class="s2">&quot;my_file.txt&quot;</span><span class="p">,</span>
  <span class="nt">&quot;tags&quot;</span><span class="p">:</span> <span class="p">{},</span>
  <span class="nt">&quot;links&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&quot;self&quot;</span><span class="p">:</span> <span class="s2">&quot;https://127.0.0.1:5000/api/records/1/files/my_file.txt&quot;</span><span class="p">,</span>
    <span class="nt">&quot;version&quot;</span><span class="p">:</span> <span class="s2">&quot;https://127.0.0.1:5000/api/records/1/files/my_file.txt?versionId=577a96b9-94a1-4abf-8f6a-a5c168ee6faa&quot;</span><span class="p">,</span>
    <span class="nt">&quot;uploads&quot;</span><span class="p">:</span> <span class="s2">&quot;https://127.0.0.1:5000/api/records/1/files/my_file.txt?uploads&quot;</span>
  <span class="p">},</span>
  <span class="nt">&quot;mimetype&quot;</span><span class="p">:</span> <span class="s2">&quot;text/plain&quot;</span><span class="p">,</span>
  <span class="nt">&quot;created&quot;</span><span class="p">:</span> <span class="s2">&quot;2019-11-25T15:21:07.269683&quot;</span><span class="p">,</span>
  <span class="nt">&quot;delete_marker&quot;</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
  <span class="nt">&quot;checksum&quot;</span><span class="p">:</span> <span class="s2">&quot;md5:1b7ea8126d278ecbfa9fcb9b0d7dc5af&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>If you now fetch the record again, you can see that the uploaded files
have been added to its metadata:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> curl -k --header <span class="s2">&quot;Content-Type: application/json&quot;</span> <span class="se">\</span>
    https://localhost:5000/api/records/1?prettyprint<span class="o">=</span><span class="m">1</span>
</pre></div>
</div>
<p>Response:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
  <span class="nt">&quot;created&quot;</span><span class="p">:</span> <span class="s2">&quot;2019-11-25T15:06:02.858325+00:00&quot;</span><span class="p">,</span>
  <span class="nt">&quot;files&quot;</span><span class="p">:</span> <span class="p">[</span>
    <span class="p">{</span>
      <span class="nt">&quot;bucket&quot;</span><span class="p">:</span> <span class="s2">&quot;7ddc1409-35a3-4a65-8324-89da4245f2f9&quot;</span><span class="p">,</span>
      <span class="nt">&quot;checksum&quot;</span><span class="p">:</span> <span class="s2">&quot;md5:1b7ea8126d278ecbfa9fcb9b0d7dc5af&quot;</span><span class="p">,</span>
      <span class="nt">&quot;file_id&quot;</span><span class="p">:</span> <span class="s2">&quot;6f413750-82ca-45bb-aa5a-0f009b651843&quot;</span><span class="p">,</span>
      <span class="nt">&quot;key&quot;</span><span class="p">:</span> <span class="s2">&quot;my_file.txt&quot;</span><span class="p">,</span>
      <span class="nt">&quot;size&quot;</span><span class="p">:</span> <span class="mi">16</span><span class="p">,</span>
      <span class="nt">&quot;version_id&quot;</span><span class="p">:</span> <span class="s2">&quot;577a96b9-94a1-4abf-8f6a-a5c168ee6faa&quot;</span>
    <span class="p">}</span>
  <span class="p">],</span>
  <span class="nt">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;1&quot;</span><span class="p">,</span>
  <span class="nt">&quot;links&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&quot;files&quot;</span><span class="p">:</span> <span class="s2">&quot;https://localhost:5000/api/records/1/files&quot;</span><span class="p">,</span>
    <span class="nt">&quot;self&quot;</span><span class="p">:</span> <span class="s2">&quot;https://localhost:5000/api/records/1&quot;</span>
  <span class="p">},</span>
  <span class="nt">&quot;metadata&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&quot;contributors&quot;</span><span class="p">:</span> <span class="p">[</span>
      <span class="p">{</span>
        <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Doe, John&quot;</span>
      <span class="p">}</span>
    <span class="p">],</span>
    <span class="nt">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;1&quot;</span><span class="p">,</span>
    <span class="nt">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;Some title&quot;</span>
  <span class="p">},</span>
  <span class="nt">&quot;revision&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
  <span class="nt">&quot;updated&quot;</span><span class="p">:</span> <span class="s2">&quot;2019-11-25T15:21:07.453874+00:00&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>You can download the file by requesting it with its filename:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> curl -k --header <span class="s2">&quot;Content-Type: application/json&quot;</span> <span class="se">\</span>
    https://localhost:5000/api/records/1/files/my_file.txt
</pre></div>
</div>
<p>You can also delete the uploaded file:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> curl -k --header <span class="s2">&quot;Content-Type: application/json&quot;</span> <span class="se">\</span>
    --request DELETE <span class="se">\</span>
    https://localhost:5000/api/records/1/files/my_file.txt
</pre></div>
</div>
<div class="section" id="integration-details">
<h3>Integration details<a class="headerlink" href="#integration-details" title="Permalink to this headline">¶</a></h3>
<p>When creating a new record, Invenio automatically creates and
assigns a new Bucket to the newly created record. Then,
when a new file is uploaded to the record, Invenio will:</p>
<ol class="arabic simple">
<li><p>fetch the Bucket assigned to the Record</p></li>
<li><p>store the file in the bucket’s default Location using
the configured Storage</p></li>
<li><p>create a new FileInstance with size, checksum and the URI path
pointing to the file</p></li>
<li><p>create a new ObjectVersion with a reference to the FileInstance
and the Bucket to which it belongs</p></li>
<li><p>update the record’s metadata to add the metadata of the new file</p></li>
</ol>
<p>You can learn more on how record and files work together as well as
the available APIs by reading the documentation of
<a class="reference external" href="http://invenio-records-files.readthedocs.io/en/latest/">Invenio-Records-Files</a>
and
<a class="reference external" href="http://invenio-files-rest.readthedocs.io/en/latest/">Invenio-Files-REST</a>.</p>
</div>
</div>
<div class="section" id="setup-your-storage">
<span id="handling-files-setup-your-storage"></span><h2>Setup your storage<a class="headerlink" href="#setup-your-storage" title="Permalink to this headline">¶</a></h2>
<p>With the quickstart application, a default Location is set up in the
same directory of your virtual environment.</p>
<p>You can create your own locations by using the CLI. The only
constraint is that you will always have to define at least
one <code class="docutils literal notranslate"><span class="pre">default</span></code> Location.</p>
<p>For example, you can define a new default location named <code class="docutils literal notranslate"><span class="pre">shared</span></code> in the path
<code class="docutils literal notranslate"><span class="pre">/mnt/shared</span></code>:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> pipenv run invenio files location shared /mnt/shared --default
</pre></div>
</div>
<p>From now on, any new Bucket, besides the existing ones will use this location
and therefore files will be stored in <code class="docutils literal notranslate"><span class="pre">/mnt/shared</span></code>.</p>
<p>Invenio provides a default storage implementation based on
<a class="reference external" href="https://www.pyfilesystem.org/">PyFilesystem</a> and it will store files
in the path <code class="docutils literal notranslate"><span class="pre">&lt;location_uri&gt;/&lt;file</span> <span class="pre">instance</span> <span class="pre">uuid&gt;/data</span></code>.
The middle path <code class="docutils literal notranslate"><span class="pre">&lt;file</span> <span class="pre">instance</span> <span class="pre">uuid&gt;</span></code> can be adjusted via configuration
variables.</p>
<p>For example, the previously uploaded file <code class="docutils literal notranslate"><span class="pre">my_file.txt</span></code> will be saved on
disk in <code class="docutils literal notranslate"><span class="pre">/mnt/shared/4j/0f/k7ss-h8k1-0k2h/data</span></code>.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Every file in Invenio is stored on disk with the file name
<code class="docutils literal notranslate"><span class="pre">data</span></code>. This is to avoid any possible issue with user input and
potentially unsupported special characters. The original file name is
stored in the ObjectVersion metadata and this internal implementation
is never exposed to the user.</p>
</div>
<div class="section" id="custom-storage">
<h3>Custom storage<a class="headerlink" href="#custom-storage" title="Permalink to this headline">¶</a></h3>
<p>The default storage implementation in Invenio uses
<a class="reference external" href="https://www.pyfilesystem.org/">PyFilesystem</a>
to access the file system. If this does not fulfill your
requirements, you can implement your own.</p>
<p>The <a class="reference external" href="https://invenio-files-rest.readthedocs.io/en/latest/api.html#invenio_files_rest.storage.FileStorage" title="(in Invenio-Files-REST v1.2.0)"><code class="xref py py-class docutils literal notranslate"><span class="pre">invenio_files_rest.storage.FileStorage</span></code></a> is the base class
interface that defines the operations used when accessing files.
You can create your own factory that will instantiate and return your
storage implementation.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">my_storage_factory</span><span class="p">(</span><span class="n">fileinstance</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">default_location</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                       <span class="n">default_storage_class</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                       <span class="n">filestorage_class</span><span class="o">=</span><span class="n">MyFileStorage</span><span class="p">,</span> <span class="n">fileurl</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                       <span class="n">size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">modified</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">clean_dir</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="n">fileurl</span> <span class="o">=</span> <span class="n">fileinstance</span><span class="o">.</span><span class="n">uri</span>
    <span class="k">return</span> <span class="n">filestorage_class</span><span class="p">(</span>
        <span class="n">fileurl</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">size</span><span class="p">,</span> <span class="n">modified</span><span class="o">=</span><span class="n">modified</span><span class="p">,</span> <span class="n">clean_dir</span><span class="o">=</span><span class="n">clean_dir</span><span class="p">)</span>
</pre></div>
</div>
<p>Then, you can configure Invenio to use this new storage
by setting the related configuration variable in your <code class="docutils literal notranslate"><span class="pre">config.py</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">FILES_REST_STORAGE_FACTORY</span> <span class="o">=</span> <span class="s2">&quot;my_storage_factory&quot;</span>
</pre></div>
</div>
<p>If you are looking for an integration with a S3 object storage, you
can read more about it on the
<a class="reference external" href="https://invenio-s3.readthedocs.io/">Invenio-S3</a> documentation.</p>
</div>
</div>
<div class="section" id="permissions">
<span id="handling-files-permissions"></span><h2>Permissions<a class="headerlink" href="#permissions" title="Permalink to this headline">¶</a></h2>
<p>Files permissions relies on
<a class="reference external" href="https://invenio-access.readthedocs.io/">Invenio-Access</a>
to allow configured users or roles to perform actions. These concepts are
also described in the <a class="reference internal" href="managing-access.html#managing-access"><span class="std std-ref">Managing access to records</span></a> section.</p>
<p>The integration with records does not set any particular permission on files:
it is your responsibility to decide how to give access to files based on your
record.</p>
<p>The first step is to implement your own permission factory. As an example,
let’s implement a factory that allows access to files only to the user that
is owner of the record (the record should have a field <code class="docutils literal notranslate"><span class="pre">owner</span></code>).</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">flask_principal</span> <span class="kn">import</span> <span class="n">UserNeed</span>
<span class="kn">from</span> <span class="nn">invenio_access</span> <span class="kn">import</span> <span class="n">Permission</span><span class="p">,</span> <span class="n">superuser_access</span>
<span class="kn">from</span> <span class="nn">invenio_files_rest.models</span> <span class="kn">import</span> <span class="n">Bucket</span><span class="p">,</span> <span class="n">MultipartObject</span><span class="p">,</span> <span class="n">ObjectVersion</span>
<span class="kn">from</span> <span class="nn">invenio_records</span> <span class="kn">import</span> <span class="n">Record</span>
<span class="kn">from</span> <span class="nn">invenio_records_files.models</span> <span class="kn">import</span> <span class="n">RecordsBuckets</span>

<span class="k">def</span> <span class="nf">my_permission_factory</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">action</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Given an action, return the permission for the given object.</span>

<span class="sd">    :param obj: An instance of :class:`invenio_files_rest.models.Bucket` or</span>
<span class="sd">        :class:`invenio_files_rest.models.ObjectVersion` or</span>
<span class="sd">        :class:`invenio_files_rest.models.MultipartObject` or ``None`` if</span>
<span class="sd">        the action is global.</span>
<span class="sd">    :param action: The required action.</span>
<span class="sd">    :raises RuntimeError: If the object is unknown.</span>
<span class="sd">    :returns: A :class:`invenio_access.permissions.Permission` instance.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># apply the same permission to any `action`</span>
    <span class="c1"># retrieve the bucket from the requested `obj`</span>
    <span class="n">bucket_id</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">Bucket</span><span class="p">):</span>
        <span class="n">bucket_id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">ObjectVersion</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">MultipartObject</span><span class="p">):</span>
        <span class="n">bucket_id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">bucket_id</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">bucket_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># retrieve the record with this bucket attached</span>
        <span class="c1"># we assume that there is only one</span>
        <span class="n">record_bucket</span> <span class="o">=</span> <span class="n">RecordsBuckets</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">bucket_id</span><span class="o">=</span><span class="n">bucket_id</span><span class="p">)</span><span class="o">.</span><span class="n">one_or_none</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">record_bucket</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># retrieve the owner field</span>
            <span class="n">record</span> <span class="o">=</span> <span class="n">Record</span><span class="o">.</span><span class="n">get_record</span><span class="p">(</span><span class="n">record_bucket</span><span class="o">.</span><span class="n">record_id</span><span class="p">)</span>
            <span class="n">owner</span> <span class="o">=</span> <span class="n">record</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;owner&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">owner</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">Permission</span><span class="p">(</span><span class="n">UserNeed</span><span class="p">(</span><span class="n">record</span><span class="p">[</span><span class="s2">&quot;owner&quot;</span><span class="p">]))</span>
    <span class="c1"># allow only admins</span>
    <span class="k">return</span> <span class="n">Permission</span><span class="p">(</span><span class="n">superuser_access</span><span class="p">)</span>
</pre></div>
</div>
<p>Then, configure Invenio to use this function when validating permissions by
setting the related configuration variable in <code class="docutils literal notranslate"><span class="pre">config.py</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">FILES_REST_PERMISSION_FACTORY</span> <span class="o">=</span> <span class="s2">&quot;my_permission_factory&quot;</span>
</pre></div>
</div>
<div class="section" id="response-codes">
<h3>Response codes<a class="headerlink" href="#response-codes" title="Permalink to this headline">¶</a></h3>
<p>If the authorization for an action fails, Invenio will normally returns
a <code class="docutils literal notranslate"><span class="pre">403</span></code> response code for authenticated users, <code class="docutils literal notranslate"><span class="pre">401</span></code> otherwise.
For security reasons, when trying to retrieve an unauthorized file,
it will return a <code class="docutils literal notranslate"><span class="pre">404</span></code> instead to hide the existence or non-existence
of the file.</p>
</div>
</div>
<div class="section" id="large-files-upload">
<span id="handling-files-upload-large-files"></span><h2>Large files upload<a class="headerlink" href="#large-files-upload" title="Permalink to this headline">¶</a></h2>
<p>When trying to upload a large file, it might happen that your HTTP
request aborts and returns a response code
<code class="code docutils literal notranslate"><span class="pre">413</span> <span class="pre">(Request</span> <span class="pre">Entity</span> <span class="pre">Too</span> <span class="pre">Large)</span></code>. The maximum upload size
is limited by the default configuration of Flask and most probably
your web server.</p>
<p>You can adjust these configurations according to your needs.</p>
<p>For Flask, set the <code class="code docutils literal notranslate"><span class="pre">MAX_CONTENT_LENGTH</span></code> configuration variable.
Be aware that if the request does not specify a <code class="code docutils literal notranslate"><span class="pre">CONTENT_LENGTH</span></code>,
no data will be read.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> app.config<span class="o">[</span><span class="s1">&#39;MAX_CONTENT_LENGTH&#39;</span><span class="o">]</span> <span class="o">=</span> <span class="m">25</span> * <span class="m">1024</span> * <span class="m">1024</span>  <span class="c1"># bytes</span>
</pre></div>
</div>
<p>Here an example to tune the configuration of <code class="docutils literal notranslate"><span class="pre">Nginx</span></code>.
In case you use another web server, please consult its documentation.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">http {</span>
<span class="go"> ...</span>
<span class="go"> client_max_body_size 25M;</span>
<span class="go">}</span>
</pre></div>
</div>
</div>
<div class="section" id="files-integrity-checks">
<span id="handling-files-integrity-checks"></span><h2>Files integrity checks<a class="headerlink" href="#files-integrity-checks" title="Permalink to this headline">¶</a></h2>
<p>To ensure that files in your file system are not damaged, it is
recommended to set up files integrity checks. This consists in a
periodical tasks that scan your files and re-compute each checksum
by comparing it with the one calculated when uploaded. In case
of mismatch, it will throw an exception.</p>
<p>Configure the task in your <code class="docutils literal notranslate"><span class="pre">config.py</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">CELERY_BEAT_SCHEDULE</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;file-checks&#39;</span><span class="p">:</span> <span class="p">{</span>
       <span class="s1">&#39;task&#39;</span><span class="p">:</span> <span class="s1">&#39;invenio_files_rest.tasks.schedule_checksum_verification&#39;</span><span class="p">,</span>
       <span class="s1">&#39;schedule&#39;</span><span class="p">:</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">hours</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Make sure that <a class="reference external" href="https://docs.celeryproject.org/en/latest/userguide/periodic-tasks.html#starting-the-scheduler">celery beat</a>
is running:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> celery -A invenio_app.celery beat
</pre></div>
</div>
<p>When the task
<a class="reference external" href="https://invenio-files-rest.readthedocs.io/en/latest/api.html#invenio_files_rest.tasks.schedule_checksum_verification">schedule_checksum_verification</a>
runs, it will retrieve a number of files to check based on a set of constraints
in order to throttle the execution rate of the checks. For each file,
it will then spawn the task
<a class="reference external" href="https://invenio-files-rest.readthedocs.io/en/latest/api.html#invenio_files_rest.tasks.verify_checksum">verify_checksum</a>
to calculate the checksum.</p>
<p>Given that this task will constantly check files, it is recommended to
schedule these tasks on a separate low priority queue.</p>
<p>Create a new queue called <code class="docutils literal notranslate"><span class="pre">low</span></code> in your <code class="docutils literal notranslate"><span class="pre">config.py</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">CELERY_TASK_ROUTES</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;invenio_files_rest.tasks.verify_checksum&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;queue&#39;</span><span class="p">:</span> <span class="s1">&#39;low&#39;</span><span class="p">},</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Then, spawn only one worker that will consume tasks sent to the <code class="docutils literal notranslate"><span class="pre">low</span></code> queue:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> celery -A invenio_app.celery worker -l info -Q low
</pre></div>
</div>
</div>
<div class="section" id="previewing-files">
<span id="handling-files-previewing"></span><h2>Previewing files<a class="headerlink" href="#previewing-files" title="Permalink to this headline">¶</a></h2>
<p>Invenio has support for previewing many of the most popular file formats
including PDF, ZIP, Markdown, images and Jupyter Notebooks.</p>
<p>Given an ObjectVersion with a filename (the <code class="docutils literal notranslate"><span class="pre">key</span></code> field), Invenio will
iterate through the available previewers and use the first matching the
file extension contained in the filename. The ordered list of previewers
can be configured via the configuration variable
<a class="reference external" href="https://invenio-previewer.readthedocs.io/en/latest/api.html#invenio_previewer.config.PREVIEWER_PREFERENCE">PREVIEWER_PREFERENCE</a>.</p>
<p>For example, given a <code class="docutils literal notranslate"><span class="pre">thesis.pdf</span></code> to preview and the following
configuration:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">PREVIEWER_PREFERENCE</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;simple_image&quot;</span><span class="p">,</span>  <span class="c1"># previews .jpg and .png</span>
    <span class="s2">&quot;a_pdf_previewer&quot;</span><span class="p">,</span>  <span class="c1"># previews .pdf</span>
    <span class="s2">&quot;another_pdf_previewer&quot;</span><span class="p">,</span>  <span class="c1"># previews .pdf</span>
<span class="p">]</span>
</pre></div>
</div>
<p>only the <code class="docutils literal notranslate"><span class="pre">a_pdf_previewer</span></code> will be run as previewer.
<code class="docutils literal notranslate"><span class="pre">another_pdf_previewer</span></code> will be never executed.</p>
<p>To preview a file in your website, you can use the available
endpoint <code class="docutils literal notranslate"><span class="pre">/records/&lt;pid_value&gt;/preview/&lt;filename&gt;</span></code> and the
view <code class="docutils literal notranslate"><span class="pre">invenio_previewer.views:preview</span></code>.
In your <code class="docutils literal notranslate"><span class="pre">config.py</span></code> add:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">RECORDS_UI_ENDPOINTS</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
    <span class="n">recid_previewer</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
        <span class="n">pid_type</span><span class="o">=</span><span class="s1">&#39;recid&#39;</span><span class="p">,</span>
        <span class="n">route</span><span class="o">=</span><span class="s1">&#39;/records/&lt;pid_value&gt;/preview/&lt;filename&gt;&#39;</span><span class="p">,</span>
        <span class="n">view_imp</span><span class="o">=</span><span class="s1">&#39;invenio_previewer.views:preview&#39;</span><span class="p">,</span>
        <span class="n">record_class</span><span class="o">=</span><span class="s1">&#39;invenio_records_files.api:Record&#39;</span><span class="p">,</span>
    <span class="p">),</span>
<span class="p">)</span>
</pre></div>
</div>
<p>You see the list of available previewer and learn how
to create your own previewer by reading the documentation of
<a class="reference external" href="https://invenio-previewer.readthedocs.io/en/latest/">Invenio-Previewer</a>.</p>
</div>
<div class="section" id="handling-images-using-iiif">
<span id="handling-files-iiif"></span><h2>Handling images using IIIF<a class="headerlink" href="#handling-images-using-iiif" title="Permalink to this headline">¶</a></h2>
<p>Invenio implements the <a class="reference external" href="https://iiif.io/">IIIF Image APIs</a>, a de facto
standard for delivering images on the web. It allows you to
generate thumbnails, resize, zoom and preview images.</p>
<p>For example, you can resize on the fly images uploaded by the user to a
dimension that best suites your website layout. This is very useful,
for example, when displaying thumbnails in the list of search results.</p>
<p>Let’s say that you want to resize the large image <code class="docutils literal notranslate"><span class="pre">large.png</span></code>
uploaded by the user to <code class="docutils literal notranslate"><span class="pre">640x480</span></code> pixels.
You can use the available REST APIs and retrieve
the image as the following:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">#</span> IIIF Image specification:                 /region/size/rotation/quality.format
<span class="go">/api/iiif/&lt;bucket_id&gt;:&lt;version_id&gt;:large.png/full/640,480/0/default.png</span>
</pre></div>
</div>
<p>Let’s say that you now want to achieve the same when previewing
the image in your website, and not via REST APIs. You can take advantage
of the files preview and integrate IIIF with it.</p>
<p>Add the IIIF previewer <code class="docutils literal notranslate"><span class="pre">iiif_image</span></code> in your <code class="docutils literal notranslate"><span class="pre">config.py</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">PREVIEWER_PREFERENCE</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;iiif_image&#39;</span><span class="p">,</span>
    <span class="s1">&#39;pdfjs&#39;</span><span class="p">,</span>
    <span class="s1">&#39;zip&#39;</span><span class="p">,</span>
<span class="p">]</span>
</pre></div>
</div>
<p>and configure if to resize to your needs. In <code class="docutils literal notranslate"><span class="pre">config.py</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">IIIF_PREVIEWER_PARAMS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="s1">&#39;640,480&#39;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>To learn more about the IIIF integration, see the
<a class="reference external" href="https://invenio-iiif.readthedocs.io/en/latest/">Invenio-IIIF</a>
documentation.</p>
</div>
<div class="section" id="security">
<span id="handling-files-security"></span><h2>Security<a class="headerlink" href="#security" title="Permalink to this headline">¶</a></h2>
<p>When serving files, you will have to take into account any security
implication. Here you can find some recommendations to mitigate possible
vulnerabilities, such as Cross-Site Scripting (XSS):</p>
<ol class="arabic simple">
<li><p>If possible, serve user uploaded files from a separate domain
(not a subdomain).</p></li>
<li><p>By default, Invenio-Files-REST sets some response headers to prevent
the browser from rendering and executing HTML files. For files that
you consider safe and you need to have rendered, you can configure the
<a class="reference external" href="https://invenio-files-rest.readthedocs.io/en/latest/api.html#invenio_files_rest.helpers.MIMETYPE_WHITELIST">MIMETYPE_WHITELIST</a>.
See
<a class="reference external" href="https://invenio-files-rest.readthedocs.io/en/latest/api.html#invenio_files_rest.helpers.send_stream">send_stream</a>
for more information.</p></li>
<li><p>Prefer file download instead of allowing the browser to preview any file,
by adding the <code class="code docutils literal notranslate"><span class="pre">?download</span></code> URL query argument.</p></li>
</ol>
</div>
<div class="section" id="next-steps">
<h2>Next steps<a class="headerlink" href="#next-steps" title="Permalink to this headline">¶</a></h2>
<p>You can have detailed information by reading the documentation of each module:</p>
<ul class="simple">
<li><p><a class="reference external" href="http://invenio-files-rest.readthedocs.io/en/latest/">Invenio-Files-REST</a></p></li>
<li><p><a class="reference external" href="http://invenio-records-files.readthedocs.io/en/latest/">Invenio-Records-Files</a></p></li>
<li><p><a class="reference external" href="http://invenio-previewer.readthedocs.io/en/latest/">Invenio-Previewer</a></p></li>
<li><p><a class="reference external" href="http://invenio-iiif.readthedocs.io/en/latest/">Invenio-IIIF</a></p></li>
</ul>
</div>
</div>


          </div>
              <div class="related bottom">
                &nbsp;
  <nav id="rellinks">
    <ul>
        <li>
          &larr;
          <a href="managing-access.html" title="Previous document">Managing access to records</a>
        </li>
        <li>
          <a href="architecture-infrastructure.html" title="Next document">Infrastructure architecture</a>
          &rarr;
        </li>
    </ul>
  </nav>
              </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<p class="logo">
  <a href="../../index.html">
    <img class="logo" src="../../_static/logo-full.png" alt="Logo"/>
    
  </a>
</p>



<p class="blurb">Invenio Digital Library Framework.</p>








<h3>Navigation</h3>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../getting-started/index.html">Getting started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tutorials/bootcamp.html">Tutorials</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">Documentation</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../requirements.html">Requirements</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="index.html">Main concepts</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="repository-structure.html">Repository structure</a></li>
<li class="toctree-l3"><a class="reference internal" href="understanding-data-models.html">Understanding data models</a></li>
<li class="toctree-l3"><a class="reference internal" href="managing-access.html">Managing access to records</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">Integrating Files</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#overview">Overview</a><ul>
<li class="toctree-l5"><a class="reference internal" href="#object-storage">Object storage</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="#integration-with-records">Integration with records</a></li>
<li class="toctree-l4"><a class="reference internal" href="#using-rest-apis">Using REST APIs</a><ul>
<li class="toctree-l5"><a class="reference internal" href="#integration-details">Integration details</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="#setup-your-storage">Setup your storage</a><ul>
<li class="toctree-l5"><a class="reference internal" href="#custom-storage">Custom storage</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="#permissions">Permissions</a><ul>
<li class="toctree-l5"><a class="reference internal" href="#response-codes">Response codes</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="#large-files-upload">Large files upload</a></li>
<li class="toctree-l4"><a class="reference internal" href="#files-integrity-checks">Files integrity checks</a></li>
<li class="toctree-l4"><a class="reference internal" href="#previewing-files">Previewing files</a></li>
<li class="toctree-l4"><a class="reference internal" href="#handling-images-using-iiif">Handling images using IIIF</a></li>
<li class="toctree-l4"><a class="reference internal" href="#security">Security</a></li>
<li class="toctree-l4"><a class="reference internal" href="#next-steps">Next steps</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="architecture-infrastructure.html">Infrastructure architecture</a></li>
<li class="toctree-l3"><a class="reference internal" href="architecture-application.html">Application architecture</a></li>
<li class="toctree-l3"><a class="reference internal" href="securing-your-instance.html">Securing your instance</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../bundles/index.html">Module Reference</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../community/index.html">Community</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../releases/index.html">Releases</a></li>
</ul>


<hr />
<ul>
    
    <li class="toctree-l1"><a href="https://github.com/inveniosoftware/invenio">invenio@GitHub</a></li>
    
    <li class="toctree-l1"><a href="https://pypi.python.org/pypi/invenio/">invenio@PyPI</a></li>
    
</ul>
<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">Documentation</a><ul>
  <li><a href="index.html">Main concepts</a><ul>
      <li>Previous: <a href="managing-access.html" title="previous chapter">Managing access to records</a></li>
      <li>Next: <a href="architecture-infrastructure.html" title="next chapter">Infrastructure architecture</a></li>
  </ul></li>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2015-2020, CERN.
      
      |
      <a href="../../_sources/documentation/main-concepts/handling-files.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    
    <a href="https://github.com/inveniosoftware/invenio" class="github">
        <img style="position: absolute; top: 0; right: 0; border: 0;" src="https://s3.amazonaws.com/github/ribbons/forkme_right_darkblue_121621.png" alt="Fork me on GitHub"  class="github"/>
    </a>
    

    
  </body>
</html>